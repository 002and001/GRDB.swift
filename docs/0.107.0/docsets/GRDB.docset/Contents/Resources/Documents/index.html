<!DOCTYPE html>
<html lang="en">
  <head>
    <title>GRDB  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="GRDB  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">GRDB Docs</a> (89% documented)</p>
        <p class="header-right"><a href="https://github.com/groue/GRDB.swift"><img src="img/gh.png"/>View on GitHub</a></p>
        <p class="header-right"><a href="dash-feed://http%3A%2F%2Fgroue%2Egithub%2Eio%2FGRDB%2Eswift%2Fdocs%2F0%2E107%2E0%2Fdocsets%2FGRDB%2Exml"><img src="img/dash.png"/>Install in Dash</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">GRDB Reference</a>
        <img id="carat" src="img/carat.png" />
        GRDB  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/AnyCursor.html">AnyCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ColumnDefinition.html">ColumnDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database.html">Database</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/BusyMode.html">– BusyMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/CheckpointMode.html">– CheckpointMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/CollationName.html">– CollationName</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/ConflictResolution.html">– ConflictResolution</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/ColumnType.html">– ColumnType</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/ForeignKeyAction.html">– ForeignKeyAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/TransactionKind.html">– TransactionKind</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Database/TransactionCompletion.html">– TransactionCompletion</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DatabaseCollation.html">DatabaseCollation</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DatabaseCursor.html">DatabaseCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DatabaseFunction.html">DatabaseFunction</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DatabasePool.html">DatabasePool</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DatabaseQueue.html">DatabaseQueue</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/EnumeratedCursor.html">EnumeratedCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FTS3TableDefinition.html">FTS3TableDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FTS4ColumnDefinition.html">FTS4ColumnDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FTS4TableDefinition.html">FTS4TableDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FTS5ColumnDefinition.html">FTS5ColumnDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FTS5TableDefinition.html">FTS5TableDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FetchedRecordsController.html">FetchedRecordsController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FilterCursor.html">FilterCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FlattenCursor.html">FlattenCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IteratorCursor.html">IteratorCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MapCursor.html">MapCursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Record.html">Record</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Row.html">Row</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SelectStatement.html">SelectStatement</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SelectStatement/SelectionInfo.html">– SelectionInfo</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Statement.html">Statement</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TableAlteration.html">TableAlteration</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TableDefinition.html">TableDefinition</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/UpdateStatement.html">UpdateStatement</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/DatabaseEventKind.html">DatabaseEventKind</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/FetchedRecordChange.html">FetchedRecordChange</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/PersistenceError.html">PersistenceError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SQLCount.html">SQLCount</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/Array.html">Array</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Bool.html">Bool</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CGFloat.html">CGFloat</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/ClosedRange.html">ClosedRange</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Column.html">Column</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CountableClosedRange.html">CountableClosedRange</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CountableRange.html">CountableRange</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Data.html">Data</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Database.html">Database</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/DatabasePool.html">DatabasePool</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/DatabaseQueue.html">DatabaseQueue</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Double.html">Double</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Float.html">Float</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int.html">Int</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int32.html">Int32</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int64.html">Int64</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSData.html">NSData</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSDate.html">NSDate</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSNull.html">NSNull</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSNumber.html">NSNumber</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSString.html">NSString</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSURL.html">NSURL</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSUUID.html">NSUUID</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Optional.html">Optional</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/QueryInterfaceRequest.html">QueryInterfaceRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Range.html">Range</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/RawRepresentable.html">RawRepresentable</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/ReferenceConvertible.html">ReferenceConvertible</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Sequence.html">Sequence</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/String.html">String</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/TableMapping.html">TableMapping</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBop1nFPS_22SQLSpecificExpressible_PS_13SQLExpression_">!(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTGSqPS_14SQLExpressible__PS_22SQLSpecificExpressible__PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTGSqPS_14SQLExpressible__VS_21SQLCollatedExpression_PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTPS_22SQLSpecificExpressible_GSqPS_14SQLExpressible___PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTPS_22SQLSpecificExpressible_Sb_PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTSbPS_22SQLSpecificExpressible__PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2neFTVS_21SQLCollatedExpressionGSqPS_14SQLExpressible___PS_13SQLExpression_">!=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3neeFTGSqPS_14SQLExpressible__PS_22SQLSpecificExpressible__PS_13SQLExpression_">!==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3neeFTGSqPS_14SQLExpressible__VS_21SQLCollatedExpression_PS_13SQLExpression_">!==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3neeFTPS_22SQLSpecificExpressible_GSqPS_14SQLExpressible___PS_13SQLExpression_">!==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3neeFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">!==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3neeFTVS_21SQLCollatedExpressionGSqPS_14SQLExpressible___PS_13SQLExpression_">!==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2aaFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">&amp;&amp;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2aaFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">&amp;&amp;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2aaFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">&amp;&amp;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1mFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">*(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1mFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">*(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1mFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">*(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1pFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">+(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1pFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">+(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1pFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">+(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBop1sFPS_22SQLSpecificExpressible_PS_13SQLExpression_">-(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1sFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">-(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1sFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">-(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1sFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">-(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1dFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">/(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1dFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">/(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1dFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">/(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1lFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1lFTPS_14SQLExpressible_VS_21SQLCollatedExpression_PS_13SQLExpression_">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1lFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1lFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1lFTVS_21SQLCollatedExpressionPS_14SQLExpressible__PS_13SQLExpression_">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2leFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2leFTPS_14SQLExpressible_VS_21SQLCollatedExpression_PS_13SQLExpression_">&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2leFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2leFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2leFTVS_21SQLCollatedExpressionPS_14SQLExpressible__PS_13SQLExpression_">&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTGSqPS_14SQLExpressible__PS_22SQLSpecificExpressible__PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTGSqPS_14SQLExpressible__VS_21SQLCollatedExpression_PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTPS_22SQLSpecificExpressible_GSqPS_14SQLExpressible___PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTPS_22SQLSpecificExpressible_Sb_PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTSbPS_22SQLSpecificExpressible__PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2eeFTVS_21SQLCollatedExpressionGSqPS_14SQLExpressible___PS_13SQLExpression_">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3eeeFTGSqPS_14SQLExpressible__PS_22SQLSpecificExpressible__PS_13SQLExpression_">===(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3eeeFTGSqPS_14SQLExpressible__VS_21SQLCollatedExpression_PS_13SQLExpression_">===(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3eeeFTPS_22SQLSpecificExpressible_GSqPS_14SQLExpressible___PS_13SQLExpression_">===(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3eeeFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">===(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi3eeeFTVS_21SQLCollatedExpressionGSqPS_14SQLExpressible___PS_13SQLExpression_">===(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1gFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1gFTPS_14SQLExpressible_VS_21SQLCollatedExpression_PS_13SQLExpression_">&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1gFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1gFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi1gFTVS_21SQLCollatedExpressionPS_14SQLExpressible__PS_13SQLExpression_">&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2geFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2geFTPS_14SQLExpressible_VS_21SQLCollatedExpression_PS_13SQLExpression_">&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2geFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2geFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2geFTVS_21SQLCollatedExpressionPS_14SQLExpressible__PS_13SQLExpression_">&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2qqFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">??(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB3absFPS_22SQLSpecificExpressible_PS_13SQLExpression_">abs(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB7averageFPS_22SQLSpecificExpressible_PS_13SQLExpression_">average(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB5countFPS_13SQLSelectable_PS_13SQLExpression_">count(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB5countFT8distinctPS_22SQLSpecificExpressible__PS_13SQLExpression_">count(distinct:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB21databaseQuestionMarksFT5countSi_SS">databaseQuestionMarks(count:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB6lengthFPS_22SQLSpecificExpressible_PS_13SQLExpression_">length(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB3maxFPS_22SQLSpecificExpressible_PS_13SQLExpression_">max(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB3minFPS_22SQLSpecificExpressible_PS_13SQLExpression_">min(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDB3sumFPS_22SQLSpecificExpressible_PS_13SQLExpression_">sum(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2ooFTPS_14SQLExpressible_PS_22SQLSpecificExpressible__PS_13SQLExpression_">||(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2ooFTPS_22SQLSpecificExpressible_PS0___PS_13SQLExpression_">||(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4GRDBoi2ooFTPS_22SQLSpecificExpressible_PS_14SQLExpressible__PS_13SQLExpression_">||(_:_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/Cursor.html">Cursor</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/DatabaseReader.html">DatabaseReader</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/DatabaseValueConvertible.html">DatabaseValueConvertible</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/DatabaseWriter.html">DatabaseWriter</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/FTS5CustomTokenizer.html">FTS5CustomTokenizer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/FTS5Tokenizer.html">FTS5Tokenizer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/FTS5WrapperTokenizer.html">FTS5WrapperTokenizer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/LayoutedRowAdapter.html">LayoutedRowAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/MutablePersistable.html">MutablePersistable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Persistable.html">Persistable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Request.html">Request</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RowAdapter.html">RowAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RowConvertible.html">RowConvertible</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RowLayout.html">RowLayout</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLCollection.html">SQLCollection</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLExpressible.html">SQLExpressible</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLExpression.html">SQLExpression</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLOrderingTerm.html">SQLOrderingTerm</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLSelectQuery.html">SQLSelectQuery</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLSelectable.html">SQLSelectable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SQLSpecificExpressible.html">SQLSpecificExpressible</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/StatementColumnConvertible.html">StatementColumnConvertible</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/TableMapping.html">TableMapping</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/TransactionObserver.html">TransactionObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/TypedRequest.html">TypedRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/VirtualTableModule.html">VirtualTableModule</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols.html#/s:P4GRDB18_OptionalFetchable">_OptionalFetchable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/AnyRequest.html">AnyRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/AnyTypedRequest.html">AnyTypedRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Column.html">Column</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ColumnMapping.html">ColumnMapping</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Configuration.html">Configuration</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseCoder.html">DatabaseCoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseDateComponents.html">DatabaseDateComponents</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseDateComponents/Format.html">– Format</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseError.html">DatabaseError</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseEvent.html">DatabaseEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseEvent/Kind.html">– Kind</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseMigrator.html">DatabaseMigrator</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabasePreUpdateEvent.html">DatabasePreUpdateEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabasePreUpdateEvent/Kind.html">– Kind</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseValue.html">DatabaseValue</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DatabaseValue/Storage.html">– Storage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS3.html">FTS3</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS3Pattern.html">FTS3Pattern</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS3TokenizerDescriptor.html">FTS3TokenizerDescriptor</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS4.html">FTS4</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS5.html">FTS5</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS5Pattern.html">FTS5Pattern</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS5TokenFlags.html">FTS5TokenFlags</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS5Tokenization.html">FTS5Tokenization</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FTS5TokenizerDescriptor.html">FTS5TokenizerDescriptor</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FetchedRecordsSectionInfo.html">FetchedRecordsSectionInfo</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IndexInfo.html">IndexInfo</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/LayoutedColumnMapping.html">LayoutedColumnMapping</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PersistenceConflictPolicy.html">PersistenceConflictPolicy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PrimaryKeyInfo.html">PrimaryKeyInfo</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/QueryInterfaceRequest.html">QueryInterfaceRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RangeRowAdapter.html">RangeRowAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ResultCode.html">ResultCode</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RowIndex.html">RowIndex</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLBinaryOperator.html">SQLBinaryOperator</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLCollatedExpression.html">SQLCollatedExpression</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLExpressionBinary.html">SQLExpressionBinary</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLExpressionExists.html">SQLExpressionExists</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLExpressionFunction.html">SQLExpressionFunction</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLExpressionLiteral.html">SQLExpressionLiteral</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLExpressionUnary.html">SQLExpressionUnary</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLFunctionName.html">SQLFunctionName</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLRequest.html">SQLRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SQLUnaryOperator.html">SQLUnaryOperator</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ScopeAdapter.html">ScopeAdapter</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/StatementArguments.html">StatementArguments</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SuffixRowAdapter.html">SuffixRowAdapter</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Typealiases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4GRDB16SQLiteConnection">SQLiteConnection</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4GRDB15SQLiteStatement">SQLiteStatement</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4GRDB11SQLiteValue">SQLiteValue</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:4GRDB13TraceFunction">TraceFunction</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:E4GRDBSq8_Wrapped">_Wrapped</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Associated Types.html">Associated Types</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Associated Types.html#/s:P4GRDB12TypedRequest7Fetched">Fetched</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='grdb-swift-a-href-https-developer-apple-com-swift-img-src-https-img-shields-io-badge-swift-3-orange-svg-style-flat-alt-swift-a-a-href-https-developer-apple-com-swift-img-src-https-img-shields-io-cocoapods-p-grdb-swift-svg-alt-platforms-a-a-href-license-img-src-https-img-shields-io-github-license-groue-grdb-swift-svg-maxage-2592000-alt-license-a' class='heading'>GRDB.swift <a href="https://developer.apple.com/swift/"><img src="https://img.shields.io/badge/swift-3-orange.svg?style=flat" alt="Swift"></a> <a href="https://developer.apple.com/swift/"><img src="https://img.shields.io/cocoapods/p/GRDB.swift.svg" alt="Platforms"></a> <a href="/LICENSE"><img src="https://img.shields.io/github/license/groue/GRDB.swift.svg?maxAge=2592000" alt="License"></a></h1>
<h3 id='a-toolkit-for-sqlite-databases-with-a-focus-on-application-development' class='heading'>A toolkit for SQLite databases, with a focus on application development</h3>

<p><strong>Latest release</strong>: May 5, 2017 &bull; version 0.107.0 &bull; <a href="CHANGELOG.md">CHANGELOG</a></p>

<p><strong>Requirements</strong>: iOS 8.0+ / OSX 10.9+ / watchOS 2.0+ &bull; Xcode 8.1+ &bull; Swift 3</p>

<ul>
<li>Swift 2.2: use the <a href="https://github.com/groue/GRDB.swift/tree/v0.80.2">version 0.80.2</a></li>
<li>Swift 2.3: use the <a href="https://github.com/groue/GRDB.swift/tree/v0.81.2">version 0.81.2</a></li>
</ul>

<p>Follow <a href="http://twitter.com/groue">@groue</a> on Twitter for release announcements and usage tips.</p>
<h2 id='what-is-this' class='heading'>What is this?</h2>

<p>GRDB provides raw access to SQL and advanced SQLite features, because one sometimes enjoys a sharp tool. It has robust concurrency primitives, so that multi-threaded applications can efficiently use their databases. It grants your application models with persistence and fetching methods, so that you don&rsquo;t have to deal with SQL and raw database rows when you don&rsquo;t want to.</p>

<p>Compared to <a href="http://github.com/stephencelis/SQLite.swift">SQLite.swift</a> or <a href="http://github.com/ccgus/fmdb">FMDB</a>, GRDB can spare you a lot of glue code. Compared to <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/">Core Data</a> or <a href="http://realm.io">Realm</a>, it can simplify your multi-threaded applications.</p>

<p>It comes with <a href="#documentation">up-to-date documentation</a>, <a href="https://medium.com/@gwendal.roue">general articles</a>, <a href="#sample-code">sample code</a>, and a lot of interesting resolved issues that may answer your eventual <a href="https://github.com/groue/GRDB.swift/issues?utf8=%E2%9C%93&q=is%3Aissue%20label%3Aquestion">questions</a> and foster <a href="https://github.com/groue/GRDB.swift/issues?q=is%3Aissue+label%3A%22best+practices%22">best practices</a>.</p>

<hr>

<p align="center">
    <a href="#features">Features</a> &bull;
    <a href="#usage">Usage</a> &bull;
    <a href="#installation">Installation</a> &bull;
    <a href="#documentation">Documentation</a> &bull;
    <a href="#faq">FAQ</a>
</p>

<hr>
<h2 id='features' class='heading'>Features</h2>

<p>GRDB ships with a <strong><a href="#sqlite-api">low-level SQLite API</a></strong>, and high-level tools that help dealing with databases:</p>

<ul>
<li><strong><a href="#records">Records</a></strong>: fetching and persistence methods for your custom structs and class hierarchies</li>
<li><strong><a href="#the-query-interface">Query Interface</a></strong>: a swift way to avoid the SQL language</li>
<li><strong><a href="#database-pools">WAL Mode Support</a></strong>: that means extra performance for multi-threaded applications</li>
<li><strong><a href="#migrations">Migrations</a></strong>: transform your database as your application evolves</li>
<li><strong><a href="#database-changes-observation">Database Changes Observation</a></strong>: perform post-commit and post-rollback actions</li>
<li><strong><a href="#fetchedrecordscontroller">Fetched Records Controller</a></strong>: automated tracking of changes in a query results, and UITableView animations</li>
<li><strong><a href="#full-text-search">Full-Text Search</a></strong>: Perform efficient and customizable full-text searches.</li>
<li><strong><a href="#encryption">Encryption</a></strong> with SQLCipher</li>
<li><strong><a href="Documentation/CustomSQLiteBuilds.md">Support for custom SQLite builds</a></strong></li>
<li><strong><a href="http://github.com/RxSwiftCommunity/RxGRDB">Reactive extensions for RxSwift</a></strong></li>
</ul>

<p>More than a set of tools that leverage SQLite abilities, GRDB is also:</p>

<ul>
<li><strong>Safer</strong>: read the blog post <a href="https://medium.com/@gwendal.roue/four-different-ways-to-handle-sqlite-concurrency-db3bcc74d00e">Four different ways to handle SQLite concurrency</a></li>
<li><strong>Faster</strong>: see <a href="https://github.com/groue/GRDB.swift/wiki/Performance">Comparing the Performances of Swift SQLite libraries</a></li>
<li>Well <a href="#documentation">documented</a> &amp; tested</li>
</ul>

<p>For a general overview of how a protocol-oriented library impacts database accesses, have a look at <a href="https://medium.com/@gwendal.roue/how-to-build-an-ios-application-with-sqlite-and-grdb-swift-d023a06c29b3">How to build an iOS application with SQLite and GRDB.swift</a>.</p>
<h2 id='usage' class='heading'>Usage</h2>

<p>Open a <a href="#database-connections">connection</a> to the database:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">GRDB</span>

<span class="c1">// Simple database connection</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">)</span>

<span class="c1">// Enhanced multithreading based on SQLite's WAL mode</span>
<span class="k">let</span> <span class="nv">dbPool</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabasePool</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">)</span>
</code></pre>

<p><a href="#executing-updates">Execute SQL statements</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"CREATE TABLE pointOfInterests ("</span> <span class="o">+</span>
            <span class="s">"id INTEGER PRIMARY KEY, "</span> <span class="o">+</span>
            <span class="s">"title TEXT NOT NULL, "</span> <span class="o">+</span>
            <span class="s">"favorite BOOLEAN NOT NULL DEFAULT 0, "</span> <span class="o">+</span>
            <span class="s">"latitude DOUBLE NOT NULL, "</span> <span class="o">+</span>
            <span class="s">"longitude DOUBLE NOT NULL"</span> <span class="o">+</span>
        <span class="s">")"</span><span class="p">)</span>

    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"INSERT INTO pointOfInterests (title, favorite, latitude, longitude) "</span> <span class="o">+</span>
        <span class="s">"VALUES (?, ?, ?, ?)"</span><span class="p">,</span>
        <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Paris"</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mf">48.85341</span><span class="p">,</span> <span class="mf">2.3488</span><span class="p">])</span>

    <span class="k">let</span> <span class="nv">parisId</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">lastInsertedRowID</span>
<span class="p">}</span>
</code></pre>

<p><a href="#fetch-queries">Fetch database rows and values</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM pointOfInterests"</span><span class="p">)</span>
    <span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"title"</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">isFavorite</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"favorite"</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">coordinate</span> <span class="o">=</span> <span class="kt">CLLocationCoordinate2DMake</span><span class="p">(</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"latitude"</span><span class="p">),</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"longitude"</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">poiCount</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT COUNT(*) FROM pointOfInterests"</span><span class="p">)</span><span class="o">!</span> <span class="c1">// Int</span>
    <span class="k">let</span> <span class="nv">poiTitles</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT title FROM pointOfInterests"</span><span class="p">)</span> <span class="c1">// [String]</span>
<span class="p">}</span>

<span class="c1">// Extraction</span>
<span class="k">let</span> <span class="nv">poiCount</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT COUNT(*) FROM pointOfInterests"</span><span class="p">)</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>

<p>Insert and fetch <a href="#records">records</a>:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">PointOfInterest</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">isFavorite</span><span class="p">:</span> <span class="kt">Bool</span>
    <span class="k">var</span> <span class="nv">coordinate</span><span class="p">:</span> <span class="kt">CLLocationCoordinate2D</span>
<span class="p">}</span>

<span class="c1">// snip: turn PointOfInterest into a "record" by adopting the protocols that</span>
<span class="c1">// provide fetching and persistence methods.</span>

<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">var</span> <span class="nv">berlin</span> <span class="o">=</span> <span class="kt">PointOfInterest</span><span class="p">(</span>
        <span class="nv">id</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
        <span class="nv">title</span><span class="p">:</span> <span class="s">"Berlin"</span><span class="p">,</span>
        <span class="nv">isFavorite</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">coordinate</span><span class="p">:</span> <span class="kt">CLLocationCoordinate2DMake</span><span class="p">(</span><span class="mf">52.52437</span><span class="p">,</span> <span class="mf">13.41053</span><span class="p">))</span>

    <span class="k">try</span> <span class="n">berlin</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">berlin</span><span class="o">.</span><span class="n">id</span> <span class="c1">// some value</span>

    <span class="n">berlin</span><span class="o">.</span><span class="n">isFavorite</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">try</span> <span class="n">berlin</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1">// Fetch [PointOfInterest] from SQL</span>
    <span class="k">let</span> <span class="nv">pois</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM pointOfInterests"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Avoid SQL with the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"pointOfInterests"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"favorite"</span><span class="p">,</span> <span class="o">.</span><span class="n">boolean</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span><span class="o">.</span><span class="nf">defaults</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"longitude"</span><span class="p">,</span> <span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"latitude"</span><span class="p">,</span> <span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// PointOfInterest?</span>
    <span class="k">let</span> <span class="nv">paris</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1">// PointOfInterest?</span>
    <span class="k">let</span> <span class="nv">titleColumn</span> <span class="o">=</span> <span class="kt">Column</span><span class="p">(</span><span class="s">"title"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">berlin</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">titleColumn</span> <span class="o">==</span> <span class="s">"Berlin"</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1">// [PointOfInterest]</span>
    <span class="k">let</span> <span class="nv">favoriteColumn</span> <span class="o">=</span> <span class="kt">Column</span><span class="p">(</span><span class="s">"favorite"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">favoritePois</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span>
        <span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">favoriteColumn</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">titleColumn</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h1 id='documentation' class='heading'>Documentation</h1>

<p><strong>GRDB runs on top of SQLite</strong>: you should get familiar with the <a href="http://www.sqlite.org/faq.html">SQLite FAQ</a>. For general and detailed information, jump to the <a href="http://www.sqlite.org/docs.html">SQLite Documentation</a>.</p>

<p><strong>Reference</strong></p>

<ul>
<li><a href="http://groue.github.io/GRDB.swift/docs/0.107.0/index.html">GRDB Reference</a> (generated by <a href="https://github.com/realm/jazzy">Jazzy</a>)</li>
</ul>

<p><strong>Getting Started</strong></p>

<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#database-connections">Database Connections</a>: Connect to SQLite databases</li>
</ul>

<p><strong>SQLite and SQL</strong></p>

<ul>
<li><a href="#sqlite-api">SQLite API</a>: The low-level SQLite API &bull; <a href="#executing-updates">executing updates</a> &bull; <a href="#fetch-queries">fetch queries</a></li>
</ul>

<p><strong>Records and the Query Interface</strong></p>

<ul>
<li><a href="#records">Records</a>: Fetching and persistence methods for your custom structs and class hierarchies.</li>
<li><a href="#the-query-interface">Query Interface</a>: A swift way to generate SQL &bull; <a href="#database-schema">table creation</a> &bull; <a href="#requests">requests</a></li>
</ul>

<p><strong>Application Tools</strong></p>

<ul>
<li><a href="#migrations">Migrations</a>: Transform your database as your application evolves.</li>
<li><a href="#full-text-search">Full-Text Search</a>: Perform efficient and customizable full-text searches.</li>
<li><a href="#database-changes-observation">Database Changes Observation</a>: Perform post-commit and post-rollback actions.</li>
<li><a href="#fetchedrecordscontroller">FetchedRecordsController</a>: Automatic database changes tracking, plus UITableView animations.</li>
<li><a href="#encryption">Encryption</a>: Encrypt your database with SQLCipher.</li>
<li><a href="#backup">Backup</a>: Dump the content of a database to another.</li>
<li><a href="Documentation/ExtendingGRDB.md">GRDB Extension Guide</a>: When a feature is lacking, extend GRDB right from your application.</li>
</ul>

<p><strong>Good to Know</strong></p>

<ul>
<li><a href="#avoiding-sql-injection">Avoiding SQL Injection</a></li>
<li><a href="#error-handling">Error Handling</a></li>
<li><a href="#unicode">Unicode</a></li>
<li><a href="#memory-management">Memory Management</a></li>
<li><a href="#data-protection">Data Protection</a></li>
<li><a href="#concurrency">Concurrency</a></li>
<li><a href="#performance">Performance</a></li>
</ul>

<p><a href="#faq">FAQ</a></p>

<p><a href="#sample-code">Sample Code</a></p>
<h1 id='installation' class='heading'>Installation</h1>

<p><strong>The installation procedures below have GRDB use the version of SQLite that ships with the target operating system.</strong></p>

<p>See <a href="#encryption">Encryption</a> for the installation procedure of GRDB with SQLCipher.</p>

<p>See <a href="Documentation/CustomSQLiteBuilds.md">Custom SQLite builds</a> for the installation procedure of GRDB with a customized build of SQLite 3.18.0.</p>
<h2 id='cocoapods' class='heading'>CocoaPods</h2>

<p><a href="http://cocoapods.org/">CocoaPods</a> is a dependency manager for Xcode projects. To use GRDB.swift with CocoaPods (version 1.1 or higher), specify in your <code>Podfile</code>:</p>
<pre class="highlight ruby"><code><span class="n">use_frameworks!</span>
<span class="n">pod</span> <span class="s1">'GRDB.swift'</span>
</code></pre>
<h2 id='swift-package-manager' class='heading'>Swift Package Manager</h2>

<p>The <a href="https://swift.org/package-manager/">Swift Package Manager</a> automates the distribution of Swift code. To use GRDB.swift with SPM, add a dependency to your <code>Package.swift</code> file:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">package</span> <span class="o">=</span> <span class="kt">Package</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
        <span class="o">.</span><span class="kt">Package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/groue/GRDB.swift.git"</span><span class="p">,</span> <span class="nv">majorVersion</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre>

<p>Note that Linux is not currently supported.</p>
<h2 id='carthage' class='heading'>Carthage</h2>

<p>Carthage does not support the variety of frameworks built by GRDB (standard SQLite, custom SQLite, SQLCipher).</p>

<p>Any pull request that has the <code>make test_CarthageBuild</code> command successfully complete will be greatly appreciated, though. Bring your local Xcode guru!</p>
<h2 id='manually' class='heading'>Manually</h2>

<ol>
<li><p><a href="https://github.com/groue/GRDB.swift/releases/tag/0.107.0">Download</a> a copy of GRDB.swift, or clone its repository and make sure you use the latest tagged version with the <code>git checkout 0.107.0</code> command.</p></li>
<li><p>Embed the <code>GRDB.xcodeproj</code> project in your own project.</p></li>
<li><p>Add the <code>GRDBOSX</code>, <code>GRDBiOS</code>, or <code>GRDBWatchOS</code> target in the <strong>Target Dependencies</strong> section of the <strong>Build Phases</strong> tab of your application target (extension target for WatchOS).</p></li>
<li><p>Add the <code>GRDB.framework</code> from the targetted platform to the <strong>Embedded Binaries</strong> section of the <strong>General</strong>  tab of your application target (extension target for WatchOS).</p></li>
<li><p>(WatchOS only). Add <code>libsqlite3.tbd</code> to the <strong>Linked Frameworks and Libraries</strong> section of the <strong>General</strong> tab of your extension target.</p></li>
</ol>

<p>See <a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS">GRDBDemoiOS</a> for an example of such integration.</p>
<h1 id='database-connections' class='heading'>Database Connections</h1>

<p>GRDB provides two classes for accessing SQLite databases: <code>DatabaseQueue</code> and <code>DatabasePool</code>:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">GRDB</span>

<span class="c1">// Pick one:</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">dbPool</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabasePool</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">)</span>
</code></pre>

<p>The differences are:</p>

<ul>
<li>Database pools allow concurrent database accesses (this can improve the performance of multithreaded applications).</li>
<li>Unless read-only, database pools open your SQLite database in the <a href="https://www.sqlite.org/wal.html">WAL mode</a>.</li>
<li>Database queues support <a href="https://www.sqlite.org/inmemorydb.html">in-memory databases</a>.</li>
</ul>

<p><strong>If you are not sure, choose DatabaseQueue.</strong> You will always be able to switch to DatabasePool later.</p>

<ul>
<li><a href="#database-queues">Database Queues</a></li>
<li><a href="#database-pools">Database Pools</a></li>
</ul>
<h2 id='database-queues' class='heading'>Database Queues</h2>

<p><strong>Open a database queue</strong> with the path to a database file:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">GRDB</span>

<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">inMemoryDBQueue</span> <span class="o">=</span> <span class="kt">DatabaseQueue</span><span class="p">()</span>
</code></pre>

<p>SQLite creates the database file if it does not already exist. The connection is closed when the database queue gets deallocated.</p>

<p><strong>A database queue can be used from any thread.</strong> The <code>inDatabase</code> and <code>inTransaction</code> methods are synchronous, and block the current thread until your database statements are executed in a protected dispatch queue. They safely serialize the database accesses:</p>
<pre class="highlight swift"><code><span class="c1">// Execute database statements:</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"pointOfInterests"</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
    <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Wrap database statements in a transaction:</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">poi</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">poi</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
<span class="p">}</span>

<span class="c1">// Read values:</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">pois</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">poiCount</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Extract a value from the database:</span>
<span class="k">let</span> <span class="nv">poiCount</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><strong>A database queue needs your application to follow rules in order to deliver its safety guarantees.</strong> Please refer to the <a href="#concurrency">Concurrency</a> chapter.</p>

<p>See <a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS/Database.swift">DemoApps/GRDBDemoiOS/Database.swift</a> for a sample code that sets up a database queue on iOS.</p>
<h3 id='databasequeue-configuration' class='heading'>DatabaseQueue Configuration</h3>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">config</span> <span class="o">=</span> <span class="kt">Configuration</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">config</span><span class="o">.</span><span class="n">foreignKeysEnabled</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// Default is already true</span>
<span class="n">config</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>     <span class="c1">// Prints all SQL statements</span>

<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span>
    <span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">,</span>
    <span class="nv">configuration</span><span class="p">:</span> <span class="n">config</span><span class="p">)</span>
</code></pre>

<p>See <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/Configuration.html">Configuration</a> for more details.</p>
<h2 id='database-pools' class='heading'>Database Pools</h2>

<p><strong>A Database Pool allows concurrent database accesses.</strong></p>

<p>When more efficient than <a href="#database-queues">database queues</a>, database pools also require a good mastery of database transactions. Details follow. If you don&rsquo;t feel comfortable with transactions, use a <a href="#database-queues">database queue</a> instead.</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">GRDB</span>
<span class="k">let</span> <span class="nv">dbPool</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabasePool</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">)</span>
</code></pre>

<p>SQLite creates the database file if it does not already exist. The connection is closed when the database pool gets deallocated.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: unless read-only, a database pool opens your database in the SQLite <q>WAL mode</q>. The WAL mode does not fit all situations. Please have a look at <a href="https://www.sqlite.org/wal.html">https://www.sqlite.org/wal.html</a>.</p>
</blockquote>

<p><strong>A database pool can be used from any thread.</strong> The <code>read</code>, <code>write</code> and <code>writeInTransaction</code> methods are synchronous, and block the current thread until your database statements are executed in a protected dispatch queue. They safely isolate the database accesses:</p>
<pre class="highlight swift"><code><span class="c1">// Execute database statements:</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"pointOfInterests"</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
    <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Wrap database statements in a transaction:</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">writeInTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">poi</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">poi</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
<span class="p">}</span>

<span class="c1">// Read values:</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">pois</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">poiCount</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Extract a value from the database:</span>
<span class="k">let</span> <span class="nv">poiCount</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Database pools allow several threads to access the database at the same time:</p>

<ul>
<li><p>When you don&rsquo;t need to modify the database, prefer the <code>read</code> method, because several threads can perform reads in parallel.</p>

<p>The total number of concurrent reads is limited. When the maximum number has been reached, a read waits for another read to complete. That maximum number can be <a href="#databasepool-configuration">configured</a>.</p></li>
<li><p>Conversely, writes are serialized. They don&rsquo;t block reads, but GRDB guarantees <code>read</code> closures an immutable view of the last committed state of the database.</p>

<p>:point_up: To provide <code>read</code> closures an immutable view of the last executed writing block <em>as a whole</em>, use <code>writeInTransaction</code> instead of <code>write</code>.</p></li>
</ul>

<p><strong>A database pool needs your application to follow rules in order to deliver its safety guarantees.</strong> Please refer to the <a href="#concurrency">Concurrency</a> chapter.</p>

<p>See <a href="#advanced-databasepool">Advanced DatabasePool</a> for more DatabasePool hotness.</p>

<p>For a sample code that sets up a database pool on iOS, see <a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS/Database.swift">DemoApps/GRDBDemoiOS/Database.swift</a>, and replace DatabaseQueue with DatabasePool.</p>
<h3 id='databasepool-configuration' class='heading'>DatabasePool Configuration</h3>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">config</span> <span class="o">=</span> <span class="kt">Configuration</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">config</span><span class="o">.</span><span class="n">foreignKeysEnabled</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// Default is already true</span>
<span class="n">config</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>     <span class="c1">// Prints all SQL statements</span>
<span class="n">config</span><span class="o">.</span><span class="n">maximumReaderCount</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1">// The default is 5</span>

<span class="k">let</span> <span class="nv">dbPool</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabasePool</span><span class="p">(</span>
    <span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/database.sqlite"</span><span class="p">,</span>
    <span class="nv">configuration</span><span class="p">:</span> <span class="n">config</span><span class="p">)</span>
</code></pre>

<p>See <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/Configuration.html">Configuration</a> for more details.</p>

<p>Database pools are more memory-hungry than database queues. See <a href="#memory-management">Memory Management</a> for more information.</p>
<h1 id='sqlite-api' class='heading'>SQLite API</h1>

<p><strong>In this section of the documentation, we will talk SQL.</strong> Jump to the <a href="#the-query-interface">query interface</a> if SQL is not your cup of tea.</p>

<ul>
<li><a href="#executing-updates">Executing Updates</a></li>
<li><a href="#fetch-queries">Fetch Queries</a>

<ul>
<li><a href="#fetching-methods">Fetching Methods</a></li>
<li><a href="#row-queries">Row Queries</a></li>
<li><a href="#value-queries">Value Queries</a></li>
</ul></li>
<li><a href="#values">Values</a>

<ul>
<li><a href="#data-and-memory-savings">Data</a></li>
<li><a href="#date-and-datecomponents">Date and DateComponents</a></li>
<li><a href="#nsnumber-and-nsdecimalnumber">NSNumber and NSDecimalNumber</a></li>
<li><a href="#swift-enums">Swift enums</a></li>
</ul></li>
<li><a href="#transactions-and-savepoints">Transactions and Savepoints</a></li>
</ul>

<p>Advanced topics:</p>

<ul>
<li><a href="#custom-value-types">Custom Value Types</a></li>
<li><a href="#prepared-statements">Prepared Statements</a></li>
<li><a href="#custom-sql-functions">Custom SQL Functions</a></li>
<li><a href="#database-schema-introspection">Database Schema Introspection</a></li>
<li><a href="#row-adapters">Row Adapters</a></li>
<li><a href="#raw-sqlite-pointers">Raw SQLite Pointers</a></li>
</ul>
<h2 id='executing-updates' class='heading'>Executing Updates</h2>

<p>Once granted with a <a href="#database-connections">database connection</a>, the <code>execute</code> method executes the SQL statements that do not return any database row, such as <code>CREATE TABLE</code>, <code>INSERT</code>, <code>DELETE</code>, <code>ALTER</code>, etc.</p>

<p>For example:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"CREATE TABLE persons ("</span> <span class="o">+</span>
            <span class="s">"id INTEGER PRIMARY KEY,"</span> <span class="o">+</span>
            <span class="s">"name TEXT NOT NULL,"</span> <span class="o">+</span>
            <span class="s">"age INT"</span> <span class="o">+</span>
        <span class="s">")"</span><span class="p">)</span>

    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"INSERT INTO persons (name, age) VALUES (:name, :age)"</span><span class="p">,</span>
        <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Barbara"</span><span class="p">,</span> <span class="s">"age"</span><span class="p">:</span> <span class="mi">39</span><span class="p">])</span>

    <span class="c1">// Join multiple statements with a semicolon:</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"INSERT INTO persons (name, age) VALUES (?, ?); "</span> <span class="o">+</span>
        <span class="s">"INSERT INTO persons (name, age) VALUES (?, ?)"</span><span class="p">,</span>
        <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Arthur"</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="s">"Barbara"</span><span class="p">,</span> <span class="mi">39</span><span class="p">])</span>
<span class="p">}</span>
</code></pre>

<p>The <code>?</code> and colon-prefixed keys like <code>:name</code> in the SQL query are the <strong>statements arguments</strong>. You pass arguments with arrays or dictionaries, as in the example above. See <a href="#values">Values</a> for more information on supported arguments types (Bool, Int, String, Date, Swift enums, etc.).</p>

<p>Never ever embed values directly in your SQL strings, and always use arguments instead. See <a href="#avoiding-sql-injection">Avoiding SQL Injection</a> for more information.</p>

<p><strong>After an INSERT statement</strong>, you can get the row ID of the inserted row:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
    <span class="s">"INSERT INTO persons (name, age) VALUES (?, ?)"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Arthur"</span><span class="p">,</span> <span class="mi">36</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">personId</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">lastInsertedRowID</span>
</code></pre>

<p>Don&rsquo;t miss <a href="#records">Records</a>, that provide classic <strong>persistence methods</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Arthur"</span><span class="p">,</span> <span class="nv">age</span><span class="p">:</span> <span class="mi">36</span><span class="p">)</span>
<span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">personId</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span>
</code></pre>
<h2 id='fetch-queries' class='heading'>Fetch Queries</h2>

<p><a href="#database-connections">Database connections</a> let you fetch database rows, plain values, and custom models aka <q>records</q>.</p>

<p><strong>Rows</strong> are the raw results of SQL queries:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM wines WHERE id = ?"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">color</span><span class="p">:</span> <span class="kt">Color</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"color"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p><strong>Values</strong> are the Bool, Int, String, Date, Swift enums, etc. stored in row columns:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">urls</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">URL</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT url FROM wines"</span><span class="p">)</span>
    <span class="k">while</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="k">try</span> <span class="n">urls</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p><strong>Records</strong> are your application objects that can initialize themselves from rows:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">wines</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Wine</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM wines"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<ul>
<li><a href="#fetching-methods">Fetching Methods</a> and <a href="#cursors">Cursors</a></li>
<li><a href="#row-queries">Row Queries</a></li>
<li><a href="#value-queries">Value Queries</a></li>
<li><a href="#records">Records</a></li>
</ul>
<h3 id='fetching-methods' class='heading'>Fetching Methods</h3>

<p><strong>Throughout GRDB</strong>, you can always fetch <em>cursors</em>, <em>arrays</em>, or <em>single values</em> of any fetchable type (database <a href="#row-queries">row</a>, simple <a href="#value-queries">value</a>, or custom <a href="#records">record</a>):</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="k">Type</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Type&gt;</span>
<span class="k">try</span> <span class="k">Type</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="c1">// [Type]</span>
<span class="k">try</span> <span class="k">Type</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="c1">// Type?</span>
</code></pre>

<ul>
<li><p><code>fetchCursor</code> returns a <strong><a href="#cursors">cursor</a></strong> over fetched values:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Row&gt;</span>
</code></pre></li>
<li><p><code>fetchAll</code> returns an <strong>array</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">)</span> <span class="c1">// [Person]</span>
</code></pre></li>
<li><p><code>fetchOne</code> returns a <strong>single optional value</strong>, and consumes a single database row (if any).</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT COUNT(*) ..."</span><span class="p">)</span> <span class="c1">// Int?</span>
</code></pre></li>
</ul>
<h4 id='cursors' class='heading'>Cursors</h4>

<p><strong>Whenever you consume several rows from the database, you can fetch a Cursor, or an Array</strong>.</p>

<p>Arrays contain copies of database values and may be consumed on any thread. But they can take a lot of memory. Conversely, cursors iterate over database results in a lazy fashion, don&rsquo;t consume much memory, and are generally more efficient. But they must be consumed in a <a href="#database-connections">protected dispatch queue</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">)</span>    <span class="c1">// [Row]</span>
<span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Row&gt;</span>
</code></pre>

<p>A common way to iterate over the elements of a cursor is to use a <code>while</code> loop:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">)</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"url"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can also use the <code>forEach</code> method:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">row</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"url"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Don&rsquo;t modify the fetched results during a cursor iteration:</p>
<pre class="highlight swift"><code><span class="c1">// Undefined behavior</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"DELETE ..."</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Cursors come with default implementations for many operations similar to those defined by <a href="https://developer.apple.com/reference/swift/lazysequenceprotocol">lazy sequences of the Swift Standard Library</a>: <code>contains</code>, <code>enumerated</code>, <code>filter</code>, <code>first</code>, <code>flatMap</code>, <code>forEach</code>, <code>joined</code>, <code>map</code>, <code>reduce</code>:</p>
<pre class="highlight swift"><code><span class="c1">// Enumerate all Github links</span>
<span class="k">try</span> <span class="kt">URL</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT url FROM links"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="n">url</span> <span class="k">in</span> <span class="n">url</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s">"github.com"</span> <span class="p">}</span>
    <span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span>
    <span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>
</code></pre>
<h3 id='row-queries' class='heading'>Row Queries</h3>

<ul>
<li><a href="#fetching-rows">Fetching Rows</a></li>
<li><a href="#column-values">Column Values</a></li>
<li><a href="#databasevalue">DatabaseValue</a></li>
<li><a href="#rows-as-dictionaries">Rows as Dictionaries</a></li>
</ul>
<h4 id='fetching-rows' class='heading'>Fetching Rows</h4>

<p>Fetch <strong>cursors</strong> of rows, <strong>arrays</strong>, or <strong>single</strong> rows (see <a href="#fetching-methods">fetching methods</a>):</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Row&gt;</span>
    <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>    <span class="c1">// [Row]</span>
    <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>    <span class="c1">// Row?</span>

    <span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM wines"</span><span class="p">)</span>
    <span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">color</span><span class="p">:</span> <span class="kt">Color</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"color"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM persons"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Arguments are optional arrays or dictionaries that fill the positional <code>?</code> and colon-prefixed keys like <code>:name</code> in the query:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM persons WHERE name = ?"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Arthur"</span><span class="p">])</span>

<span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM persons WHERE name = :name"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Arthur"</span><span class="p">])</span>
</code></pre>

<p>See <a href="#values">Values</a> for more information on supported arguments types (Bool, Int, String, Date, Swift enums, etc.), and <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">StatementArguments</a> for a detailed documentation of SQLite arguments.</p>

<p>Unlike row arrays that contain copies of the database rows, row cursors are close to the SQLite metal, and require a little care:</p>

<blockquote>
<p>:point_up: <strong>Don&rsquo;t turn a row cursor into an array</strong>, with <code>Array(rowCursor)</code> for example: you would not get the distinct rows you expect. To get a row array, use <code>Row.fetchAll(...)</code>. Generally speaking, make sure you copy a row whenever you extract it from a cursor for later use: <code>row.copy()</code>.</p>
</blockquote>
<h4 id='column-values' class='heading'>Column Values</h4>

<p><strong>Read column values</strong> by index or column name:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1">// 0 is the leftmost column</span>
<span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>  <span class="c1">// Leftmost matching column - lookup is case-insensitive</span>
<span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"name"</span><span class="p">))</span> <span class="c1">// Using query interface's Column</span>
</code></pre>

<p>Make sure to ask for an optional when the value may be NULL:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>
</code></pre>

<p>The <code>value</code> function returns the type you ask for. See <a href="#values">Values</a> for more information on supported value types:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">bookCount</span><span class="p">:</span> <span class="kt">Int</span>     <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"bookCount"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bookCount64</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"bookCount"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">hasBooks</span><span class="p">:</span> <span class="kt">Bool</span>     <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"bookCount"</span><span class="p">)</span>  <span class="c1">// false when 0</span>

<span class="k">let</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span>     <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"date"</span><span class="p">)</span>       <span class="c1">// "2015-09-11 18:14:15.123"</span>
<span class="k">let</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span>         <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"date"</span><span class="p">)</span>       <span class="c1">// Date</span>
<span class="k">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"date"</span><span class="p">)</span> <span class="c1">// Depends on the type of the property.</span>
</code></pre>

<p>You can also use the <code>as</code> type casting operator:</p>
<pre class="highlight swift"><code><span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span><span class="p">?</span>
</code></pre>

<blockquote>
<p>:warning: <strong>Warning</strong>: avoid the <code>as!</code> and <code>as?</code> operators, because they misbehave in the context of type inference (see <a href="http://openradar.appspot.com/radar?id=4951414862249984">rdar://21676393</a>):</p>
<pre class="highlight swift"><code><span class="k">if</span> <span class="k">let</span> <span class="nv">int</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Int</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span> <span class="c1">// BAD - doesn't work</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">int</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span><span class="p">?</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span> <span class="c1">// GOOD</span>
</code></pre>
</blockquote>

<p>Generally speaking, you can extract the type you need, <em>provided it can be converted from the underlying SQLite value</em>:</p>

<ul>
<li><p><strong>Successful conversions include:</strong></p>

<ul>
<li>All numeric SQLite values to all numeric Swift types, and Bool (zero is the only false boolean).</li>
<li>Text SQLite values to Swift String.</li>
<li>Blob SQLite values to Foundation Data.</li>
</ul>

<p>See <a href="#values">Values</a> for more information on supported types (Bool, Int, String, Date, Swift enums, etc.)</p></li>
<li><p><strong>NULL returns nil.</strong></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT NULL"</span><span class="p">)</span><span class="o">!</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span><span class="p">?</span> <span class="c1">// nil</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>  <span class="c1">// fatal error: could not convert NULL to Int.</span>
</code></pre>

<p>There is one exception, though: the <a href="#databasevalue">DatabaseValue</a> type:</p>
<pre class="highlight swift"><code><span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">DatabaseValue</span> <span class="c1">// DatabaseValue.null</span>
</code></pre></li>
<li><p><strong>Missing columns return nil.</strong></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 'foo' AS foo"</span><span class="p">)</span><span class="o">!</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"missing"</span><span class="p">)</span> <span class="k">as</span> <span class="kt">String</span><span class="p">?</span> <span class="c1">// nil</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"missing"</span><span class="p">)</span> <span class="k">as</span> <span class="kt">String</span>  <span class="c1">// fatal error: no such column: missing</span>
</code></pre>

<p>You can explicitly check for a column presence with the <code>hasColumn</code> method.</p></li>
<li><p><strong>Invalid conversions throw a fatal error.</strong></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 'Mom’s birthday'"</span><span class="p">)</span><span class="o">!</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">String</span> <span class="c1">// "Mom’s birthday"</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Date</span><span class="p">?</span>  <span class="c1">// fatal error: could not convert "Mom’s birthday" to Date.</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Date</span>   <span class="c1">// fatal error: could not convert "Mom’s birthday" to Date.</span>
</code></pre>

<p>This fatal error can be avoided with the <a href="#custom-value-types">DatabaseValueConvertible.fromDatabaseValue()</a> method.</p></li>
<li><p><strong>SQLite has a weak type system, and provides <a href="https://www.sqlite.org/c3ref/column_blob.html">convenience conversions</a> that can turn Blob to String, String to Int, etc.</strong></p>

<p>GRDB will sometimes let those conversions go through:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT '20 small cigars'"</span><span class="p">)</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>   <span class="c1">// 20</span>
<span class="p">}</span>
</code></pre>

<p>Don&rsquo;t freak out: those conversions did not prevent SQLite from becoming the immensely successful database engine you want to use. And GRDB adds safety checks described just above. You can also prevent those convenience conversions altogether by using the <a href="#databasevalue">DatabaseValue</a> type.</p></li>
</ul>
<h4 id='databasevalue' class='heading'>DatabaseValue</h4>

<p><strong>DatabaseValue is an intermediate type between SQLite and your values, which gives information about the raw value stored in the database.</strong></p>

<p>You get DatabaseValue just like other value types:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>

<span class="c1">// Check for NULL:</span>
<span class="n">dbv</span><span class="o">.</span><span class="n">isNull</span> <span class="c1">// Bool</span>

<span class="c1">// All the five storage classes supported by SQLite:</span>
<span class="k">switch</span> <span class="n">dbv</span><span class="o">.</span><span class="n">storage</span> <span class="p">{</span>
<span class="k">case</span> <span class="o">.</span><span class="nv">null</span><span class="p">:</span>                 <span class="nf">print</span><span class="p">(</span><span class="s">"NULL"</span><span class="p">)</span>
<span class="k">case</span> <span class="o">.</span><span class="nf">int64</span><span class="p">(</span><span class="k">let</span> <span class="nv">int64</span><span class="p">):</span>     <span class="nf">print</span><span class="p">(</span><span class="s">"Int64: </span><span class="se">\(</span><span class="n">int64</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="k">case</span> <span class="o">.</span><span class="nf">double</span><span class="p">(</span><span class="k">let</span> <span class="nv">double</span><span class="p">):</span>   <span class="nf">print</span><span class="p">(</span><span class="s">"Double: </span><span class="se">\(</span><span class="n">double</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="k">case</span> <span class="o">.</span><span class="nf">string</span><span class="p">(</span><span class="k">let</span> <span class="nv">string</span><span class="p">):</span>   <span class="nf">print</span><span class="p">(</span><span class="s">"String: </span><span class="se">\(</span><span class="n">string</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="k">case</span> <span class="o">.</span><span class="nf">blob</span><span class="p">(</span><span class="k">let</span> <span class="nv">data</span><span class="p">):</span>       <span class="nf">print</span><span class="p">(</span><span class="s">"Data: </span><span class="se">\(</span><span class="n">data</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can extract regular <a href="#values">values</a> (Bool, Int, String, Date, Swift enums, etc.) from DatabaseValue with the <a href="#custom-value-types">DatabaseValueConvertible.fromDatabaseValue()</a> method:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"bookCount"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bookCount</span>   <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span>   <span class="c1">// Int?</span>
<span class="k">let</span> <span class="nv">bookCount64</span> <span class="o">=</span> <span class="kt">Int64</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span> <span class="c1">// Int64?</span>
<span class="k">let</span> <span class="nv">hasBooks</span>    <span class="o">=</span> <span class="kt">Bool</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span>  <span class="c1">// Bool?, false when 0</span>

<span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"date"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span>     <span class="c1">// "2015-09-11 18:14:15.123"</span>
<span class="k">let</span> <span class="nv">date</span>   <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span>       <span class="c1">// Date?</span>
</code></pre>

<p><code>fromDatabaseValue</code> returns nil for invalid conversions:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 'Mom’s birthday'"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span> <span class="c1">// "Mom’s birthday"</span>
<span class="k">let</span> <span class="nv">int</span>    <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span>    <span class="c1">// nil</span>
<span class="k">let</span> <span class="nv">date</span>   <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span>   <span class="c1">// nil</span>
</code></pre>

<p>This turns out useful when you process untrusted databases. Compare:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">?</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// fatal error: could not convert "Mom’s birthday" to Date.</span>
<span class="k">let</span> <span class="nv">date</span> <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">// nil</span>
</code></pre>
<h4 id='rows-as-dictionaries' class='heading'>Rows as Dictionaries</h4>

<p>Row adopts the standard <a href="https://developer.apple.com/reference/swift/collection">Collection</a> protocol, and can be seen as a dictionary of <a href="#databasevalue">DatabaseValue</a>:</p>
<pre class="highlight swift"><code><span class="c1">// All the (columnName, databaseValue) tuples, from left to right:</span>
<span class="k">for</span> <span class="p">(</span><span class="n">columnName</span><span class="p">,</span> <span class="n">databaseValue</span><span class="p">)</span> <span class="k">in</span> <span class="n">row</span> <span class="p">{</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre>

<p><strong>You can build rows from dictionaries</strong> (standard Swift dictionaries and NSDictionary). See <a href="#values">Values</a> for more information on supported types:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span> <span class="o">=</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">,</span> <span class="s">"date"</span><span class="p">:</span> <span class="kc">nil</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="kt">Row</span><span class="p">([</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">,</span> <span class="s">"date"</span><span class="p">:</span> <span class="kc">nil</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="kt">Row</span><span class="p">(</span><span class="cm">/* [AnyHashable: Any] */</span><span class="p">)</span> <span class="c1">// nil if invalid dictionary</span>
</code></pre>

<p>Yet rows are not real dictionaries: they are ordered, and may contain duplicate keys:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 1 AS foo, 2 AS foo"</span><span class="p">)</span><span class="o">!</span>
<span class="n">row</span><span class="o">.</span><span class="n">columnNames</span>         <span class="c1">// ["foo", "foo"]</span>
<span class="n">row</span><span class="o">.</span><span class="n">databaseValues</span>      <span class="c1">// [1, 2]</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">)</span> <span class="c1">// 1 (leftmost matching column)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">columnName</span><span class="p">,</span> <span class="n">databaseValue</span><span class="p">)</span> <span class="k">in</span> <span class="n">row</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span> <span class="c1">// ("foo", 1), ("foo", 2)</span>
</code></pre>
<h3 id='value-queries' class='heading'>Value Queries</h3>

<p>Instead of rows, you can directly fetch <strong><a href="#values">values</a></strong>. Like rows, fetch them as <strong>cursors</strong>, <strong>arrays</strong>, or <strong>single</strong> values (see <a href="#fetching-methods">fetching methods</a>). Values are extracted from the leftmost column of the SQL queries:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Int&gt;</span>
    <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>    <span class="c1">// [Int]</span>
    <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>    <span class="c1">// Int?</span>

    <span class="c1">// When database may contain NULL:</span>
    <span class="k">try</span> <span class="kt">Optional</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Int?&gt;</span>
    <span class="k">try</span> <span class="kt">Optional</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>    <span class="c1">// [Int?]</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">personCount</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT COUNT(*) FROM persons"</span><span class="p">)</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>

<p><code>fetchOne</code> returns an optional value which is nil in two cases: either the SELECT statement yielded no row, or one row with a NULL value.</p>

<p>There are many supported value types (Bool, Int, String, Date, Swift enums, etc.). See <a href="#values">Values</a> for more information:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT COUNT(*) FROM persons"</span><span class="p">)</span><span class="o">!</span> <span class="c1">// Int</span>
<span class="k">let</span> <span class="nv">urls</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">URL</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT url FROM links"</span><span class="p">)</span>          <span class="c1">// [URL]</span>
</code></pre>
<h2 id='values' class='heading'>Values</h2>

<p>GRDB ships with built-in support for the following value types:</p>

<ul>
<li><p><strong>Swift Standard Library</strong>: Bool, Double, Float, Int, Int32, Int64, String, <a href="#swift-enums">Swift enums</a>.</p></li>
<li><p><strong>Foundation</strong>: <a href="#data-and-memory-savings">Data</a>, <a href="#date-and-datecomponents">Date</a>, <a href="#date-and-datecomponents">DateComponents</a>, NSNull, <a href="#nsnumber-and-nsdecimalnumber">NSNumber</a>, NSString, URL, <a href="#uuid">UUID</a>.</p></li>
<li><p><strong>CoreGraphics</strong>: CGFloat.</p></li>
<li><p><strong><a href="#databasevalue">DatabaseValue</a></strong>, the type which gives information about the raw value stored in the database.</p></li>
<li><p><strong>Full-Text Patterns</strong>: <a href="#fts3pattern">FTS3Pattern</a> and <a href="#fts5pattern">FTS5Pattern</a>.</p></li>
<li><p>Generally speaking, all types that adopt the <a href="#custom-value-types">DatabaseValueConvertible</a> protocol.</p></li>
</ul>

<p>Values can be used as <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">statement arguments</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">let</span> <span class="nv">verified</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
    <span class="s">"INSERT INTO links (url, verified) VALUES (?, ?)"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">url</span><span class="p">,</span> <span class="n">verified</span><span class="p">])</span>
</code></pre>

<p>Values can be <a href="#column-values">extracted from rows</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM links"</span><span class="p">)</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"url"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">verified</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"verified"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Values can be <a href="#value-queries">directly fetched</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">urls</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">URL</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT url FROM links"</span><span class="p">)</span>  <span class="c1">// [URL]</span>
</code></pre>

<p>Use values in <a href="#records">Records</a>:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Link</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">var</span> <span class="nv">isVerified</span><span class="p">:</span> <span class="kt">Bool</span>

    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"url"</span><span class="p">)</span>
        <span class="n">isVerified</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"verified"</span><span class="p">)</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="n">row</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">"url"</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s">"verified"</span><span class="p">:</span> <span class="n">isVerified</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Use values in the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">let</span> <span class="nv">link</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Link</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">urlColumn</span> <span class="o">==</span> <span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>
<h3 id='data-and-memory-savings' class='heading'>Data (and Memory Savings)</h3>

<p><strong>Data</strong> suits the BLOB SQLite columns. It can be stored and fetched from the database just like other <a href="#values">values</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT data, ..."</span><span class="p">)</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"data"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>At each step of the request iteration, the <code>row.value</code> method creates <em>two copies</em> of the database bytes: one fetched by SQLite, and another, stored in the Swift Data value.</p>

<p><strong>You have the opportunity to save memory</strong> by not copying the data fetched by SQLite:</p>
<pre class="highlight swift"><code><span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">dataNoCopy</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"data"</span><span class="p">)</span> <span class="c1">// Data?</span>
<span class="p">}</span>
</code></pre>

<p>The non-copied data does not live longer than the iteration step: make sure that you do not use it past this point.</p>
<h3 id='date-and-datecomponents' class='heading'>Date and DateComponents</h3>

<p><a href="#date"><strong>Date</strong></a> and <a href="#datecomponents"><strong>DateComponents</strong></a> can be stored and fetched from the database.</p>

<p>Here is the support provided by GRDB for the various <a href="https://www.sqlite.org/lang_datefunc.html">date formats</a> supported by SQLite:</p>

<table><thead>
<tr>
<th style="text-align: left">SQLite format</th>
<th style="text-align: center">Date</th>
<th style="text-align: center">DateComponents</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">YYYY-MM-DD</td>
<td style="text-align: center">Read ¹</td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">YYYY-MM-DD HH:MM</td>
<td style="text-align: center">Read ¹</td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">YYYY-MM-DD HH:MM:SS</td>
<td style="text-align: center">Read ¹</td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">YYYY-MM-DD HH:MM:SS.SSS</td>
<td style="text-align: center">Read/Write ¹</td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">YYYY-MM-DD*<em>T</em>*HH:MM</td>
<td style="text-align: center">Read ¹</td>
<td style="text-align: center">Read</td>
</tr>
<tr>
<td style="text-align: left">YYYY-MM-DD*<em>T</em>*HH:MM:SS</td>
<td style="text-align: center">Read ¹</td>
<td style="text-align: center">Read</td>
</tr>
<tr>
<td style="text-align: left">YYYY-MM-DD*<em>T</em>*HH:MM:SS.SSS</td>
<td style="text-align: center">Read ¹</td>
<td style="text-align: center">Read</td>
</tr>
<tr>
<td style="text-align: left">HH:MM</td>
<td style="text-align: center"></td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">HH:MM:SS</td>
<td style="text-align: center"></td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">HH:MM:SS.SSS</td>
<td style="text-align: center"></td>
<td style="text-align: center">Read/Write</td>
</tr>
<tr>
<td style="text-align: left">Julian Day Number</td>
<td style="text-align: center">Read ²</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td style="text-align: left"><code>now</code></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
</tr>
</tbody></table>

<p>¹ Dates are stored and read in the UTC time zone. Missing components are assumed to be zero.</p>

<p>² See <a href="https://en.wikipedia.org/wiki/Julian_day">https://en.wikipedia.org/wiki/Julian_day</a></p>
<h4 id='date' class='heading'>Date</h4>

<p><strong>Date</strong> can be stored and fetched from the database just like other <a href="#values">values</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
    <span class="s">"INSERT INTO persons (creationDate, ...) VALUES (?, ...)"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="kt">Date</span><span class="p">(),</span> <span class="o">...</span><span class="p">])</span>

<span class="k">let</span> <span class="nv">creationDate</span><span class="p">:</span> <span class="kt">Date</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"creationDate"</span><span class="p">)</span>
</code></pre>

<p>Dates are stored using the format <q>YYYY-MM-DD HH:MM:SS.SSS</q> in the UTC time zone. It is precise to the millisecond.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: this format was chosen because it is the only format that is:</p>

<ul>
<li>Comparable (<code>ORDER BY date</code> works)</li>
<li>Comparable with the SQLite keyword CURRENT_TIMESTAMP (<code>WHERE date &gt; CURRENT_TIMESTAMP</code> works)</li>
<li>Able to feed <a href="https://www.sqlite.org/lang_datefunc.html">SQLite date &amp; time functions</a></li>
<li>Precise enough</li>
</ul>

<p>Yet this format may not fit your needs. For example, you may want to store dates as timestamps. In this case, store and load Doubles instead of Date, and perform the required conversions.</p>
</blockquote>
<h4 id='datecomponents' class='heading'>DateComponents</h4>

<p>DateComponents is indirectly supported, through the <strong>DatabaseDateComponents</strong> helper type.</p>

<p>DatabaseDateComponents reads date components from all <a href="https://www.sqlite.org/lang_datefunc.html">date formats supported by SQLite</a>, and stores them in the format of your choice, from HH:MM to YYYY-MM-DD HH:MM:SS.SSS.</p>

<p>DatabaseDateComponents can be stored and fetched from the database just like other <a href="#values">values</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">DateComponents</span><span class="p">()</span>
<span class="n">components</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="mi">1973</span>
<span class="n">components</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">components</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="mi">18</span>

<span class="c1">// Store "1973-09-18"</span>
<span class="k">let</span> <span class="nv">dbComponents</span> <span class="o">=</span> <span class="kt">DatabaseDateComponents</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="kt">YMD</span><span class="p">)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
    <span class="s">"INSERT INTO persons (birthDate, ...) VALUES (?, ...)"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">dbComponents</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

<span class="c1">// Read "1973-09-18"</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT birthDate ..."</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">dbComponents</span><span class="p">:</span> <span class="kt">DatabaseDateComponents</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"birthDate"</span><span class="p">)</span>
<span class="n">dbComponents</span><span class="o">.</span><span class="n">format</span>         <span class="c1">// .YMD (the actual format found in the database)</span>
<span class="n">dbComponents</span><span class="o">.</span><span class="n">dateComponents</span> <span class="c1">// DateComponents</span>
</code></pre>
<h3 id='nsnumber-and-nsdecimalnumber' class='heading'>NSNumber and NSDecimalNumber</h3>

<p><strong>NSNumber</strong> can be stored and fetched from the database just like other <a href="#values">values</a>. Floating point NSNumbers are stored as Double. Integer and boolean, as Int64. Integers that don&rsquo;t fit Int64 won&rsquo;t be stored: you&rsquo;ll get a fatal error instead. Be cautious when an NSNumber contains an UInt64, for example.</p>

<p>NSDecimalNumber deserves a longer discussion:</p>

<p><strong>SQLite has no support for decimal numbers.</strong> Given the table below, SQLite will actually store integers or doubles:</p>
<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">transfers</span> <span class="p">(</span>
    <span class="n">amount</span> <span class="n">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="c1">-- will store integer or double, actually</span>
<span class="p">)</span>
</code></pre>

<p>This means that computations will not be exact:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT INTO transfers (amount) VALUES (0.1)"</span><span class="p">)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT INTO transfers (amount) VALUES (0.2)"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sum</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">NSDecimalNumber</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT SUM(amount) FROM transfers"</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Yikes! 0.3000000000000000512</span>
<span class="nf">print</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span>
</code></pre>

<p>Don&rsquo;t blame SQLite or GRDB, and instead store your decimal numbers differently.</p>

<p>A classic technique is to store <em>integers</em> instead, since SQLite performs exact computations of integers. For example, don&rsquo;t store Euros, but store cents instead:</p>
<pre class="highlight swift"><code><span class="c1">// Store</span>
<span class="k">let</span> <span class="nv">amount</span> <span class="o">=</span> <span class="kt">NSDecimalNumber</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"0.1"</span><span class="p">)</span>                       <span class="c1">// 0.1</span>
<span class="k">let</span> <span class="nv">integerAmount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="nf">multiplying</span><span class="p">(</span><span class="nv">byPowerOf10</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int64Value</span> <span class="c1">// 100</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT INTO transfers (amount) VALUES (?)"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">integerAmount</span><span class="p">])</span>

<span class="c1">// Read</span>
<span class="k">let</span> <span class="nv">integerAmount</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Int64</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT SUM(amount) FROM transfers"</span><span class="p">)</span><span class="o">!</span>    <span class="c1">// 100</span>
<span class="k">let</span> <span class="nv">amount</span> <span class="o">=</span> <span class="kt">NSDecimalNumber</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">integerAmount</span><span class="p">)</span><span class="o">.</span><span class="nf">multiplying</span><span class="p">(</span><span class="nv">byPowerOf10</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1">// 0.1</span>
</code></pre>
<h3 id='uuid' class='heading'>UUID</h3>

<p><strong>UUID</strong> can be stored and fetched from the database just like other <a href="#values">values</a>. GRDB stores uuids as 16-bytes data blobs.</p>
<h3 id='swift-enums' class='heading'>Swift Enums</h3>

<p><strong>Swift enums</strong> and generally all types that adopt the <a href="https://developer.apple.com/library/tvos/documentation/Swift/Reference/Swift_RawRepresentable_Protocol/index.html">RawRepresentable</a> protocol can be stored and fetched from the database just like their raw <a href="#values">values</a>:</p>
<pre class="highlight swift"><code><span class="kd">enum</span> <span class="kt">Color</span> <span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">red</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">rose</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">Grape</span> <span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">chardonnay</span><span class="p">,</span> <span class="n">merlot</span><span class="p">,</span> <span class="n">riesling</span>
<span class="p">}</span>

<span class="c1">// Declare empty DatabaseValueConvertible adoption</span>
<span class="kd">extension</span> <span class="kt">Color</span> <span class="p">:</span> <span class="kt">DatabaseValueConvertible</span> <span class="p">{</span> <span class="p">}</span>
<span class="kd">extension</span> <span class="kt">Grape</span> <span class="p">:</span> <span class="kt">DatabaseValueConvertible</span> <span class="p">{</span> <span class="p">}</span>

<span class="c1">// Store</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
    <span class="s">"INSERT INTO wines (grape, color) VALUES (?, ?)"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="kt">Grape</span><span class="o">.</span><span class="n">merlot</span><span class="p">,</span> <span class="kt">Color</span><span class="o">.</span><span class="n">red</span><span class="p">])</span>

<span class="c1">// Read</span>
<span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM wines"</span><span class="p">)</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">grape</span><span class="p">:</span> <span class="kt">Grape</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"grape"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">color</span><span class="p">:</span> <span class="kt">Color</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"color"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><strong>When a database value does not match any enum case</strong>, you get a fatal error. This fatal error can be avoided with the <a href="#custom-value-types">DatabaseValueConvertible.fromDatabaseValue()</a> method:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 'syrah'"</span><span class="p">)</span><span class="o">!</span>

<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">String</span>  <span class="c1">// "syrah"</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Grape</span><span class="p">?</span>  <span class="c1">// fatal error: could not convert "syrah" to Grape.</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Grape</span>   <span class="c1">// fatal error: could not convert "syrah" to Grape.</span>
<span class="kt">Grape</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1">// nil</span>
</code></pre>
<h2 id='transactions-and-savepoints' class='heading'>Transactions and Savepoints</h2>

<p>The <code>DatabaseQueue.inTransaction()</code> and <code>DatabasePool.writeInTransaction()</code> methods open an SQLite transaction and run their closure argument in a protected dispatch queue. They block the current thread until your database statements are executed:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">wine</span> <span class="o">=</span> <span class="kt">Wine</span><span class="p">(</span><span class="nv">color</span><span class="p">:</span> <span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="s">"Pomerol"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">wine</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
<span class="p">}</span>
</code></pre>

<p>If an error is thrown within the transaction body, the transaction is rollbacked and the error is rethrown by the <code>inTransaction</code> method. If you return <code>.rollback</code> from your closure, the transaction is also rollbacked, but no error is thrown.</p>

<p>If you want to insert a transaction between other database statements, you can use the Database.inTransaction() function, or even raw SQL statements:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>  <span class="c1">// or dbPool.write { db in</span>
    <span class="o">...</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"BEGIN TRANSACTION"</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"COMMIT"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can ask a database if a transaction is currently opened:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">myCriticalMethod</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="nf">precondition</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">isInsideTransaction</span><span class="p">,</span> <span class="s">"This method requires a transaction"</span><span class="p">)</span>
    <span class="k">try</span> <span class="o">...</span>
<span class="p">}</span>
</code></pre>

<p>Yet, you have a better option than checking for transactions: critical sections of your application should use savepoints, described below:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">myCriticalMethod</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="n">inSavepoint</span> <span class="p">{</span>
        <span class="c1">// Here the database is guaranteed to be inside a transaction.</span>
        <span class="k">try</span> <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='savepoints' class='heading'>Savepoints</h3>

<p><strong>Statements grouped in a savepoint can be rollbacked without invalidating a whole transaction:</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="n">inSavepoint</span> <span class="p">{</span> 
        <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"DELETE ..."</span><span class="p">)</span>
        <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT ..."</span><span class="p">)</span> <span class="c1">// need to rollback the delete above if this fails</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
    <span class="p">}</span>

    <span class="c1">// Other savepoints, etc...</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
<span class="p">}</span>
</code></pre>

<p>If an error is thrown within the savepoint body, the savepoint is rollbacked and the error is rethrown by the <code>inSavepoint</code> method. If you return <code>.rollback</code> from your closure, the body is also rollbacked, but no error is thrown.</p>

<p><strong>Unlike transactions, savepoints can be nested.</strong> They implicitly open a transaction if no one was opened when the savepoint begins. As such, they behave just like nested transactions. Yet the database changes are only committed to disk when the outermost savepoint is committed:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="n">inSavepoint</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="n">inSavepoint</span> <span class="p">{</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
        <span class="p">}</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>  <span class="c1">// writes changes to disk</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>SQLite savepoints are more than nested transactions, though. For advanced savepoints uses, use <a href="https://www.sqlite.org/lang_savepoint.html">SQL queries</a>.</p>
<h3 id='transaction-kinds' class='heading'>Transaction Kinds</h3>

<p>SQLite supports <a href="https://www.sqlite.org/lang_transaction.html">three kinds of transactions</a>: deferred, immediate, and exclusive. GRDB defaults to immediate.</p>

<p>The transaction kind can be changed in the database configuration, or for each transaction:</p>
<pre class="highlight swift"><code><span class="c1">// A connection with default DEFERRED transactions:</span>
<span class="k">var</span> <span class="nv">config</span> <span class="o">=</span> <span class="kt">Configuration</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">defaultTransactionKind</span> <span class="o">=</span> <span class="o">.</span><span class="n">deferred</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"..."</span><span class="p">,</span> <span class="nv">configuration</span><span class="p">:</span> <span class="n">config</span><span class="p">)</span>

<span class="c1">// Opens a DEFERRED transaction:</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>

<span class="c1">// Opens an EXCLUSIVE transaction:</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">inTransaction</span><span class="p">(</span><span class="o">.</span><span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>
</code></pre>
<h2 id='custom-value-types' class='heading'>Custom Value Types</h2>

<p>Conversion to and from the database is based on the <code>DatabaseValueConvertible</code> protocol:</p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">DatabaseValueConvertible</span> <span class="p">{</span>
    <span class="c1">/// Returns a value that can be stored in the database.</span>
    <span class="k">var</span> <span class="nv">databaseValue</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="c1">/// Returns a value initialized from databaseValue, if possible.</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">_</span> <span class="nv">databaseValue</span><span class="p">:</span> <span class="kt">DatabaseValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span><span class="p">?</span>
<span class="p">}</span>
</code></pre>

<p>All types that adopt this protocol can be used like all other <a href="#values">values</a> (Bool, Int, String, Date, Swift enums, etc.)</p>

<p>The <code>databaseValue</code> property returns <a href="#databasevalue">DatabaseValue</a>, a type that wraps the five values supported by SQLite: NULL, Int64, Double, String and Data. Since DatabaseValue has no public initializer, use <code>DatabaseValue.null</code>, or another type that already adopts the protocol: <code>1.databaseValue</code>, <code>&quot;foo&quot;.databaseValue</code>, etc. Conversion to DatabaseValue <em>must not</em> fail.</p>

<p>The <code>fromDatabaseValue()</code> factory method returns an instance of your custom type if the databaseValue contains a suitable value. If the databaseValue does not contain a suitable value, such as <q>foo</q> for Date, <code>fromDatabaseValue</code> <em>must</em> return nil (GRDB will interpret this nil result as a conversion error, and react accordingly).</p>

<p>The <a href="Documentation/ExtendingGRDB.md">GRDB Extension Guide</a> contains sample code that has UIColor adopt DatabaseValueConvertible.</p>
<h2 id='prepared-statements' class='heading'>Prepared Statements</h2>

<p><strong>Prepared Statements</strong> let you prepare an SQL query and execute it later, several times if you need, with different arguments.</p>

<p>There are two kinds of prepared statements: <strong>select statements</strong>, and <strong>update statements</strong>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">updateSQL</span> <span class="o">=</span> <span class="s">"INSERT INTO persons (name, age) VALUES (:name, :age)"</span>
    <span class="k">let</span> <span class="nv">updateStatement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeUpdateStatement</span><span class="p">(</span><span class="n">updateSQL</span><span class="p">)</span>

    <span class="k">let</span> <span class="nv">selectSQL</span> <span class="o">=</span> <span class="s">"SELECT * FROM persons WHERE name = ?"</span>
    <span class="k">let</span> <span class="nv">selectStatement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeSelectStatement</span><span class="p">(</span><span class="n">selectSQL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The <code>?</code> and colon-prefixed keys like <code>:name</code> in the SQL query are the statement arguments. You set them with arrays or dictionaries (arguments are actually of type <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">StatementArguments</a>, which happens to adopt the ExpressibleByArrayLiteral and ExpressibleByDictionaryLiteral protocols).</p>
<pre class="highlight swift"><code><span class="n">updateStatement</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Arthur"</span><span class="p">,</span> <span class="s">"age"</span><span class="p">:</span> <span class="mi">41</span><span class="p">]</span>
<span class="n">selectStatement</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Arthur"</span><span class="p">]</span>
</code></pre>

<p>After arguments are set, you can execute the prepared statement:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">updateStatement</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
</code></pre>

<p>Select statements can be used wherever a raw SQL query string would fit (see <a href="#fetch-queries">fetch queries</a>):</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">selectStatement</span><span class="p">)</span>    <span class="c1">// DatabaseCursor&lt;Row&gt;</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">selectStatement</span><span class="p">)</span> <span class="c1">// [Person]</span>
<span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">selectStatement</span><span class="p">)</span>  <span class="c1">// Person?</span>
</code></pre>

<p>You can set the arguments at the moment of the statement execution:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">updateStatement</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Arthur"</span><span class="p">,</span> <span class="s">"age"</span><span class="p">:</span> <span class="mi">41</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">selectStatement</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Arthur"</span><span class="p">])</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: it is a programmer error to reuse a prepared statement that has failed: GRDB may crash if you do so.</p>
</blockquote>

<p>See <a href="#row-queries">row queries</a>, <a href="#value-queries">value queries</a>, and <a href="#records">Records</a> for more information.</p>
<h3 id='prepared-statements-cache' class='heading'>Prepared Statements Cache</h3>

<p>When the same query will be used several times in the lifetime of your application, you may feel a natural desire to cache prepared statements.</p>

<p><strong>Don&rsquo;t cache statements yourself.</strong></p>

<blockquote>
<p>:point_up: <strong>Note</strong>: This is because you don&rsquo;t have the necessary tools. Statements are tied to specific SQLite connections and dispatch queues which you don&rsquo;t manage yourself, especially when you use <a href="#database-pools">database pools</a>. A change in the database schema <a href="https://www.sqlite.org/compile.html#max_schema_retry">may, or may not</a> invalidate a statement. On systems earlier than iOS 8.2 and OSX 10.10 that don&rsquo;t have the <a href="https://www.sqlite.org/c3ref/close.html">sqlite3_close_v2 function</a>, SQLite connections won&rsquo;t close properly if statements have been kept alive.</p>
</blockquote>

<p>Instead, use the <code>cachedUpdateStatement</code> and <code>cachedSelectStatement</code> methods. GRDB does all the hard caching and <a href="#memory-management">memory management</a> stuff for you:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">updateStatement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">cachedUpdateStatement</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">selectStatement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">cachedSelectStatement</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</code></pre>

<p>Should a cached prepared statement throw an error, don&rsquo;t reuse it (it is a programmer error). Instead, reload it from the cache.</p>
<h2 id='custom-sql-functions' class='heading'>Custom SQL Functions</h2>

<p><strong>SQLite lets you define SQL functions.</strong></p>

<p>A custom SQL function extends SQLite. It can be used in raw SQL queries. And when SQLite needs to evaluate it, it calls your custom code.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">reverseString</span> <span class="o">=</span> <span class="kt">DatabaseFunction</span><span class="p">(</span><span class="s">"reverseString"</span><span class="p">,</span> <span class="nv">argumentCount</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">pure</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">values</span><span class="p">:</span> <span class="p">[</span><span class="kt">DatabaseValue</span><span class="p">])</span> <span class="k">in</span>
    <span class="c1">// Extract string value, if any...</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="c1">// ... and return reversed string:</span>
    <span class="k">return</span> <span class="kt">String</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">characters</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
<span class="p">}</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">function</span><span class="p">:</span> <span class="n">reverseString</span><span class="p">)</span>   <span class="c1">// Or dbPool.add(function: ...)</span>

<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// "oof"</span>
    <span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT reverseString('foo')"</span><span class="p">)</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>

<p>The <em>function</em> argument takes an array of <a href="#databasevalue">DatabaseValue</a>, and returns any valid <a href="#values">value</a> (Bool, Int, String, Date, Swift enums, etc.) The number of database values is guaranteed to be <em>argumentCount</em>.</p>

<p>SQLite has the opportunity to perform additional optimizations when functions are <q>pure</q>, which means that their result only depends on their arguments. So make sure to set the <em>pure</em> argument to true when possible.</p>

<p><strong>Functions can take a variable number of arguments:</strong></p>

<p>When you don&rsquo;t provide any explicit <em>argumentCount</em>, the function can take any number of arguments:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">averageOf</span> <span class="o">=</span> <span class="kt">DatabaseFunction</span><span class="p">(</span><span class="s">"averageOf"</span><span class="p">,</span> <span class="nv">pure</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">values</span><span class="p">:</span> <span class="p">[</span><span class="kt">DatabaseValue</span><span class="p">])</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">doubles</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="kt">Double</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">doubles</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="p">)</span> <span class="o">/</span> <span class="kt">Double</span><span class="p">(</span><span class="n">doubles</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">function</span><span class="p">:</span> <span class="n">averageOf</span><span class="p">)</span>

<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// 2.0</span>
    <span class="k">try</span> <span class="kt">Double</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT averageOf(1, 2, 3)"</span><span class="p">)</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>

<p><strong>Functions can throw:</strong></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">sqrt</span> <span class="o">=</span> <span class="kt">DatabaseFunction</span><span class="p">(</span><span class="s">"sqrt"</span><span class="p">,</span> <span class="nv">argumentCount</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">pure</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">values</span><span class="p">:</span> <span class="p">[</span><span class="kt">DatabaseValue</span><span class="p">])</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">double</span> <span class="o">=</span> <span class="kt">Double</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">guard</span> <span class="n">double</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">DatabaseError</span><span class="p">(</span><span class="nv">message</span><span class="p">:</span> <span class="s">"invalid negative number"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">double</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">function</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">)</span>

<span class="c1">// SQLite error 1 with statement `SELECT sqrt(-1)`: invalid negative number</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Double</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT sqrt(-1)"</span><span class="p">)</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>

<p><strong>Use custom functions in the <a href="#the-query-interface">query interface</a>:</strong></p>
<pre class="highlight swift"><code><span class="c1">// SELECT reverseString("name") FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">reverseString</span><span class="o">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">))</span>
</code></pre>

<p><strong>GRDB ships with built-in SQL functions that perform unicode-aware string transformations.</strong> See <a href="#unicode">Unicode</a>.</p>
<h2 id='database-schema-introspection' class='heading'>Database Schema Introspection</h2>

<p><strong>SQLite provides database schema introspection tools</strong>, such as the <a href="https://www.sqlite.org/faq.html#q7">sqlite_master</a> table, and the pragma <a href="https://www.sqlite.org/pragma.html#pragma_table_info">table_info</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// &lt;Row type:"table" name:"persons" tbl_name:"persons" rootpage:2</span>
<span class="c1">//      sql:"CREATE TABLE persons(id INTEGER PRIMARY KEY, name TEXT)"&gt;</span>
<span class="k">for</span> <span class="n">row</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT * FROM sqlite_master"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// &lt;Row cid:0 name:"id" type:"INTEGER" notnull:0 dflt_value:NULL pk:1&gt;</span>
<span class="c1">// &lt;Row cid:1 name:"name" type:"TEXT" notnull:0 dflt_value:NULL pk:0&gt;</span>
<span class="k">for</span> <span class="n">row</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"PRAGMA table_info('persons')"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>GRDB provides five high-level methods as well:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s">"persons"</span><span class="p">)</span>     <span class="c1">// Bool, true if the table exists</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">columnCount</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="c1">// Int, the number of columns in table</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">indexes</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span>     <span class="c1">// [IndexInfo], the indexes defined on the table</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">table</span><span class="p">(</span><span class="s">"persons"</span><span class="p">,</span> <span class="nv">hasUniqueKey</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">])</span> <span class="c1">// Bool, true if column(s) is a unique key</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">(</span><span class="s">"persons"</span><span class="p">)</span>      <span class="c1">// PrimaryKeyInfo?</span>
</code></pre>

<p>Primary key is nil when table has no primary key:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE TABLE items (name TEXT)</span>
<span class="k">let</span> <span class="nv">itemPk</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">(</span><span class="s">"items"</span><span class="p">)</span> <span class="c1">// nil</span>
</code></pre>

<p>Primary keys have one or several columns. Single-column primary keys may contain the auto-incremented <a href="https://www.sqlite.org/autoinc.html">row id</a>:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE TABLE persons (</span>
<span class="c1">//   id INTEGER PRIMARY KEY,</span>
<span class="c1">//   name TEXT</span>
<span class="c1">// )</span>
<span class="k">let</span> <span class="nv">personPk</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">(</span><span class="s">"persons"</span><span class="p">)</span><span class="o">!</span>
<span class="n">personPk</span><span class="o">.</span><span class="n">columns</span>     <span class="c1">// ["id"]</span>
<span class="n">personPk</span><span class="o">.</span><span class="n">rowIDColumn</span> <span class="c1">// "id"</span>

<span class="c1">// CREATE TABLE countries (</span>
<span class="c1">//   isoCode TEXT NOT NULL PRIMARY KEY</span>
<span class="c1">//   name TEXT</span>
<span class="c1">// )</span>
<span class="k">let</span> <span class="nv">countryPk</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">(</span><span class="s">"countries"</span><span class="p">)</span><span class="o">!</span>
<span class="n">countryPk</span><span class="o">.</span><span class="n">columns</span>     <span class="c1">// ["isoCode"]</span>
<span class="n">countryPk</span><span class="o">.</span><span class="n">rowIDColumn</span> <span class="c1">// nil</span>

<span class="c1">// CREATE TABLE citizenships (</span>
<span class="c1">//   personID INTEGER NOT NULL REFERENCES persons(id)</span>
<span class="c1">//   countryIsoCode TEXT NOT NULL REFERENCES countries(isoCode)</span>
<span class="c1">//   PRIMARY KEY (personID, countryIsoCode)</span>
<span class="c1">// )</span>
<span class="k">let</span> <span class="nv">citizenshipsPk</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">(</span><span class="s">"citizenships"</span><span class="p">)</span><span class="o">!</span>
<span class="n">citizenshipsPk</span><span class="o">.</span><span class="n">columns</span>     <span class="c1">// ["personID", "countryIsoCode"]</span>
<span class="n">citizenshipsPk</span><span class="o">.</span><span class="n">rowIDColumn</span> <span class="c1">// nil</span>
</code></pre>
<h2 id='row-adapters' class='heading'>Row Adapters</h2>

<p><strong>Row adapters let you present database rows in the way expected by the row consumers.</strong></p>

<p>They basically help two incompatible row interfaces to work together. For example, a row consumer expects a column named <q>consumed</q>, but the produced row has a column named <q>produced</q>.</p>

<p>In this case, the <code>ColumnMapping</code> row adapter comes in handy:</p>
<pre class="highlight swift"><code><span class="c1">// Fetch a 'produced' column, and consume a 'consumed' column:</span>
<span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">ColumnMapping</span><span class="p">([</span><span class="s">"consumed"</span><span class="p">:</span> <span class="s">"produced"</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 'Hello' AS produced"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"consumed"</span><span class="p">)</span> <span class="c1">// "Hello"</span>
<span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"produced"</span><span class="p">)</span> <span class="c1">// nil</span>
</code></pre>

<p>Row adapters are values that adopt the <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Protocols/RowAdapter.html">RowAdapter</a> protocol. You can implement your own custom adapters, or use one of the four built-in adapters:</p>
<h3 id='columnmapping' class='heading'>ColumnMapping</h3>

<p>ColumnMapping renames columns. Build one with a dictionary whose keys are adapted column names, and values the column names in the raw row:</p>
<pre class="highlight swift"><code><span class="c1">// &lt;Row newName:"Hello"&gt;</span>
<span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">ColumnMapping</span><span class="p">([</span><span class="s">"newName"</span><span class="p">:</span> <span class="s">"oldName"</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 'Hello' AS oldName"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h3 id='suffixrowadapter' class='heading'>SuffixRowAdapter</h3>

<p><code>SuffixRowAdapter</code> hides the first columns in a row:</p>
<pre class="highlight swift"><code><span class="c1">// &lt;Row b:1 c:2&gt;</span>
<span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">SuffixRowAdapter</span><span class="p">(</span><span class="nv">fromIndex</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 0 AS a, 1 AS b, 2 AS c"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h3 id='rangerowadapter' class='heading'>RangeRowAdapter</h3>

<p><code>RangeRowAdapter</code> only exposes a range of columns.</p>
<pre class="highlight swift"><code><span class="c1">// &lt;Row b:1&gt;</span>
<span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">1</span><span class="o">..&lt;</span><span class="mi">2</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 0 AS a, 1 AS b, 2 AS c"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h3 id='scopeadapter' class='heading'>ScopeAdapter</h3>

<p><code>ScopeAdapter</code> defines <em>row scopes</em>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">ScopeAdapter</span><span class="p">([</span>
    <span class="s">"left"</span><span class="p">:</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">0</span><span class="o">..&lt;</span><span class="mi">2</span><span class="p">),</span>
    <span class="s">"right"</span><span class="p">:</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">2</span><span class="o">..&lt;</span><span class="mi">4</span><span class="p">)])</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 0 AS a, 1 AS b, 2 AS c, 3 AS d"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>
</code></pre>

<p>ScopeAdapter does not change the columns and values of the fetched row. Instead, it defines <em>scopes</em>, which you access with the <code>scoped(on:)</code> method. It returns an optional Row, which is nil if the scope is missing.</p>
<pre class="highlight swift"><code><span class="n">row</span>                       <span class="c1">// &lt;Row a:0 b:1 c:2 d:3&gt;</span>
<span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"left"</span><span class="p">)</span>    <span class="c1">// &lt;Row a:0 b:1&gt;</span>
<span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"right"</span><span class="p">)</span>   <span class="c1">// &lt;Row c:2 d:3&gt;</span>
<span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"missing"</span><span class="p">)</span> <span class="c1">// nil</span>
</code></pre>

<p>Scopes can be nested:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">ScopeAdapter</span><span class="p">([</span>
    <span class="s">"left"</span><span class="p">:</span> <span class="kt">ScopeAdapter</span><span class="p">([</span>
        <span class="s">"left"</span><span class="p">:</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">0</span><span class="o">..&lt;</span><span class="mi">1</span><span class="p">),</span>
        <span class="s">"right"</span><span class="p">:</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">1</span><span class="o">..&lt;</span><span class="mi">2</span><span class="p">)]),</span>
    <span class="s">"right"</span><span class="p">:</span> <span class="kt">ScopeAdapter</span><span class="p">([</span>
        <span class="s">"left"</span><span class="p">:</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">2</span><span class="o">..&lt;</span><span class="mi">3</span><span class="p">),</span>
        <span class="s">"right"</span><span class="p">:</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">3</span><span class="o">..&lt;</span><span class="mi">4</span><span class="p">)])</span>
    <span class="p">])</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 0 AS a, 1 AS b, 2 AS c, 3 AS d"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>

<span class="k">let</span> <span class="nv">leftRow</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"left"</span><span class="p">)</span><span class="o">!</span>
<span class="n">leftRow</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"left"</span><span class="p">)</span>  <span class="c1">// &lt;Row a:0&gt;</span>
<span class="n">leftRow</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"right"</span><span class="p">)</span> <span class="c1">// &lt;Row b:1&gt;</span>

<span class="k">let</span> <span class="nv">rightRow</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"right"</span><span class="p">)</span><span class="o">!</span>
<span class="n">rightRow</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"left"</span><span class="p">)</span>  <span class="c1">// &lt;Row c:2&gt;</span>
<span class="n">rightRow</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"right"</span><span class="p">)</span> <span class="c1">// &lt;Row d:3&gt;</span>
</code></pre>

<p>Any adapter can be extended with scopes:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">adapter</span> <span class="o">=</span> <span class="kt">RangeRowAdapter</span><span class="p">(</span><span class="mi">0</span><span class="o">..&lt;</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">addingScopes</span><span class="p">([</span><span class="s">"remainder"</span><span class="p">:</span> <span class="kt">SuffixRowAdapter</span><span class="p">(</span><span class="nv">fromIndex</span><span class="p">:</span> <span class="mi">2</span><span class="p">)])</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT 0 AS a, 1 AS b, 2 AS c, 3 AS d"</span><span class="p">,</span> <span class="nv">adapter</span><span class="p">:</span> <span class="n">adapter</span><span class="p">)</span><span class="o">!</span>

<span class="n">row</span> <span class="c1">// &lt;Row a:0 b:1&gt;</span>
<span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"remainder"</span><span class="p">)</span> <span class="c1">// &lt;Row c:2 d:3&gt;</span>
</code></pre>
<h2 id='raw-sqlite-pointers' class='heading'>Raw SQLite Pointers</h2>

<p><strong>If not all SQLite APIs are exposed in GRDB, you can still use the <a href="https://www.sqlite.org/c3ref/intro.html">SQLite C Interface</a> and call <a href="https://www.sqlite.org/c3ref/funclist.html">SQLite C functions</a>.</strong></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">sqliteVersion</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">cString</span><span class="p">:</span> <span class="nf">sqlite3_libversion</span><span class="p">())</span>
</code></pre>

<p>Those functions are embedded right into the GRDB framework, unless you use GRDB through the Swift Package Manager. In this case, you need to import the <code>CSQLite</code> module:</p>
<pre class="highlight swift"><code><span class="c1">// When you use the Swift Package Manager</span>
<span class="kd">import</span> <span class="kt">CSQLite</span>

<span class="k">let</span> <span class="nv">sqliteVersion</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">cString</span><span class="p">:</span> <span class="nf">sqlite3_libversion</span><span class="p">())</span>
</code></pre>

<p>Raw pointers to database connections and statements are available through the <code>Database.sqliteConnection</code> and <code>Statement.sqliteStatement</code> properties:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// The raw pointer to a database connection:</span>
    <span class="k">let</span> <span class="nv">sqliteConnection</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sqliteConnection</span>

    <span class="c1">// The raw pointer to a statement:</span>
    <span class="k">let</span> <span class="nv">statement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeSelectStatement</span><span class="p">(</span><span class="s">"SELECT ..."</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">sqliteStatement</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">sqliteStatement</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Notes</strong></p>

<ul>
<li>Those pointers are owned by GRDB: don&rsquo;t close connections or finalize statements created by GRDB.</li>
<li>GRDB opens SQLite connections in the <q>[multi-thread mode](https://www.sqlite.org/threadsafe.html)</q>, which (oddly) means that <strong>they are not thread-safe</strong>. Make sure you touch raw databases and statements inside their dedicated dispatch queues.</li>
<li>Use the raw SQLite C Interface at your own risk. GRDB won&rsquo;t prevent you from shooting yourself in the foot.</li>
</ul>
</blockquote>

<p>Before jumping in the low-level wagon, here is the list of all SQLite APIs used by GRDB:</p>

<ul>
<li><code>sqlite3_backup_finish</code>, <code>sqlite3_backup_init</code>, <code>sqlite3_backup_step</code>: see <a href="#backup">Backup</a></li>
<li><code>sqlite3_bind_blob</code>, <code>sqlite3_bind_double</code>, <code>sqlite3_bind_int64</code>, <code>sqlite3_bind_null</code>, <code>sqlite3_bind_parameter_count</code>, <code>sqlite3_bind_parameter_name</code>, <code>sqlite3_bind_text</code>, <code>sqlite3_clear_bindings</code>, <code>sqlite3_column_blob</code>, <code>sqlite3_column_bytes</code>, <code>sqlite3_column_count</code>, <code>sqlite3_column_double</code>, <code>sqlite3_column_int64</code>, <code>sqlite3_column_name</code>, <code>sqlite3_column_text</code>, <code>sqlite3_column_type</code>, <code>sqlite3_exec</code>, <code>sqlite3_finalize</code>, <code>sqlite3_prepare_v2</code>, <code>sqlite3_reset</code>, <code>sqlite3_step</code>: see <a href="#executing-updates">Executing Updates</a>, <a href="#fetch-queries">Fetch Queries</a>, <a href="#prepared-statements">Prepared Statements</a>, <a href="#values">Values</a></li>
<li><code>sqlite3_busy_handler</code>, <code>sqlite3_busy_timeout</code>: see <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/Configuration.html">Configuration.busyMode</a></li>
<li><code>sqlite3_changes</code>, <code>sqlite3_total_changes</code>: see <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Classes/Database.html">Database.changesCount and Database.totalChangesCount</a></li>
<li><code>sqlite3_close</code>, <code>sqlite3_close_v2</code>, <code>sqlite3_next_stmt</code>, <code>sqlite3_open_v2</code>: see <a href="#database-connections">Database Connections</a></li>
<li><code>sqlite3_commit_hook</code>, <code>sqlite3_rollback_hook</code>, <code>sqlite3_update_hook</code>: see <a href="#database-changes-observation">Database Changes Observation</a>, <a href="#fetchedrecordscontroller">FetchedRecordsController</a></li>
<li><code>sqlite3_config</code>: see <a href="#error-log">Error Log</a></li>
<li><code>sqlite3_create_collation_v2</code>: see <a href="#string-comparison">String Comparison</a></li>
<li><code>sqlite3_create_function_v2</code>, <code>sqlite3_result_blob</code>, <code>sqlite3_result_double</code>, <code>sqlite3_result_error</code>, <code>sqlite3_result_error_code</code>, <code>sqlite3_result_int64</code>, <code>sqlite3_result_null</code>, <code>sqlite3_result_text</code>, <code>sqlite3_user_data</code>, <code>sqlite3_value_blob</code>, <code>sqlite3_value_bytes</code>, <code>sqlite3_value_double</code>, <code>sqlite3_value_int64</code>, <code>sqlite3_value_text</code>, <code>sqlite3_value_type</code>: see <a href="#custom-sql-functions">Custom SQL Functions</a></li>
<li><code>sqlite3_db_release_memory</code>: see <a href="#memory-management">Memory Management</a></li>
<li><code>sqlite3_errcode</code>, <code>sqlite3_errmsg</code>, <code>sqlite3_errstr</code>, <code>sqlite3_extended_result_codes</code>: see <a href="#error-handling">Error Handling</a></li>
<li><code>sqlite3_key</code>, <code>sqlite3_rekey</code>: see <a href="#encryption">Encryption</a></li>
<li><code>sqlite3_last_insert_rowid</code>: see <a href="#executing-updates">Executing Updates</a></li>
<li><code>sqlite3_preupdate_count</code>, <code>sqlite3_preupdate_depth</code>, <code>sqlite3_preupdate_hook</code>, <code>sqlite3_preupdate_new</code>, <code>sqlite3_preupdate_old</code>: see <a href="#support-for-sqlite-pre-update-hooks">Support for SQLite Pre-Update Hooks</a></li>
<li><code>sqlite3_set_authorizer</code>: <strong>reserved by GRDB</strong></li>
<li><code>sqlite3_sql</code>: see <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Classes/Statement.html">Statement.sql</a></li>
<li><code>sqlite3_trace</code>: see <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/Configuration.html">Configuration.trace</a></li>
<li><code>sqlite3_wal_checkpoint_v2</code>: see <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Classes/DatabasePool.html">DatabasePool.checkpoint</a></li>
</ul>
<h1 id='records' class='heading'>Records</h1>

<p><strong>On top of the <a href="#sqlite-api">SQLite API</a>, GRDB provides protocols and a class</strong> that help manipulating database rows as regular objects named <q>records</q>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">poi</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">poi</span><span class="o">.</span><span class="n">isFavorite</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">try</span> <span class="n">poi</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Of course, you need to open a <a href="#database-connections">database connection</a>, and <a href="#database-schema">create a database table</a> first.</p>

<p>Your custom structs and classes can adopt each protocol individually, and opt in to focused sets of features. Or you can subclass the <code>Record</code> class, and get the full toolkit in one go: fetching methods, persistence methods, and changes tracking. See the <a href="#list-of-record-methods">list of record methods</a> for an overview.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: if you are familiar with Core Data&rsquo;s NSManagedObject or Realm&rsquo;s Object, you may experience a cultural shock: GRDB records are not uniqued, and do not auto-update. This is both a purpose, and a consequence of protocol-oriented programming. You should read <a href="https://medium.com/@gwendal.roue/how-to-build-an-ios-application-with-sqlite-and-grdb-swift-d023a06c29b3">How to build an iOS application with SQLite and GRDB.swift</a> for a general introduction.</p>
</blockquote>

<p><strong>Overview</strong></p>

<ul>
<li><a href="#inserting-records">Inserting Records</a></li>
<li><a href="#fetching-records">Fetching Records</a></li>
<li><a href="#updating-records">Updating Records</a></li>
<li><a href="#deleting-records">Deleting Records</a></li>
<li><a href="#counting-records">Counting Records</a></li>
</ul>

<p><strong>Protocols and the Record class</strong></p>

<ul>
<li><a href="#rowconvertible-protocol">RowConvertible Protocol</a></li>
<li><a href="#tablemapping-protocol">TableMapping Protocol</a></li>
<li><a href="#persistable-protocol">Persistable Protocol</a>

<ul>
<li><a href="#persistence-methods">Persistence Methods</a></li>
<li><a href="#customizing-the-persistence-methods">Customizing the Persistence Methods</a></li>
<li><a href="#conflict-resolution">Conflict Resolution</a></li>
</ul></li>
<li><a href="#record-class">Record Class</a>

<ul>
<li><a href="#changes-tracking">Changes Tracking</a></li>
</ul></li>
<li><a href="#the-implicit-rowid-primary-key">The Implicit RowID Primary Key</a></li>
<li><strong><a href="#list-of-record-methods">List of Record Methods</a></strong></li>
</ul>
<h3 id='inserting-records' class='heading'>Inserting Records</h3>

<p>To insert a record in the database, subclass the <a href="#record-class">Record</a> class or adopt the <a href="#persistable-protocol">Persistable</a> protocol, and call the <code>insert</code> method:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

<span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Arthur"</span><span class="p">,</span> <span class="nv">email</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">)</span>
<span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>
<h3 id='fetching-records' class='heading'>Fetching Records</h3>

<p><a href="#record-class">Record</a> subclasses and types that adopt the <a href="#rowconvertible-protocol">RowConvertible</a> protocol can be fetched from the database:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// [Person]</span>
</code></pre>

<p>Add the <a href="#tablemapping-protocol">TableMapping</a> protocol and you can stop writing SQL:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// [Person]</span>
<span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>                                       <span class="c1">// Person?</span>
<span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span>         <span class="c1">// Person?</span>
<span class="k">let</span> <span class="nv">countries</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span>                       <span class="c1">// [Country]</span>
</code></pre>

<p>See <a href="#fetching-methods">fetching methods</a>, and the <a href="#the-query-interface">query interface</a>.</p>
<h3 id='updating-records' class='heading'>Updating Records</h3>

<p><a href="#record-class">Record</a> subclasses and types that adopt the <a href="#persistable-protocol">Persistable</a> protocol can be updated in the database:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">!</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Arthur"</span>
<span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p><a href="#record-class">Record</a> subclasses track changes, so that you can avoid useless updates:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">!</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Arthur"</span>
<span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>For batch updates, execute an <a href="#executing-updates">SQL query</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE persons SET synchronized = 1"</span><span class="p">)</span>
</code></pre>
<h3 id='deleting-records' class='heading'>Deleting Records</h3>

<p><a href="#record-class">Record</a> subclasses and types that adopt the <a href="#persistable-protocol">Persistable</a> protocol can be deleted from the database:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">!</span>
<span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p>The <a href="#tablemapping-protocol">TableMapping</a> protocol gives you methods that delete according to primary key or any unique index:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span>
</code></pre>

<p>For batch deletes, see the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>
<h3 id='counting-records' class='heading'>Counting Records</h3>

<p><a href="#record-class">Record</a> subclasses and types that adopt the <a href="#tablemapping-protocol">TableMapping</a> protocol can be counted:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">personWithEmailCount</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>  <span class="c1">// Int</span>
</code></pre>

<p>You can now jump to:</p>

<ul>
<li><a href="#rowconvertible-protocol">RowConvertible Protocol</a></li>
<li><a href="#tablemapping-protocol">TableMapping Protocol</a></li>
<li><a href="#persistable-protocol">Persistable Protocol</a></li>
<li><a href="#record-class">Record Class</a></li>
<li><a href="#the-query-interface">The Query Interface</a></li>
</ul>
<h2 id='rowconvertible-protocol' class='heading'>RowConvertible Protocol</h2>

<p><strong>The RowConvertible protocol grants fetching methods to any type</strong> that can be built from a database row:</p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">RowConvertible</span> <span class="p">{</span>
    <span class="c1">/// Row initializer</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span>

    <span class="c1">/// Optional method which gives adopting types an opportunity to complete</span>
    <span class="c1">/// their initialization after being fetched. Do not call it directly.</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">awakeFromFetch</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><strong>To use RowConvertible</strong>, subclass the <a href="#record-class">Record</a> class, or adopt it explicitely. For example:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">PointOfInterest</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">coordinate</span><span class="p">:</span> <span class="kt">CLLocationCoordinate2D</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">PointOfInterest</span> <span class="p">:</span> <span class="kt">RowConvertible</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"id"</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"title"</span><span class="p">)</span>
        <span class="n">coordinate</span> <span class="o">=</span> <span class="kt">CLLocationCoordinate2DMake</span><span class="p">(</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"latitude"</span><span class="p">),</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"longitude"</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>See <a href="#column-values">column values</a> for more information about the <code>row.value()</code> method.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: for performance reasons, the same row argument to <code>init(row:)</code> is reused during the iteration of a fetch query. If you want to keep the row for later use, make sure to store a copy: <code>self.row = row.copy()</code>.</p>
</blockquote>

<p>RowConvertible allows adopting types to be fetched from SQL queries:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span><span class="o">...</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;PointOfInterest&gt;</span>
<span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span><span class="o">...</span><span class="p">)</span>    <span class="c1">// [PointOfInterest]</span>
<span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span><span class="o">...</span><span class="p">)</span>    <span class="c1">// PointOfInterest?</span>
</code></pre>

<p>See <a href="#fetching-methods">fetching methods</a> for information about the <code>fetchCursor</code>, <code>fetchAll</code> and <code>fetchOne</code> methods. See <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">StatementArguments</a> for more information about the query arguments.</p>
<h3 id='rowconvertible-and-row-adapters' class='heading'>RowConvertible and Row Adapters</h3>

<p>RowConvertible types usually consume rows by column name:</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">PointOfInterest</span> <span class="p">:</span> <span class="kt">RowConvertible</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"id"</span><span class="p">)</span>              <span class="c1">// "id"</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"title"</span><span class="p">)</span>        <span class="c1">// "title"</span>
        <span class="n">coordinate</span> <span class="o">=</span> <span class="kt">CLLocationCoordinate2DMake</span><span class="p">(</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"latitude"</span><span class="p">),</span>        <span class="c1">// "latitude"</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"longitude"</span><span class="p">))</span>       <span class="c1">// "longitude"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Occasionnally, you&rsquo;ll want to write a complex SQL query that uses different column names. In this case, <a href="#row-adapters">row adapters</a> are there to help you mapping raw column names to the names expected by your RowConvertible types.</p>
<h2 id='tablemapping-protocol' class='heading'>TableMapping Protocol</h2>

<p><strong>Adopt the TableMapping protocol</strong> on top of <a href="#rowconvertible-protocol">RowConvertible</a>, and you are granted with the full <a href="#the-query-interface">query interface</a>.</p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">TableMapping</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">databaseTableName</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">selectsRowID</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The <code>databaseTableName</code> type property is the name of a database table. <code>selectsRowID</code> is optional, and documented in the <a href="#the-implicit-rowid-primary-key">The Implicit RowID Primary Key</a> chapter.</p>

<p><strong>To use TableMapping</strong>, subclass the <a href="#record-class">Record</a> class, or adopt it explicitely. For example:</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">PointOfInterest</span> <span class="p">:</span> <span class="kt">TableMapping</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">databaseTableName</span> <span class="o">=</span> <span class="s">"pointOfInterests"</span>
<span class="p">}</span>
</code></pre>

<p>Adopting types can be fetched without SQL, using the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">paris</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">nameColumn</span> <span class="o">==</span> <span class="s">"Paris"</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p>TableMapping can also fetch and delete records by primary key:</p>
<pre class="highlight swift"><code><span class="c1">// Fetch</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>              <span class="c1">// Person?</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>     <span class="c1">// [Person]</span>

<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="s">"FR"</span><span class="p">)</span>          <span class="c1">// Country?</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span> <span class="c1">// [Country]</span>

<span class="c1">// Delete</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span>
</code></pre>

<p>When the table has no explicit primary key, GRDB uses the <a href="#the-implicit-rowid-primary-key">hidden <q>rowid</q> column</a>:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM documents WHERE rowid = 1</span>
<span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>            <span class="c1">// Document?</span>

<span class="c1">// DELETE FROM documents WHERE rowid = 1</span>
<span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>

<p>For multiple-column primary keys and unique keys defined by unique indexes, provide a dictionary:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM citizenships WHERE personID = 1 AND countryISOCode = 'FR'</span>
<span class="k">try</span> <span class="kt">Citizenship</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"personID"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"countryISOCode"</span><span class="p">:</span> <span class="s">"FR"</span><span class="p">])</span> <span class="c1">// Citizenship?</span>

<span class="c1">// DELETE FROM persons WHERE email = 'arthur@example.com'</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span>
</code></pre>
<h2 id='persistable-protocol' class='heading'>Persistable Protocol</h2>

<p><strong>GRDB provides two protocols that let adopting types store themselves in the database:</strong></p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">MutablePersistable</span> <span class="p">:</span> <span class="kt">TableMapping</span> <span class="p">{</span>
    <span class="c1">/// The name of the database table (from TableMapping)</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">databaseTableName</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="c1">/// The values persisted in the database</span>
    <span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>

    <span class="c1">/// Optional method that lets your adopting type store its rowID upon</span>
    <span class="c1">/// successful insertion. Don't call it directly: it is called for you.</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">didInsert</span><span class="p">(</span><span class="n">with</span> <span class="nv">rowID</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span> <span class="k">for</span> <span class="nv">column</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">Persistable</span> <span class="p">:</span> <span class="kt">MutablePersistable</span> <span class="p">{</span>
    <span class="c1">/// Non-mutating version of the optional didInsert(with:for:)</span>
    <span class="kd">func</span> <span class="nf">didInsert</span><span class="p">(</span><span class="n">with</span> <span class="nv">rowID</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span> <span class="k">for</span> <span class="nv">column</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span>
<span class="p">}</span>
</code></pre>

<p>Yes, two protocols instead of one. Both grant exactly the same advantages. Here is how you pick one or the other:</p>

<ul>
<li><p><em>If your type is a struct that mutates on insertion</em>, choose <code>MutablePersistable</code>.</p>

<p>For example, your table has an INTEGER PRIMARY KEY and you want to store the inserted id on successful insertion. Or your table has a UUID primary key, and you want to automatically generate one on insertion.</p></li>
<li><p>Otherwise, stick with <code>Persistable</code>. Particularly if your type is a class.</p></li>
</ul>

<p>The <code>persistentDictionary</code> property returns a dictionary whose keys are column names, and values any DatabaseValueConvertible value (Bool, Int, String, Date, Swift enums, etc.) See <a href="#values">Values</a> for more information.</p>

<p>The optional <code>didInsert</code> method lets the adopting type store its rowID after successful insertion. If your table has an INTEGER PRIMARY KEY column, you are likely to define this method. Otherwise, you can safely ignore it. It is called from a protected dispatch queue, and serialized with all database updates.</p>

<p><strong>To use those protocols</strong>, subclass the <a href="#record-class">Record</a> class, or adopt one of them explicitely. For example:</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">PointOfInterest</span> <span class="p">:</span> <span class="kt">MutablePersistable</span> <span class="p">{</span>

    <span class="c1">/// The values persisted in the database</span>
    <span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s">"id"</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span>
            <span class="s">"title"</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s">"latitude"</span><span class="p">:</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
            <span class="s">"longitude"</span><span class="p">:</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">longitude</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1">// Update id upon successful insertion:</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">didInsert</span><span class="p">(</span><span class="n">with</span> <span class="nv">rowID</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span> <span class="k">for</span> <span class="nv">column</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">rowID</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">paris</span> <span class="o">=</span> <span class="kt">PointOfInterest</span><span class="p">(</span>
    <span class="nv">id</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">title</span><span class="p">:</span> <span class="s">"Paris"</span><span class="p">,</span>
    <span class="nv">coordinate</span><span class="p">:</span> <span class="kt">CLLocationCoordinate2DMake</span><span class="p">(</span><span class="mf">48.8534100</span><span class="p">,</span> <span class="mf">2.3488000</span><span class="p">))</span>

<span class="k">try</span> <span class="n">paris</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">paris</span><span class="o">.</span><span class="n">id</span>   <span class="c1">// some value</span>
</code></pre>

<p>When your record has many columns, the Swift compiler may take a long time compiling the <code>persistentDictionary</code> property:</p>
<pre class="highlight swift"><code><span class="c1">// May be long to compile</span>
<span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span>
        <span class="s">"title"</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="c1">// many other columns</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre>

<p>If this happens, check the <a href="#compilation-takes-a-long-time"><q>Compilation takes a long time</q> FAQ</a>.</p>
<h3 id='persistence-methods' class='heading'>Persistence Methods</h3>

<p><a href="#record-class">Record</a> subclasses and types that adopt <a href="#persistable-protocol">Persistable</a> are given default implementations for methods that insert, update, and delete:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">pointOfInterest</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>               <span class="c1">// INSERT</span>
<span class="k">try</span> <span class="n">pointOfInterest</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>               <span class="c1">// UPDATE</span>
<span class="k">try</span> <span class="n">pointOfInterest</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">columns</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// UPDATE</span>
<span class="k">try</span> <span class="n">pointOfInterest</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>                 <span class="c1">// Inserts or updates</span>
<span class="k">try</span> <span class="n">pointOfInterest</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>               <span class="c1">// DELETE</span>
<span class="n">pointOfInterest</span><span class="o">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>                   <span class="c1">// Bool</span>
</code></pre>

<ul>
<li><p><code>insert</code>, <code>update</code>, <code>save</code> and <code>delete</code> can throw a <a href="#error-handling">DatabaseError</a> whenever an SQLite integrity check fails.</p></li>
<li><p><code>update</code> can also throw a PersistenceError of type recordNotFound, should the update fail because there is no matching row in the database.</p>

<p>When saving an object that may or may not already exist in the database, prefer the <code>save</code> method:</p></li>
<li><p><code>save</code> makes sure your values are stored in the database.</p>

<p>It performs an UPDATE if the record has a non-null primary key, and then, if no row was modified, an INSERT. It directly perfoms an INSERT if the record has no primary key, or a null primary key.</p>

<p>Despite the fact that it may execute two SQL statements, <code>save</code> behaves as an atomic operation: GRDB won&rsquo;t allow any concurrent thread to sneak in (see <a href="#concurrency">concurrency</a>).</p></li>
<li><p><code>delete</code> returns whether a database row was deleted or not.</p></li>
</ul>

<p><strong>All primary keys are supported</strong>, including composite primary keys that span several columns, and the <a href="#the-implicit-rowid-primary-key">implicit rowid primary key</a>.</p>
<h3 id='customizing-the-persistence-methods' class='heading'>Customizing the Persistence Methods</h3>

<p>Your custom type may want to perform extra work when the persistence methods are invoked.</p>

<p>For example, it may want to have its UUID automatically set before inserting. Or it may want to validate its values before saving.</p>

<p>When you subclass <a href="#record-class">Record</a>, you simply have to override the customized method, and call <code>super</code>:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">uuid</span><span class="p">:</span> <span class="kt">UUID</span><span class="p">?</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">insert</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">uuid</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="k">super</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>If you use the raw <a href="#persistable-protocol">Persistable</a> protocol, use one of the <em>special methods</em> <code>performInsert</code>, <code>performUpdate</code>, <code>performSave</code>, <code>performDelete</code>, or <code>performExists</code>:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">Link</span> <span class="p">:</span> <span class="kt">Persistable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>

    <span class="kd">func</span> <span class="nf">insert</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="nf">validate</span><span class="p">()</span>
        <span class="k">try</span> <span class="nf">performInsert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">update</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">,</span> <span class="nv">columns</span><span class="p">:</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="nf">validate</span><span class="p">()</span>
        <span class="k">try</span> <span class="nf">performUpdate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">columns</span><span class="p">:</span> <span class="n">columns</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">validate</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">ValidationError</span><span class="p">(</span><span class="s">"url must be absolute."</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: the special methods <code>performInsert</code>, <code>performUpdate</code>, etc. are reserved for your custom implementations. Do not use them elsewhere. Do not provide another implementation for those methods.</p>

<p>:point_up: <strong>Note</strong>: it is recommended that you do not implement your own version of the <code>save</code> method. Its default implementation forwards the job to <code>update</code> or <code>insert</code>: these are the methods that may need customization, not <code>save</code>.</p>
</blockquote>
<h3 id='conflict-resolution' class='heading'>Conflict Resolution</h3>

<p><strong>Insertions and updates can create conflicts</strong>: for example, a query may attempt to insert a duplicate row that violates a unique index.</p>

<p>Those conflicts normally end with an error. Yet SQLite let you alter the default behavior, and handle conflicts with specific policies. For example, the <code>INSERT OR REPLACE</code> statement handles conflicts with the <q>replace</q> policy which replaces the conflicting row instead of throwing an error.</p>

<p>The <a href="https://www.sqlite.org/lang_conflict.html">five different policies</a> are: abort (the default), replace, rollback, fail, and ignore.</p>

<p><strong>SQLite let you specify conflict policies at two different places:</strong></p>

<ul>
<li><p>At the table level</p>
<pre class="highlight swift"><code><span class="c1">// CREATE TABLE persons (</span>
<span class="c1">//     id INTEGER PRIMARY KEY,</span>
<span class="c1">//     email TEXT UNIQUE ON CONFLICT REPLACE</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"email"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">unique</span><span class="p">(</span><span class="nv">onConflict</span><span class="p">:</span> <span class="o">.</span><span class="n">replace</span><span class="p">)</span> <span class="c1">// &lt;--</span>
<span class="p">}</span>

<span class="c1">// Despite the unique index on email, both inserts succeed.</span>
<span class="c1">// The second insert replaces the first row:</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT INTO persons (email) VALUES (?)"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"arthur@example.com"</span><span class="p">])</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT INTO persons (email) VALUES (?)"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"arthur@example.com"</span><span class="p">])</span>
</code></pre></li>
<li><p>At the query level:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE TABLE persons (</span>
<span class="c1">//     id INTEGER PRIMARY KEY,</span>
<span class="c1">//     email TEXT UNIQUE</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"email"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Again, despite the unique index on email, both inserts succeed.</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT OR REPLACE INTO persons (email) VALUES (?)"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"arthur@example.com"</span><span class="p">])</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT OR REPLACE INTO persons (email) VALUES (?)"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"arthur@example.com"</span><span class="p">])</span>
</code></pre></li>
</ul>

<p>When you want to handle conflicts at the query level, specify a custom <code>persistenceConflictPolicy</code> in your type that adopts the MutablePersistable or Persistable protocol. It will alter the INSERT and UPDATE queries run by the <code>insert</code>, <code>update</code> and <code>save</code> <a href="#persistence-methods">persistence methods</a>:</p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">MutablePersistable</span> <span class="p">{</span>
    <span class="c1">/// The policy that handles SQLite conflicts when records are inserted</span>
    <span class="c1">/// or updated.</span>
    <span class="c1">///</span>
    <span class="c1">/// This property is optional: its default value uses the ABORT policy</span>
    <span class="c1">/// for both insertions and updates, and has GRDB generate regular</span>
    <span class="c1">/// INSERT and UPDATE queries.</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">persistenceConflictPolicy</span><span class="p">:</span> <span class="kt">PersistenceConflictPolicy</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">MutablePersistable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">persistenceConflictPolicy</span> <span class="o">=</span> <span class="kt">PersistenceConflictPolicy</span><span class="p">(</span>
        <span class="nv">insert</span><span class="p">:</span> <span class="o">.</span><span class="n">replace</span><span class="p">,</span>
        <span class="nv">update</span><span class="p">:</span> <span class="o">.</span><span class="n">replace</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// INSERT OR REPLACE INTO persons (...) VALUES (...)</span>
<span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: the <code>ignore</code> policy does not play well at all with the <code>didInsert</code> method which notifies the rowID of inserted records. Choose your poison:</p>

<ul>
<li>if you specify the <code>ignore</code> policy at the table level, don&rsquo;t implement the <code>didInsert</code> method: it will be called with some random id in case of failed insert.</li>
<li>if you specify the <code>ignore</code> policy at the query level, the <code>didInsert</code> method is never called.</li>
</ul>

<p>:warning: <strong>Warning</strong>: <a href="https://www.sqlite.org/lang_conflict.html"><code>ON CONFLICT REPLACE</code></a> may delete rows so that inserts and updates can succeed. Those deletions are not reported to <a href="#database-changes-observation">transaction observers</a> (this might change in a future release of SQLite).</p>
</blockquote>
<h2 id='record-class' class='heading'>Record Class</h2>

<p><strong>Record</strong> is a class that is designed to be subclassed, and provides the full toolkit in one go: fetching and persistence methods, as well as changes tracking (see the <a href="#list-of-record-methods">list of record methods</a> for an overview).</p>

<p>Record subclasses inherit their features from the <a href="#rowconvertible-protocol">RowConvertible</a>, <a href="#tablemapping-protocol">TableMapping</a>, and <a href="#persistable-protocol">Persistable</a> protocols. Check their documentation for more information.</p>

<p>For example, here is a fully functional Record subclass:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">PointOfInterest</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">coordinate</span><span class="p">:</span> <span class="kt">CLLocationCoordinate2D</span>

    <span class="c1">/// The table name</span>
    <span class="k">override</span> <span class="kd">class</span> <span class="k">var</span> <span class="nv">databaseTableName</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">"pointOfInterests"</span>
    <span class="p">}</span>

    <span class="c1">/// Initialize from a database row</span>
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"id"</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"title"</span><span class="p">)</span>
        <span class="n">coordinate</span> <span class="o">=</span> <span class="kt">CLLocationCoordinate2DMake</span><span class="p">(</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"latitude"</span><span class="p">),</span>
            <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"longitude"</span><span class="p">))</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="n">row</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">/// The values persisted in the database</span>
    <span class="k">override</span> <span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s">"id"</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span>
            <span class="s">"title"</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s">"latitude"</span><span class="p">:</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
            <span class="s">"longitude"</span><span class="p">:</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">longitude</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1">/// Update record ID after a successful insertion</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">didInsert</span><span class="p">(</span><span class="n">with</span> <span class="nv">rowID</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span> <span class="k">for</span> <span class="nv">column</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">rowID</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='changes-tracking' class='heading'>Changes Tracking</h3>

<p><strong>The <a href="#record-class">Record</a> class provides changes tracking.</strong></p>

<p>The <code>update()</code> <a href="#persistence-methods">method</a> always executes an UPDATE statement. When the record has not been edited, this costly database access is generally useless.</p>

<p>Avoid it with the <code>hasPersistentChangedValues</code> property, which returns whether the record has changes that have not been saved:</p>
<pre class="highlight swift"><code><span class="c1">// Saves the person if it has changes that have not been saved:</span>
<span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The <code>hasPersistentChangedValues</code> flag is false after a record has been fetched or saved into the database. Subsequent modifications may set it, or not: <code>hasPersistentChangedValues</code> is based on value comparison. <strong>Setting a property to the same value does not set the changed flag</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Barbara"</span><span class="p">,</span> <span class="nv">age</span><span class="p">:</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="c1">// true</span>

<span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="c1">// false</span>

<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Barbara"</span>
<span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="c1">// false</span>

<span class="n">person</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="c1">// true</span>
<span class="n">person</span><span class="o">.</span><span class="n">persistentChangedValues</span>    <span class="c1">// ["age": 35]</span>
</code></pre>

<p>For an efficient algorithm which synchronizes the content of a database table with a JSON payload, check <a href="Playgrounds/JSONSynchronization.playground/Contents.swift">JSONSynchronization.playground</a>.</p>
<h2 id='the-implicit-rowid-primary-key' class='heading'>The Implicit RowID Primary Key</h2>

<p><strong>All SQLite tables have a primary key.</strong> Even when the primary key is not explicit:</p>
<pre class="highlight swift"><code><span class="c1">// No explicit primary key</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"events"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"date"</span><span class="p">,</span> <span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// No way to define an explicit primary key</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"body"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The implicit primary key is stored in the hidden column <code>rowid</code>. Hidden means that <code>SELECT *</code> does not select it, and yet it can be selected and queried: <code>SELECT *, rowid ... WHERE rowid = 1</code>.</p>

<p>Some GRDB methods will automatically use this hidden column when a table has no explicit primary key:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM events WHERE rowid = 1</span>
<span class="k">let</span> <span class="nv">event</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Event</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">// DELETE FROM books WHERE rowid = 1</span>
<span class="k">try</span> <span class="kt">Book</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>
<h3 id='exposing-the-rowid-column' class='heading'>Exposing the RowID Column</h3>

<p><strong>By default, a record type that wraps a table without any explicit primary key doesn&rsquo;t know about the hidden rowid column.</strong></p>

<p>Without primary key, records don&rsquo;t have any identity, and the <a href="#persistence-methods">persistence method</a> can behave in undesired fashion: <code>update()</code> throws errors, <code>save()</code> always performs insertions and may break constraints, <code>exists()</code> is always false.</p>

<p>When SQLite won&rsquo;t let you provide an explicit primary key (as in <a href="#full-text-search">full-text</a> tables, for example), you may want to make your record type fully aware of the hidden rowid column:</p>

<ol>
<li><p>Have the <code>selectsRowID</code> static property from the <a href="#tablemapping-protocol">TableMapping</a> protocol be true.</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">Event</span> <span class="p">:</span> <span class="kt">TableMapping</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">selectsRowID</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// When you subclass Record, you need an override:</span>
<span class="kd">class</span> <span class="kt">Book</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">class</span> <span class="k">var</span> <span class="nv">selectsRowID</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>GRDB will then select the <code>rowid</code> column by default:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT *, rowid FROM events</span>
<span class="k">let</span> <span class="nv">events</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Event</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></li>
<li><p>Have <code>init(row:)</code> from the <a href="#rowconvertible-protocol">RowConvertible</a> protocol consume the <q>rowid</q> column:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">Event</span> <span class="p">:</span> <span class="kt">RowConvertible</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">?</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"rowid"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>If you prefer using the Column type from the <a href="#the-query-interface">query interface</a>, use the <code>Column.rowID</code> constant:</p>
<pre class="highlight swift"><code><span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="kt">Column</span><span class="o">.</span><span class="n">rowID</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Your fetched records will then know their ids:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">event</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Event</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">!</span>
<span class="n">event</span><span class="o">.</span><span class="n">id</span> <span class="c1">// some value</span>
</code></pre></li>
<li><p>Include the rowid in your <code>persistentDictionary</code>, and keep it in the <code>didInsert(with:for:)</code> method (both from the <a href="#persistable-protocol">Persistable and MutablePersistable</a> protocols):</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">Event</span> <span class="p">:</span> <span class="kt">MutablePersistable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s">"rowid"</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span>
            <span class="s">"message"</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s">"date"</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">didInsert</span><span class="p">(</span><span class="n">with</span> <span class="nv">rowID</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">,</span> <span class="k">for</span> <span class="nv">column</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">rowID</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>You will then be able to track your record ids, update them, or check for their existence:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">event</span> <span class="o">=</span> <span class="kt">Event</span><span class="p">(</span><span class="nv">message</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">,</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">())</span>

<span class="c1">// Insertion sets the record id:</span>
<span class="k">try</span> <span class="n">event</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">id</span> <span class="c1">// some value</span>

<span class="c1">// Record can be updated:</span>
<span class="n">event</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s">"bar"</span>
<span class="k">try</span> <span class="n">event</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1">// Record knows if it exists:</span>
<span class="n">event</span><span class="o">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// true</span>
</code></pre></li>
</ol>
<h2 id='list-of-record-methods' class='heading'>List of Record Methods</h2>

<p>This is the list of record methods, along with their required protocols. The <a href="#record-class">Record Class</a> adopts all these protocols.</p>

<table><thead>
<tr>
<th>Method</th>
<th>Protocols</th>
<th style="text-align: center">Notes</th>
</tr>
</thead><tbody>
<tr>
<td><strong>Inserting and Updating Records</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try record.insert(db)</code></td>
<td><a href="#persistable-protocol">Persistable</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try record.save(db)</code></td>
<td><a href="#persistable-protocol">Persistable</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try record.update(db)</code></td>
<td><a href="#persistable-protocol">Persistable</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try record.update(db, columns: ...)</code></td>
<td><a href="#persistable-protocol">Persistable</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><strong>Checking Record Existence</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>record.exists(db)</code></td>
<td><a href="#persistable-protocol">Persistable</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><strong>Deleting Records</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try record.delete(db)</code></td>
<td><a href="#persistable-protocol">Persistable</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try Type.deleteOne(db, key: ...)</code></td>
<td><a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-1">¹</a></td>
</tr>
<tr>
<td><code>try Type.deleteAll(db)</code></td>
<td><a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>try Type.deleteAll(db, keys: ...)</code></td>
<td><a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-1">¹</a></td>
</tr>
<tr>
<td><code>try Type.filter(...).deleteAll(db)</code></td>
<td><a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-2">²</a></td>
</tr>
<tr>
<td><strong>Counting Records</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchCount(db)</code></td>
<td><a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.filter(...).fetchCount(db)</code></td>
<td><a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-2">²</a></td>
</tr>
<tr>
<td><strong>Fetching Record <a href="#cursors">Cursors</a></strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchCursor(db)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchCursor(db, keys: ...)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-1">¹</a></td>
</tr>
<tr>
<td><code>Type.fetchCursor(db, sql)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-3">³</a></td>
</tr>
<tr>
<td><code>Type.fetchCursor(statement)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-4">⁴</a></td>
</tr>
<tr>
<td><code>Type.filter(...).fetchCursor(db)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-2">²</a></td>
</tr>
<tr>
<td><strong>Fetching Record Arrays</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchAll(db)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchAll(db, keys: ...)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-1">¹</a></td>
</tr>
<tr>
<td><code>Type.fetchAll(db, sql)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-3">³</a></td>
</tr>
<tr>
<td><code>Type.fetchAll(statement)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-4">⁴</a></td>
</tr>
<tr>
<td><code>Type.filter(...).fetchAll(db)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-2">²</a></td>
</tr>
<tr>
<td><strong>Fetching Individual Records</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchOne(db)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>Type.fetchOne(db, key: ...)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-1">¹</a></td>
</tr>
<tr>
<td><code>Type.fetchOne(db, sql)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-3">³</a></td>
</tr>
<tr>
<td><code>Type.fetchOne(statement)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-4">⁴</a></td>
</tr>
<tr>
<td><code>Type.filter(...).fetchOne(db)</code></td>
<td><a href="#rowconvertible-protocol">RowConvertible</a> &amp; <a href="#tablemapping-protocol">TableMapping</a></td>
<td style="text-align: center"><a href="#list-of-record-methods-2">²</a></td>
</tr>
<tr>
<td><strong>Changes Tracking</strong></td>
<td></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>record.hasPersistentChangedValues</code></td>
<td><a href="#record-class">Record</a></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><code>record.persistentChangedValues</code></td>
<td><a href="#record-class">Record</a></td>
<td style="text-align: center"></td>
</tr>
</tbody></table>

<p><a name="list-of-record-methods-1">¹</a> All unique keys are supported: primary keys (single-column, composite, <a href="#the-implicit-rowid-primary-key">implicit RowID</a>) and unique indexes:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>                               <span class="c1">// Person?</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span> <span class="c1">// Person?</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span>                  <span class="c1">// [Country]</span>
</code></pre>

<p><a name="list-of-record-methods-2">²</a> See <a href="#requests">Fetch Requests</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>  <span class="c1">// [Person]</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>  <span class="c1">// Int</span>
</code></pre>

<p><a name="list-of-record-methods-3">³</a> See <a href="#fetch-queries">SQL queries</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="s">"SELECT * FROM persons WHERE id = ?"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">// [Person]</span>
</code></pre>

<p><a name="list-of-record-methods-4">⁴</a> See <a href="#prepared-statements">Prepared Statements</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">statement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeSelectStatement</span><span class="p">(</span><span class="s">"SELECT * FROM persons WHERE id = ?"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1">// [Person]</span>
</code></pre>
<h1 id='the-query-interface' class='heading'>The Query Interface</h1>

<p><strong>The query interface lets you write pure Swift instead of SQL:</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Update database schema</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"wines"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>

    <span class="c1">// Fetch records</span>
    <span class="k">let</span> <span class="nv">wines</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Wine</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="s">"Burgundy"</span><span class="p">)</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1">// Count</span>
    <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Wine</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="kt">Color</span><span class="o">.</span><span class="n">red</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1">// Delete</span>
    <span class="k">try</span> <span class="kt">Wine</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">corked</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You need to open a <a href="#database-connections">database connection</a> before you can query the database.</p>

<p>Please bear in mind that the query interface can not generate all possible SQL queries. You may also <em>prefer</em> writing SQL, and this is just OK. From little snippets to full queries, your SQL skills are welcome:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Update database schema (with SQL)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"CREATE TABLE wines (...)"</span><span class="p">)</span>

    <span class="c1">// Fetch records (with SQL)</span>
    <span class="k">let</span> <span class="nv">wines</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Wine</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
        <span class="s">"SELECT * FROM wines WHERE origin = ? ORDER BY price"</span><span class="p">,</span>
        <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Burgundy"</span><span class="p">])</span>

    <span class="c1">// Count (with an SQL snippet)</span>
    <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Wine</span>
        <span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"color = ?"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="kt">Color</span><span class="o">.</span><span class="n">red</span><span class="p">])</span>
        <span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1">// Delete (with SQL)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"DELETE FROM wines WHERE corked"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>So don&rsquo;t miss the <a href="#sqlite-api">SQL API</a>.</p>

<ul>
<li><a href="#database-schema">Database Schema</a></li>
<li><a href="#requests">Requests</a></li>
<li><a href="#expressions">Expressions</a>

<ul>
<li><a href="#sql-operators">SQL Operators</a></li>
<li><a href="#sql-functions">SQL Functions</a></li>
</ul></li>
<li><a href="#fetching-from-requests">Fetching from Requests</a></li>
<li><a href="#fetching-by-key">Fetching by Key</a></li>
<li><a href="#fetching-aggregated-values">Fetching Aggregated Values</a></li>
<li><a href="#delete-requests">Delete Requests</a></li>
<li><a href="#custom-requests">Custom Requests</a></li>
<li><a href="Documentation/ExtendingGRDB.md">GRDB Extension Guide</a></li>
</ul>
<h2 id='database-schema' class='heading'>Database Schema</h2>

<p>Once granted with a <a href="#database-connections">database connection</a>, you can setup your database schema without writing SQL:</p>

<ul>
<li><a href="#create-tables">Create Tables</a></li>
<li><a href="#modify-tables">Modify Tables</a></li>
<li><a href="#drop-tables">Drop Tables</a></li>
<li><a href="#create-indexes">Create Indexes</a></li>
</ul>
<h3 id='create-tables' class='heading'>Create Tables</h3>
<pre class="highlight swift"><code><span class="c1">// CREATE TABLE pointOfInterests (</span>
<span class="c1">//   id INTEGER PRIMARY KEY,</span>
<span class="c1">//   title TEXT,</span>
<span class="c1">//   favorite BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="c1">//   latitude DOUBLE NOT NULL,</span>
<span class="c1">//   longitude DOUBLE NOT NULL</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"pointOfInterests"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"favorite"</span><span class="p">,</span> <span class="o">.</span><span class="n">boolean</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span><span class="o">.</span><span class="nf">defaults</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"longitude"</span><span class="p">,</span> <span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"latitude"</span><span class="p">,</span> <span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>The <code>create(table:)</code> method covers nearly all SQLite table creation features. For virtual tables, see <a href="#full-text-search">Full-Text Search</a>, or use raw SQL.</p>

<p>SQLite has many reference documents about table creation:</p>

<ul>
<li><a href="https://www.sqlite.org/lang_createtable.html">CREATE TABLE</a></li>
<li><a href="https://www.sqlite.org/datatype3.html">Datatypes In SQLite Version 3</a></li>
<li><a href="https://www.sqlite.org/foreignkeys.html">SQLite Foreign Key Support</a></li>
<li><a href="https://www.sqlite.org/lang_conflict.html">ON CONFLICT</a></li>
<li><a href="https://www.sqlite.org/withoutrowid.html">The WITHOUT ROWID Optimization</a></li>
</ul>

<p><strong>Configure table creation</strong>:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE TABLE example ( ... )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"example"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>

<span class="c1">// CREATE TEMPORARY TABLE example IF NOT EXISTS (</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"example"</span><span class="p">,</span> <span class="nv">temporary</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">ifNotExists</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
</code></pre>

<p><strong>Add regular columns</strong> with their name and type (text, integer, double, numeric, boolean, blob, date and datetime) - see <a href="https://www.sqlite.org/datatype3.html">SQLite data types</a>:</p>
<pre class="highlight swift"><code>    <span class="c1">// name TEXT,</span>
    <span class="c1">// creationDate DATETIME,</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"creationDate"</span><span class="p">,</span> <span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
</code></pre>

<p>Define <strong>not null</strong> columns, and set <strong>default</strong> values:</p>
<pre class="highlight swift"><code>    <span class="c1">// email TEXT NOT NULL,</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"email"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>

    <span class="c1">// name TEXT NOT NULL DEFAULT 'Anonymous',</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span><span class="o">.</span><span class="nf">defaults</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="s">"Anonymous"</span><span class="p">)</span>
</code></pre>

<p>Use an individual column as <strong>primary</strong>, <strong>unique</strong>, or <strong>foreign key</strong>. When defining a foreign key, the referenced column is the primary key of the referenced table (unless you specify otherwise):</p>
<pre class="highlight swift"><code>    <span class="c1">// id INTEGER PRIMARY KEY,</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>

    <span class="c1">// email TEXT UNIQUE,</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"email"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">unique</span><span class="p">()</span>

    <span class="c1">// countryCode TEXT REFERENCES countries(code) ON DELETE CASCADE,</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"countryCode"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">references</span><span class="p">(</span><span class="s">"countries"</span><span class="p">,</span> <span class="nv">onDelete</span><span class="p">:</span> <span class="o">.</span><span class="n">cascade</span><span class="p">)</span>
</code></pre>

<p><strong>Perform integrity checks</strong> on individual columns, and SQLite will only let conforming rows in. In the example below, the <code>$0</code> closure variable is a column which lets you build any SQL <a href="#expressions">expression</a>.</p>
<pre class="highlight swift"><code>    <span class="c1">// name TEXT CHECK (LENGTH(name) &gt; 0)</span>
    <span class="c1">// age INTEGER CHECK (age &gt; 0)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">check</span> <span class="p">{</span> <span class="nf">length</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"age"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">check</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"age &gt; 0"</span><span class="p">)</span>
</code></pre>

<p>Other <strong>table constraints</strong> can involve several columns:</p>
<pre class="highlight swift"><code>    <span class="c1">// PRIMARY KEY (a, b),</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">])</span>

    <span class="c1">// UNIQUE (a, b) ON CONFLICT REPLACE,</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">uniqueKey</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">],</span> <span class="nv">onConfict</span><span class="p">:</span> <span class="o">.</span><span class="n">replace</span><span class="p">)</span>

    <span class="c1">// FOREIGN KEY (a, b) REFERENCES parents(c, d),</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">foreignKey</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">],</span> <span class="nv">references</span><span class="p">:</span> <span class="s">"parent"</span><span class="p">)</span>

    <span class="c1">// CHECK (a + b &lt; 10),</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">check</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span> <span class="o">+</span> <span class="kt">Column</span><span class="p">(</span><span class="s">"b"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1">// CHECK (a + b &lt; 10)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">check</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"a + b &lt; 10"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h3 id='modify-tables' class='heading'>Modify Tables</h3>

<p>SQLite lets you rename tables, and add columns to existing tables:</p>
<pre class="highlight swift"><code><span class="c1">// ALTER TABLE referers RENAME TO referrers</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">rename</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"referers"</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="s">"referrers"</span><span class="p">)</span>

<span class="c1">// ALTER TABLE persons ADD COLUMN url TEXT</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">alter</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">column</span><span class="p">:</span> <span class="s">"url"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: SQLite restricts the possible table alterations, and may require you to recreate dependent triggers or views. See the documentation of the <a href="https://www.sqlite.org/lang_altertable.html">ALTER TABLE</a> for details. See <a href="#advanced-database-schema-changes">Advanced Database Schema Changes</a> for a way to lift restrictions.</p>
</blockquote>
<h3 id='drop-tables' class='heading'>Drop Tables</h3>

<p>Drop tables with the <code>drop(table:)</code> method:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">drop</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"obsolete"</span><span class="p">)</span>
</code></pre>
<h3 id='create-indexes' class='heading'>Create Indexes</h3>

<p>Create indexes with the <code>create(index:)</code> method:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE UNIQUE INDEX byEmail ON users(email)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">index</span><span class="p">:</span> <span class="s">"byEmail"</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="s">"users"</span><span class="p">,</span> <span class="nv">columns</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">],</span> <span class="nv">unique</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
</code></pre>

<p>Relevant SQLite documentation:</p>

<ul>
<li><a href="https://www.sqlite.org/lang_createindex.html">CREATE INDEX</a></li>
<li><a href="https://www.sqlite.org/expridx.html">Indexes On Expressions</a></li>
<li><a href="https://www.sqlite.org/partialindex.html">Partial Indexes</a></li>
</ul>
<h2 id='requests' class='heading'>Requests</h2>

<p><strong>The query interface requests</strong> let you fetch values from the database:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>  <span class="c1">// [Person]</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>  <span class="c1">// Int</span>
</code></pre>

<p>All requests start from <strong>a type</strong> that adopts the <code>TableMapping</code> protocol, such as a <code>Record</code> subclass (see <a href="#records">Records</a>):</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</code></pre>

<p>Declare the table <strong>columns</strong> that you want to use for filtering, or sorting:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">idColumn</span> <span class="o">=</span> <span class="kt">Column</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">nameColumn</span> <span class="o">=</span> <span class="kt">Column</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span>
</code></pre>

<p>You can now build requests with the following methods: <code>all</code>, <code>none</code>, <code>select</code>, <code>distinct</code>, <code>filter</code>, <code>matching</code>, <code>group</code>, <code>having</code>, <code>order</code>, <code>reversed</code>, <code>limit</code>. All those methods return another request, which you can further refine by applying another method: <code>Person.select(...).filter(...).order(...)</code>.</p>

<ul>
<li><p><code>all()</code>, <code>none()</code>: the requests for all rows, or no row.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">all</span><span class="p">()</span>
</code></pre>

<p>The hidden <code>rowid</code> column can be selected as well <a href="#the-implicit-rowid-primary-key">when you need it</a>.</p></li>
<li><p><code>select(expression, ...)</code> defines the selected columns.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT id, name FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">idColumn</span><span class="p">,</span> <span class="n">nameColumn</span><span class="p">)</span>

<span class="c1">// SELECT MAX(age) AS maxAge FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">aliased</span><span class="p">(</span><span class="s">"maxAge"</span><span class="p">))</span>
</code></pre></li>
<li><p><code>distinct()</code> performs uniquing.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT DISTINCT name FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">distinct</span><span class="p">()</span>
</code></pre></li>
<li><p><code>filter(expression)</code> applies conditions.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE id IN (1, 2, 3)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">idColumn</span><span class="p">))</span>

<span class="c1">// SELECT * FROM persons WHERE (name IS NOT NULL) AND (height &gt; 1.75)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">nameColumn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="n">heightColumn</span> <span class="o">&gt;</span> <span class="mf">1.75</span><span class="p">)</span>
</code></pre></li>
<li><p><code>matching(pattern)</code> performs <a href="#full-text-search">full-text search</a>.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM documents WHERE documents MATCH 'sqlite database'</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingAllTokensIn</span><span class="p">:</span> <span class="s">"SQLite database"</span><span class="p">)</span>
<span class="kt">Document</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</code></pre>

<p>When the pattern is nil, no row will match.</p></li>
<li><p><code>group(expression, ...)</code> groups rows.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT name, MAX(age) FROM persons GROUP BY name</span>
<span class="kt">Person</span>
    <span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">))</span>
    <span class="o">.</span><span class="nf">group</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>
</code></pre></li>
<li><p><code>having(expression)</code> applies conditions on grouped rows.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT name, MAX(age) FROM persons GROUP BY name HAVING MIN(age) &gt;= 18</span>
<span class="kt">Person</span>
    <span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">))</span>
    <span class="o">.</span><span class="nf">group</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">having</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">)</span>
</code></pre></li>
<li><p><code>order(ordering, ...)</code> sorts.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons ORDER BY name</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>

<span class="c1">// SELECT * FROM persons ORDER BY score DESC, name</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">scoreColumn</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">nameColumn</span><span class="p">)</span>
</code></pre>

<p>Each <code>order</code> call clears any previous ordering:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons ORDER BY name</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>
</code></pre></li>
<li><p><code>reversed()</code> reverses the eventual orderings.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons ORDER BY score ASC, name DESC</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">scoreColumn</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">reversed</span><span class="p">()</span>
</code></pre>

<p>If no ordering was specified, the result is ordered by rowID in reverse order.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons ORDER BY _rowid_ DESC</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">all</span><span class="p">()</span><span class="o">.</span><span class="nf">reversed</span><span class="p">()</span>
</code></pre></li>
<li><p><code>limit(limit, offset: offset)</code> limits and pages results.</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons LIMIT 5</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1">// SELECT * FROM persons LIMIT 5 OFFSET 10</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></li>
</ul>

<p>You can refine requests by chaining those methods:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE (email IS NOT NULL) ORDER BY name</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span>
</code></pre>

<p>The <code>select</code>, <code>order</code>, <code>group</code>, and <code>limit</code> methods ignore and replace previously applied selection, orderings, grouping, and limits. On the opposite, <code>filter</code>, <code>matching</code>, and <code>having</code> methods extend the query:</p>
<pre class="highlight swift"><code><span class="kt">Person</span>                          <span class="c1">// SELECT * FROM persons</span>
    <span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">nameColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span>  <span class="c1">// WHERE (name IS NOT NULL)</span>
    <span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">//        AND (email IS NOT NULL)</span>
    <span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span>          <span class="c1">// - ignored -</span>
    <span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">)</span>           <span class="c1">// ORDER BY age</span>
    <span class="o">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="mi">40</span><span class="p">)</span>      <span class="c1">// - ignored -</span>
    <span class="o">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>                  <span class="c1">// LIMIT 10</span>
</code></pre>

<p>Raw SQL snippets are also accepted, with eventual <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">arguments</a>:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT DATE(creationDate), COUNT(*) FROM persons WHERE name = 'Arthur' GROUP BY date(creationDate)</span>
<span class="kt">Person</span>
    <span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"DATE(creationDate), COUNT(*)"</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"name = ?"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"Arthur"</span><span class="p">])</span>
    <span class="o">.</span><span class="nf">group</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"DATE(creationDate)"</span><span class="p">)</span>
</code></pre>
<h2 id='expressions' class='heading'>Expressions</h2>

<p>Feed <a href="#requests">requests</a> with SQL expressions built from your Swift code:</p>
<h3 id='sql-operators' class='heading'>SQL Operators</h3>

<ul>
<li><p><code>=</code>, <code>&lt;&gt;</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>IS</code>, <code>IS NOT</code></p>

<p>Comparison operators are based on the Swift operators <code>==</code>, <code>!=</code>, <code>===</code>, <code>!==</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE (name = 'Arthur')</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">nameColumn</span> <span class="o">==</span> <span class="s">"Arthur"</span><span class="p">)</span>

<span class="c1">// SELECT * FROM persons WHERE (name IS NULL)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">nameColumn</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>

<span class="c1">// SELECT * FROM persons WHERE (age IS 18)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">ageColumn</span> <span class="o">===</span> <span class="mi">18</span><span class="p">)</span>

<span class="c1">// SELECT * FROM rectangles WHERE width &lt; height</span>
<span class="kt">Rectangle</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">widthColumn</span> <span class="o">&lt;</span> <span class="n">heightColumn</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: SQLite string comparison, by default, is case-sensitive and not Unicode-aware. See <a href="#string-comparison">string comparison</a> if you need more control.</p>
</blockquote></li>
<li><p><code>*</code>, <code>/</code>, <code>+</code>, <code>-</code></p>

<p>SQLite arithmetic operators are derived from their Swift equivalent:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT ((temperature * 1.8) + 32) AS farenheit FROM persons</span>
<span class="kt">Planet</span><span class="o">.</span><span class="nf">select</span><span class="p">((</span><span class="n">temperatureColumn</span> <span class="o">*</span> <span class="mf">1.8</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="nf">aliased</span><span class="p">(</span><span class="s">"farenheit"</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: an expression like <code>nameColumn + &quot;rrr&quot;</code> will be interpreted by SQLite as a numerical addition (with funny results), not as a string concatenation.</p>
</blockquote></li>
<li><p><code>AND</code>, <code>OR</code>, <code>NOT</code></p>

<p>The SQL logical operators are derived from the Swift <code>&amp;&amp;</code>, <code>||</code> and <code>!</code>:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE ((NOT verified) OR (age &lt; 18))</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="n">verifiedColumn</span> <span class="o">||</span> <span class="n">ageColumn</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>
</code></pre></li>
<li><p><code>BETWEEN</code>, <code>IN</code>, <code>IN (subquery)</code>, <code>NOT IN</code>, <code>NOT IN (subquery)</code></p>

<p>To check inclusion in a collection, call the <code>contains</code> method on any Swift sequence:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE id IN (1, 2, 3)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">idColumn</span><span class="p">))</span>

<span class="c1">// SELECT * FROM persons WHERE id NOT IN (1, 2, 3)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">idColumn</span><span class="p">))</span>

<span class="c1">// SELECT * FROM persons WHERE age BETWEEN 0 AND 17</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">((</span><span class="mi">0</span><span class="o">...</span><span class="mi">17</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">))</span>

<span class="c1">// SELECT * FROM persons WHERE (age &gt;= 0) AND (age &lt; 18)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">((</span><span class="mi">0</span><span class="o">..&lt;</span><span class="mi">18</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">))</span>

<span class="c1">// SELECT * FROM persons WHERE name BETWEEN 'A' AND 'z'</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">((</span><span class="s">"A"</span><span class="o">...</span><span class="s">"z"</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">))</span>

<span class="c1">// SELECT * FROM persons WHERE (name &gt;= 'A') AND (name &lt; 'z')</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">((</span><span class="s">"A"</span><span class="o">..&lt;</span><span class="s">"z"</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: SQLite string comparison, by default, is case-sensitive and not Unicode-aware. See <a href="#string-comparison">string comparison</a> if you need more control.</p>
</blockquote>

<p>To check inclusion in a subquery, call the <code>contains</code> method on another request:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM events</span>
<span class="c1">//  WHERE userId IN (SELECT id FROM persons WHERE verified)</span>
<span class="k">let</span> <span class="nv">verifiedUserIds</span> <span class="o">=</span> <span class="kt">User</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">idColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">verifiedColumn</span><span class="p">)</span>
<span class="kt">Event</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">verifiedUserIds</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">userIdColumn</span><span class="p">))</span>
</code></pre></li>
<li><p><code>EXISTS (subquery)</code>, <code>NOT EXISTS (subquery)</code></p>

<p>To check is a subquery would return any row, use the <code>exists</code> property on another request:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons</span>
<span class="c1">// WHERE EXISTS (SELECT * FROM books</span>
<span class="c1">//                WHERE books.ownerId = persons.id)</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="kt">Book</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"books.ownerId = persons.id"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">)</span>
</code></pre></li>
<li><p><code>LIKE</code></p>

<p>The SQLite LIKE operator is available as the <code>like</code> method:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE (email LIKE '%@example.com')</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span><span class="o">.</span><span class="nf">like</span><span class="p">(</span><span class="s">"%@example.com"</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: the SQLite LIKE operator is case-unsensitive but not Unicode-aware. For example, the expression <code>&#39;a&#39; LIKE &#39;A&#39;</code> is true but <code>&#39;æ&#39; LIKE &#39;Æ&#39;</code> is false.</p>
</blockquote></li>
<li><p><code>MATCH</code></p>

<p>The full-text MATCH operator is available through <a href="#fts3pattern">FTS3Pattern</a> (for FTS3 and FTS4 tables) and <a href="#fts5pattern">FTS5Pattern</a> (for FTS5):</p>

<p>FTS3 and FTS4:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingAllTokensIn</span><span class="p">:</span> <span class="s">"SQLite database"</span><span class="p">)</span>

<span class="c1">// SELECT * FROM documents WHERE documents MATCH 'sqlite database'</span>
<span class="kt">Document</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

<span class="c1">// SELECT * FROM documents WHERE content MATCH 'sqlite database'</span>
<span class="kt">Document</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">contentColumn</span><span class="o">.</span><span class="nf">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
</code></pre>

<p>FTS5:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS5Pattern</span><span class="p">(</span><span class="nv">matchingAllTokensIn</span><span class="p">:</span> <span class="s">"SQLite database"</span><span class="p">)</span>

<span class="c1">// SELECT * FROM documents WHERE documents MATCH 'sqlite database'</span>
<span class="kt">Document</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</code></pre></li>
</ul>
<h3 id='sql-functions' class='heading'>SQL Functions</h3>

<ul>
<li><p><code>ABS</code>, <code>AVG</code>, <code>COUNT</code>, <code>LENGTH</code>, <code>MAX</code>, <code>MIN</code>, <code>SUM</code>:</p>

<p>Those are based on the <code>abs</code>, <code>average</code>, <code>count</code>, <code>length</code>, <code>max</code>, <code>min</code> and <code>sum</code> Swift functions:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT MIN(age), MAX(age) FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">ageColumn</span><span class="p">))</span>

<span class="c1">// SELECT COUNT(name) FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">count</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">))</span>

<span class="c1">// SELECT COUNT(DISTINCT name) FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">count</span><span class="p">(</span><span class="nv">distinct</span><span class="p">:</span> <span class="n">nameColumn</span><span class="p">))</span>
</code></pre></li>
<li><p><code>IFNULL</code></p>

<p>Use the Swift <code>??</code> operator:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT IFNULL(name, 'Anonymous') FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span> <span class="p">??</span> <span class="s">"Anonymous"</span><span class="p">)</span>

<span class="c1">// SELECT IFNULL(name, email) FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span> <span class="p">??</span> <span class="n">emailColumn</span><span class="p">)</span>
</code></pre></li>
<li><p><code>LOWER</code>, <code>UPPER</code></p>

<p>The query interface does not give access to those SQLite functions. Nothing against them, but they are not unicode aware.</p>

<p>Instead, GRDB extends SQLite with SQL functions that call the Swift built-in string functions <code>capitalized</code>, <code>lowercased</code>, <code>uppercased</code>, <code>localizedCapitalized</code>, <code>localizedLowercased</code> and <code>localizedUppercased</code>:</p>
<pre class="highlight swift"><code><span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span><span class="o">.</span><span class="nf">uppercased</span><span class="p">())</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: When <em>comparing</em> strings, you&rsquo;d rather use a <a href="#string-comparison">collation</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// Not recommended</span>
<span class="n">nameColumn</span><span class="o">.</span><span class="nf">uppercased</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="nf">uppercased</span><span class="p">()</span>

<span class="c1">// Better</span>
<span class="n">nameColumn</span><span class="o">.</span><span class="nf">collating</span><span class="p">(</span><span class="o">.</span><span class="n">caseInsensitiveCompare</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span>
</code></pre>
</blockquote></li>
<li><p>Custom SQL functions</p>

<p>You can apply your own <a href="#custom-sql-functions">custom SQL functions</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">f</span> <span class="o">=</span> <span class="kt">DatabaseFunction</span><span class="p">(</span><span class="s">"f"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

<span class="c1">// SELECT f(name) FROM persons</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">))</span>
</code></pre></li>
</ul>
<h2 id='fetching-from-requests' class='heading'>Fetching from Requests</h2>

<p>Once you have a request, you can fetch the records at the origin of the request:</p>
<pre class="highlight swift"><code><span class="c1">// Some request based on `Person`</span>
<span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">...</span> <span class="c1">// QueryInterfaceRequest&lt;Person&gt;</span>

<span class="c1">// Fetch persons:</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Person&gt;</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>    <span class="c1">// [Person]</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>    <span class="c1">// Person?</span>
</code></pre>

<p>See <a href="#fetching-methods">fetching methods</a> for information about the <code>fetchCursor</code>, <code>fetchAll</code> and <code>fetchOne</code> methods.</p>

<p>For example:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">allPersons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>                            <span class="c1">// [Person]</span>
<span class="k">let</span> <span class="nv">arthur</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">nameColumn</span> <span class="o">==</span> <span class="s">"Arthur"</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// Person?</span>
</code></pre>

<p><strong>When the selected columns don&rsquo;t fit the source type</strong>, change your target: any other type that adopts the <a href="#rowconvertible-protocol">RowConvertible</a> protocol, plain <a href="#fetching-rows">database rows</a>, and even <a href="#values">values</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Player</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">maxScore</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="c1">// Int?</span>

<span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Player</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">minScore</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>
<span class="k">let</span> <span class="nv">maxScore</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>
</code></pre>
<h2 id='fetching-by-key' class='heading'>Fetching By Key</h2>

<p><strong>Fetching records according to their primary key</strong> is a very common task. It has a shortcut which accepts any single-column primary key:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons WHERE id = 1</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>              <span class="c1">// Person?</span>

<span class="c1">// SELECT * FROM persons WHERE id IN (1, 2, 3)</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>     <span class="c1">// [Person]</span>

<span class="c1">// SELECT * FROM persons WHERE isoCode = 'FR'</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="s">"FR"</span><span class="p">)</span>          <span class="c1">// Country?</span>

<span class="c1">// SELECT * FROM countries WHERE isoCode IN ('FR', 'US')</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span> <span class="c1">// [Country]</span>
</code></pre>

<p>When the table has no explicit primary key, GRDB uses the <a href="#the-implicit-rowid-primary-key">hidden <q>rowid</q> column</a>:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM documents WHERE rowid = 1</span>
<span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>            <span class="c1">// Document?</span>
</code></pre>

<p>For multiple-column primary keys and unique keys defined by unique indexes, provide a dictionary:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM citizenships WHERE personID = 1 AND countryISOCode = 'FR'</span>
<span class="k">try</span> <span class="kt">Citizenship</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"personID"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"countryISOCode"</span><span class="p">:</span> <span class="s">"FR"</span><span class="p">])</span> <span class="c1">// Citizenship?</span>

<span class="c1">// SELECT * FROM persons WHERE email = 'arthur@example.com'</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span>              <span class="c1">// Person?</span>
</code></pre>
<h2 id='fetching-aggregated-values' class='heading'>Fetching Aggregated Values</h2>

<p><strong>Requests can count.</strong> The <code>fetchCount()</code> method returns the number of rows that would be returned by a fetch request:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT COUNT(*) FROM persons</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// Int</span>

<span class="c1">// SELECT COUNT(*) FROM persons WHERE email IS NOT NULL</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1">// SELECT COUNT(DISTINCT name) FROM persons</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">distinct</span><span class="p">()</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1">// SELECT COUNT(*) FROM (SELECT DISTINCT name, age FROM persons)</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">,</span> <span class="n">ageColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">distinct</span><span class="p">()</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p><strong>Other aggregated values</strong> can also be selected and fetched (see <a href="#sql-functions">SQL Functions</a>):</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Player</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">maxScore</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="c1">// Int?</span>

<span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Player</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">minScore</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>
<span class="k">let</span> <span class="nv">maxScore</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="kt">Int</span>
</code></pre>
<h2 id='delete-requests' class='heading'>Delete Requests</h2>

<p><strong>Requests can delete records</strong>, with the <code>deleteAll()</code> method:</p>
<pre class="highlight swift"><code><span class="c1">// DELETE FROM persons WHERE email IS NULL</span>
<span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">emailColumn</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p><strong>Deleting records according to their primary key</strong> is also quite common. It has a shortcut which accepts any single-column primary key:</p>
<pre class="highlight swift"><code><span class="c1">// DELETE FROM persons WHERE id = 1</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">// DELETE FROM persons WHERE id IN (1, 2, 3)</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="c1">// DELETE FROM persons WHERE isoCode = 'FR'</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="s">"FR"</span><span class="p">)</span>

<span class="c1">// DELETE FROM countries WHERE isoCode IN ('FR', 'US')</span>
<span class="k">try</span> <span class="kt">Country</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">keys</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">,</span> <span class="s">"US"</span><span class="p">])</span>
</code></pre>

<p>When the table has no explicit primary key, GRDB uses the <a href="#the-implicit-rowid-primary-key">hidden <q>rowid</q> column</a>:</p>
<pre class="highlight swift"><code><span class="c1">// DELETE FROM documents WHERE rowid = 1</span>
<span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>

<p>For multiple-column primary keys and unique keys defined by unique indexes, provide a dictionary:</p>
<pre class="highlight swift"><code><span class="c1">// DELETE FROM citizenships WHERE personID = 1 AND countryISOCode = 'FR'</span>
<span class="k">try</span> <span class="kt">Citizenship</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"personID"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"countryISOCode"</span><span class="p">:</span> <span class="s">"FR"</span><span class="p">])</span>

<span class="c1">// DELETE FROM persons WHERE email = 'arthur@example.com'</span>
<span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span>
</code></pre>
<h2 id='custom-requests' class='heading'>Custom Requests</h2>

<p>Until now, we have seen <a href="#requests">requests</a> created from any type that adopts the <a href="#tablemapping-protocol">TableMapping</a> protocol:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">all</span><span class="p">()</span>  <span class="c1">// QueryInterfaceRequest&lt;Person&gt;</span>
</code></pre>

<p>Those requests of type <code>QueryInterfaceRequest</code> can fetch, count, and delete records:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Person&gt;</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">()</span>      <span class="c1">// [Person]</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">()</span>      <span class="c1">// Person?</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">()</span>    <span class="c1">// Int</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">()</span>
</code></pre>

<p><strong>When the query interface can not generate the SQL you need</strong>, you can still fallback to <a href="#fetch-queries">raw SQL</a>:</p>
<pre class="highlight swift"><code><span class="c1">// Custom SQL is always welcome</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT ..."</span><span class="p">)</span>   <span class="c1">// [Person]</span>
</code></pre>

<p>But you may prefer to bring some elegance back in, and build custom requests on top of the <code>Request</code> and <code>TypedRequest</code> protocols:</p>
<pre class="highlight swift"><code><span class="c1">// No custom SQL in sight</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">customRequest</span><span class="p">()</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// [Person]</span>
</code></pre>

<p>Unlike QueryInterfaceRequest, these protocols can&rsquo;t delete. But they can fetch and count:</p>
<pre class="highlight swift"><code><span class="c1">/// The protocol for all types that define a way to fetch values from</span>
<span class="c1">/// a database.</span>
<span class="kd">protocol</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">/// A tuple that contains a prepared statement that is ready to be</span>
    <span class="c1">/// executed, and an eventual row adapter.</span>
    <span class="kd">func</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">SelectStatement</span><span class="p">,</span> <span class="kt">RowAdapter</span><span class="p">?)</span>

    <span class="c1">/// The number of rows fetched by the request.</span>
    <span class="kd">func</span> <span class="nf">fetchCount</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="p">}</span>

<span class="c1">/// The protocol for typed fetch requests.</span>
<span class="kd">protocol</span> <span class="kt">TypedRequest</span> <span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">/// The fetched type</span>
    <span class="k">associatedtype</span> <span class="kt">Fetched</span>
<span class="p">}</span>
</code></pre>

<p>The <code>prepare</code> method returns a tuple made of a <a href="#prepared-statements">prepared statement</a> and an optional <a href="#row-adapters">row adapter</a>. The prepared statement tells which SQL query should be executed. The row adapter can help <em>presenting</em> the fetched rows in the way expected by the row consumers (we&rsquo;ll see an example below).</p>

<p>The <code>fetchCount</code> method has a default implementation that builds a correct but naive SQL query from the statement returned by <code>prepare</code>: <code>SELECT COUNT(*) FROM (...)</code>. Adopting types can refine the counting SQL by customizing their <code>fetchCount</code> implementation.</p>
<h3 id='fetching-from-custom-requests' class='heading'>Fetching From Custom Requests</h3>

<p>A Request doesn&rsquo;t know what to fetch, but it can feed the <a href="#fetching-methods">fetching methods</a> of any fetchable type (<a href="#fetching-rows">Row</a>, <a href="#value-queries">value</a>, or <a href="#records">record</a>):</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="c1">// DatabaseCursor&lt;Row&gt;</span>
<span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="c1">// [String]</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="c1">// Person?</span>
</code></pre>

<p>A TypedRequest knows exactly what it has to do when its Fetched associated type is fetchable (<a href="#fetching-rows">Row</a>, <a href="#value-queries">value</a>, or <a href="#records">record</a>):</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="o">...</span>                <span class="c1">// Some TypedRequest that fetches Person</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>      <span class="c1">// DatabaseCursor&lt;Person&gt;</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>         <span class="c1">// [Person]</span>
<span class="k">try</span> <span class="n">request</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>         <span class="c1">// Person?</span>
</code></pre>
<h3 id='building-custom-requests' class='heading'>Building Custom Requests</h3>

<p><strong>To build custom requests</strong>, you can create your own type that adopts the protocols, or derive requests from other requests, or use one of the built-in concrete types:</p>

<ul>
<li><a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Protocols/Request.html">Request</a>: the protocol for all requests</li>
<li><a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Protocols/TypedRequest.html">TypedRequest</a>: the protocol for all typed requests</li>
<li><a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/SQLRequest.html">SQLRequest</a>: a Request built from raw SQL</li>
<li><a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/AnyRequest.html">AnyRequest</a>: a type-erased Request</li>
<li><a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/AnyTypedRequest.html">AnyTypedRequest</a>: a type-erased TypedRequest</li>
</ul>

<p>Rebind the fetched type of requests:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">maxScore</span> <span class="o">=</span> <span class="kt">Player</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">scoreColumn</span><span class="p">))</span>
    <span class="o">.</span><span class="nf">bound</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Int</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p>Bind custom SQL requests to your record types:</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">customRequest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyTypedRequest</span><span class="o">&lt;</span><span class="kt">Person</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">SQLRequest</span><span class="p">(</span><span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="nf">bound</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Person</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">customRequest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>   <span class="c1">// [Person]</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">customRequest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// Int</span>
</code></pre>

<p>Use <a href="#row-adapters">row adapters</a> to ease the consumption of complex rows:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">BookAuthorPair</span> <span class="p">:</span> <span class="kt">RowConvertible</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">book</span><span class="p">:</span> <span class="kt">Book</span>
    <span class="k">let</span> <span class="nv">author</span><span class="p">:</span> <span class="kt">Author</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">book</span> <span class="o">=</span> <span class="kt">Book</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
        <span class="n">author</span> <span class="o">=</span> <span class="kt">Author</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="nf">scoped</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="s">"authors"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">all</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyTypedRequest</span><span class="o">&lt;</span><span class="kt">BookAuthorPair</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">SQLRequest</span><span class="p">(</span>
            <span class="s">"SELECT books.*, authors.* "</span> <span class="o">+</span>
            <span class="s">"FROM books "</span> <span class="o">+</span>
            <span class="s">"JOIN authors ON authors.id = books.authorID"</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">bound</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">BookAuthorPair</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
            <span class="o">.</span><span class="n">adapted</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
                <span class="c1">// The scopes are used in init(row:)</span>
                <span class="k">try</span> <span class="kt">ScopeAdapter</span><span class="p">([</span>
                    <span class="s">"books"</span><span class="p">:</span> <span class="kt">SuffixRowAdapter</span><span class="p">(</span><span class="nv">fromIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s">"authors"</span><span class="p">:</span> <span class="kt">SuffixRowAdapter</span><span class="p">(</span><span class="nv">fromIndex</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="nf">columnCount</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="s">"books"</span><span class="p">))])</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">fetchAll</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">BookAuthorPair</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="nf">all</span><span class="p">()</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">pair</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">BookAuthorPair</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">pair</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">title</span><span class="se">)</span><span class="s"> by </span><span class="se">\(</span><span class="n">pair</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h1 id='application-tools' class='heading'>Application Tools</h1>

<p>On top of the APIs described above, GRDB provides a toolkit for applications. While none of those are mandatory, all of them help dealing with the database:</p>

<ul>
<li><a href="#migrations">Migrations</a>: Transform your database as your application evolves.</li>
<li><a href="#full-text-search">Full-Text Search</a>: Perform efficient and customizable full-text searches.</li>
<li><a href="#database-changes-observation">Database Changes Observation</a>: Perform post-commit and post-rollback actions.</li>
<li><a href="#fetchedrecordscontroller">FetchedRecordsController</a>: Automatic database changes tracking, plus UITableView animations.</li>
<li><a href="#encryption">Encryption</a>: Encrypt your database with SQLCipher.</li>
<li><a href="#backup">Backup</a>: Dump the content of a database to another.</li>
</ul>
<h2 id='migrations' class='heading'>Migrations</h2>

<p><strong>Migrations</strong> are a convenient way to alter your database schema over time in a consistent and easy way.</p>

<p>Migrations run in order, once and only once. When a user upgrades your application, only non-applied migrations are run.</p>

<p>Inside each migration, you typically <a href="#database-schema">define and update your database tables</a> according to your evolving application needs:</p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">migrator</span> <span class="o">=</span> <span class="kt">DatabaseMigrator</span><span class="p">()</span>

<span class="c1">// v1 database</span>
<span class="n">migrator</span><span class="o">.</span><span class="nf">registerMigration</span><span class="p">(</span><span class="s">"v1"</span><span class="p">)</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">index</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// v2 database</span>
<span class="n">migrator</span><span class="o">.</span><span class="nf">registerMigration</span><span class="p">(</span><span class="s">"v2"</span><span class="p">)</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">alter</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Migrations for future versions will be inserted here:</span>
<span class="c1">//</span>
<span class="c1">// // v3 database</span>
<span class="c1">// migrator.registerMigration("v3") { db in</span>
<span class="c1">//     ...</span>
<span class="c1">// }</span>

<span class="k">try</span> <span class="n">migrator</span><span class="o">.</span><span class="nf">migrate</span><span class="p">(</span><span class="n">dbQueue</span><span class="p">)</span> <span class="c1">// or migrator.migrate(dbPool)</span>
</code></pre>

<p><strong>Each migration runs in a separate transaction.</strong> Should one throw an error, its transaction is rollbacked, subsequent migrations do not run, and the error is eventually thrown by <code>migrator.migrate(dbQueue)</code>.</p>

<p><strong>The memory of applied migrations is stored in the database itself</strong> (in a reserved table).</p>
<h3 id='advanced-database-schema-changes' class='heading'>Advanced Database Schema Changes</h3>

<p>SQLite does not support many schema changes, and won&rsquo;t let you drop a table column with <q>ALTER TABLE &hellip; DROP COLUMN &hellip;</q>, for example.</p>

<p>Yet any kind of schema change is still possible. The SQLite documentation explains in detail how to do so: <a href="https://www.sqlite.org/lang_altertable.html#otheralter">https://www.sqlite.org/lang_altertable.html#otheralter</a>. This technique requires the temporary disabling of foreign key checks, and is supported by the <code>registerMigrationWithDeferredForeignKeyCheck</code> function:</p>
<pre class="highlight swift"><code><span class="c1">// Add a NOT NULL constraint on persons.name:</span>
<span class="n">migrator</span><span class="o">.</span><span class="nf">registerMigrationWithDeferredForeignKeyCheck</span><span class="p">(</span><span class="s">"AddNotNullCheckOnName"</span><span class="p">)</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"new_persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"id"</span><span class="p">,</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="nf">primaryKey</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">notNull</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT INTO new_persons SELECT * FROM persons"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">drop</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">rename</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"new_persons"</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>While your migration code runs with disabled foreign key checks, those are re-enabled and checked at the end of the migration, regardless of eventual errors.</p>
<h2 id='full-text-search' class='heading'>Full-Text Search</h2>

<p><strong>Full-Text Search is an efficient way to search a corpus of textual documents.</strong></p>
<pre class="highlight swift"><code><span class="c1">// Create full-text tables</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="c1">// or FTS3(), or FTS5()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"body"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Populate full-text table with records or SQL</span>
<span class="k">try</span> <span class="kt">Book</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
    <span class="s">"INSERT INTO books (author, title, body) VALUES (?, ?, ?)"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">])</span>

<span class="c1">// Build search patterns</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingPhrase</span><span class="p">:</span> <span class="s">"Moby-Dick"</span><span class="p">)</span>

<span class="c1">// Search with the query interface or SQL</span>
<span class="k">let</span> <span class="nv">books</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Book</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">books</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Book</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM books WHERE books MATCH ?"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">pattern</span><span class="p">])</span>
</code></pre>

<ul>
<li><strong><a href="#choosing-the-full-text-engine">Choosing the Full-Text Engine</a></strong></li>
<li><strong>Create Full-Text Virtual Tables</strong>: <a href="#create-fts3-and-fts4-virtual-tables">FTS3/4</a>, <a href="#create-fts5-virtual-tables">FTS5</a></li>
<li><strong>Choosing a Tokenizer</strong>: <a href="#fts3-and-fts4-tokenizers">FTS3/4</a>, <a href="#fts5-tokenizers">FTS5</a></li>
<li><strong>Search Patterns</strong>: <a href="#fts3pattern">FTS3/4</a>, <a href="#fts5pattern">FTS5</a></li>
<li><strong>Sorting by Relevance</strong>: <a href="#fts5-sorting-by-relevance">FTS5</a></li>
<li><strong>External Content Full-Text Tables</strong>: <a href="#external-content-full-text-tables">FTS4/5</a></li>
<li><strong>Full-Text Record</strong>s: <a href="#full-text-records">FTS3/4/5</a></li>
<li><strong>Unicode Full-Text Gotchas</strong>: <a href="#unicode-full-text-gotchas">FTS3/4/5</a>. Unicorns don&rsquo;t exist.</li>
<li><strong>Custom Tokenizers</strong>: <a href="Documentation/FTS5Tokenizers.md">FTS5</a>. Leverage extra full-text features such as synonyms or stop words. Avoid <a href="#unicode-full-text-gotchas">unicode gotchas</a>.</li>
<li><strong>Sample Code</strong>: <a href="https://github.com/groue/WWDCCompanion">WWDC Companion</a>, an iOS app that stores, displays, and lets the user search the WWDC 2016 sessions.</li>
</ul>
<h3 id='choosing-the-full-text-engine' class='heading'>Choosing the Full-Text Engine</h3>

<p><strong>SQLite supports three full-text engines: <a href="https://www.sqlite.org/fts3.html">FTS3, FTS4</a> and <a href="https://www.sqlite.org/fts5.html">FTS5</a>.</strong></p>

<p>Generally speaking, FTS5 is better than FTS4 which improves on FTS3. But this does not really tell which engine to choose for your application. Instead, make your choice depend on:</p>
<li><p><strong>The full-text features needed by the application</strong>:</p>

<table><thead>
<tr>
<th>Full-Text Needs</th>
<th style="text-align: center">FTS3</th>
<th style="text-align: center">FTS4</th>
<th style="text-align: center">FTS5</th>
</tr>
</thead><tbody>
<tr>
<td>:question: Queries</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><strong>Words searches</strong> (documents that contain <q>database</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Prefix searches</strong> (documents that contain a word starting with <q>data</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Phrases searches</strong> (documents that contain the phrase <q>SQLite database</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Boolean searches</strong> (documents that contain <q>SQLite</q> or <q>database</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Proximity search</strong> (documents that contain <q>SQLite</q> near <q>database</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td>:scissors: Tokenization</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><strong>Ascii case insensitivity</strong> (have <q>DATABASE</q> match <q>database</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Unicode case insensitivity</strong> (have <q>ÉLÉGANCE</q> match <q>élégance</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Latin diacritics insensitivity</strong> (have <q>elegance</q> match <q>élégance</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>English Stemming</strong> (have <q>frustration</q> match <q>frustrated</q>)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>English Stemming and Ascii case insensitivity</strong></td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>English Stemming and Unicode case insensitivity</strong></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>English Stemming and Latin diacritics insensitivity</strong></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Synonyms</strong> (have <q>1st</q> match <q>first</q>)</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">X ²</td>
</tr>
<tr>
<td><strong>Pinyin and Romaji</strong> (have <q>romaji</q> match <q>ローマ字</q>)</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">X ²</td>
</tr>
<tr>
<td><strong>Stop words</strong> (don&rsquo;t index, and don&rsquo;t match words like <q>and</q> and <q>the</q>)</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">X ²</td>
</tr>
<tr>
<td><strong>Spell checking</strong> (have <q>alamaba</q> match <q>alabama</q>)</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">¹</td>
</tr>
<tr>
<td>:bowtie: Other Features</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
</tr>
<tr>
<td><strong>Ranking</strong> (sort results by relevance)</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">¹</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td><strong>Snippets</strong> (display a few words around a match)</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
</tbody></table>

<p>¹ Requires extra setup, possibly hard to implement.</p>

<p>² Requires a <a href="Documentation/FTS5Tokenizers.md">custom tokenizer</a>.</p>

<p>For a full feature list, read the SQLite documentation. Some missing features can be achieved with extra application code.</p></li>
<li><p><strong>The speed versus disk space constraints.</strong> Roughly speaking, FTS4 and FTS5 are faster than FTS3, but use more space. FTS4 only supports content compression.</p></li>
<li><p><strong>The location of the indexed text in your database schema.</strong> Only FTS4 and FTS5 support <q>contentless</q> and <q>external content</q> tables.</p></li>
<li><p><strong>The SQLite library integrated in your application.</strong> The version of SQLite that ships with iOS, macOS and watchOS support FTS3 and FTS4 out of the box, but not FTS5. To use FTS5, you&rsquo;ll need a <a href="Documentation/CustomSQLiteBuilds.md">custom SQLite build</a> that activates the <code>SQLITE_ENABLE_FTS5</code> compilation option.</p></li>
<div class="aside aside-see">
    <p class="aside-title">See</p>
    <p>See <a href="https://www.sqlite.org/fts3.html#differences_between_fts3_and_fts4">FST3 vs. FTS4</a> and <a href="https://www.sqlite.org/fts5.html#appendix_a">FTS5 vs. FTS3/4</a> for more differences.</p>

</div>

<blockquote>
<p>:point_up: <strong>Note</strong>: In case you were still wondering, it is recommended to read the SQLite documentation: <a href="https://www.sqlite.org/fts3.html">FTS3 &amp; FTS4</a> and <a href="https://www.sqlite.org/fts5.html">FTS5</a>.</p>
</blockquote>
<h3 id='create-fts3-and-fts4-virtual-tables' class='heading'>Create FTS3 and FTS4 Virtual Tables</h3>

<p><strong>FTS3 and FTS4 full-text tables store and index textual content.</strong></p>

<p>Create tables with the <code>create(virtualTable:using:)</code> method:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE VIRTUAL TABLE documents USING fts3(content)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"documents"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS3</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// CREATE VIRTUAL TABLE documents USING fts4(content)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"documents"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><strong>All columns in a full-text table contain text.</strong> If you need to index a table that contains other kinds of values, you need an <a href="#external-content-full-text-tables"><q>external content</q> full-text table</a>.</p>

<p>You can specify a <a href="#fts3-and-fts4-tokenizers">tokenizer</a>:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE VIRTUAL TABLE books USING fts4(</span>
<span class="c1">//   tokenize=porter,</span>
<span class="c1">//   author,</span>
<span class="c1">//   title,</span>
<span class="c1">//   body</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">porter</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"body"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>FTS4 supports <a href="https://www.sqlite.org/fts3.html#fts4_options">options</a>:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE VIRTUAL TABLE books USING fts4(</span>
<span class="c1">//   content,</span>
<span class="c1">//   uuid,</span>
<span class="c1">//   content="",</span>
<span class="c1">//   compress=zip,</span>
<span class="c1">//   uncompress=unzip,</span>
<span class="c1">//   prefix="2,4",</span>
<span class="c1">//   notindexed=uuid,</span>
<span class="c1">//   languageid=lid</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"documents"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">t</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="s">"zip"</span>
    <span class="n">t</span><span class="o">.</span><span class="n">uncompress</span> <span class="o">=</span> <span class="s">"unzip"</span>
    <span class="n">t</span><span class="o">.</span><span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"uuid"</span><span class="p">)</span><span class="o">.</span><span class="nf">notIndexed</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"lid"</span><span class="p">)</span><span class="o">.</span><span class="nf">asLanguageId</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>The <code>content</code> option is involved in <q>contentless</q> and <q>external content</q> full-text tables. GRDB can help you defining full-text tables that automatically synchronize with their content table. See <a href="#external-content-full-text-tables">External Content Full-Text Tables</a>.</p>

<p>See <a href="https://www.sqlite.org/fts3.html">SQLite documentation</a> for more information.</p>
<h3 id='fts3-and-fts4-tokenizers' class='heading'>FTS3 and FTS4 Tokenizers</h3>

<p><strong>A tokenizer defines what <q>matching</q> means.</strong> Depending on the tokenizer you choose, full-text searches won&rsquo;t return the same results.</p>

<p>SQLite ships with three built-in FTS3/4 tokenizers: <code>simple</code>, <code>porter</code> and <code>unicode61</code> that use different algorithms to match queries with indexed content:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="c1">// Pick one:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">simple</span> <span class="c1">// default</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">porter</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>See below some examples of matches:</p>

<table><thead>
<tr>
<th>content</th>
<th>query</th>
<th style="text-align: center">simple</th>
<th style="text-align: center">porter</th>
<th style="text-align: center">unicode61</th>
</tr>
</thead><tbody>
<tr>
<td>Foo</td>
<td>Foo</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td>Foo</td>
<td>FOO</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td>Jérôme</td>
<td>Jérôme</td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center">X ¹</td>
</tr>
<tr>
<td>Jérôme</td>
<td>JÉRÔME</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center">X ¹</td>
</tr>
<tr>
<td>Jérôme</td>
<td>Jerome</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center">X ¹</td>
</tr>
<tr>
<td>Database</td>
<td>Databases</td>
<td style="text-align: center"></td>
<td style="text-align: center">X</td>
<td style="text-align: center"></td>
</tr>
<tr>
<td>Frustration</td>
<td>Frustrated</td>
<td style="text-align: center"></td>
<td style="text-align: center">X</td>
<td style="text-align: center"></td>
</tr>
</tbody></table>

<p>¹ Don&rsquo;t miss <a href="#unicode-full-text-gotchas">Unicode Full-Text Gotchas</a></p>

<ul>
<li><p><strong>simple</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">simple</span>   <span class="c1">// default</span>
<span class="p">}</span>
</code></pre>

<p>The default <q>simple</q> tokenizer is case-insensitive for ASCII characters. It matches <q>foo</q> with <q>FOO</q>, but not <q>Jérôme</q> with <q>JÉRÔME</q>.</p>

<p>It does not provide stemming, and won&rsquo;t match <q>databases</q> with <q>database</q>.</p>

<p>It does not strip diacritics from latin script characters, and won&rsquo;t match <q>jérôme</q> with <q>jerome</q>.</p></li>
<li><p><strong>porter</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">porter</span>
<span class="p">}</span>
</code></pre>

<p>The <q>porter</q> tokenizer compares English words according to their roots: it matches <q>database</q> with <q>databases</q>, and <q>frustration</q> with <q>frustrated</q>.</p>

<p>It does not strip diacritics from latin script characters, and won&rsquo;t match <q>jérôme</q> with <q>jerome</q>.</p></li>
<li><p><strong>unicode61</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">(</span><span class="nv">removeDiacritics</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The <q>unicode61</q> tokenizer is case-insensitive for unicode characters. It matches <q>Jérôme</q> with <q>JÉRÔME</q>.</p>

<p>It strips diacritics from latin script characters by default, and matches <q>jérôme</q> with <q>jerome</q>. This behavior can be disabled, as in the example above.</p>

<p>It does not provide stemming, and won&rsquo;t match <q>databases</q> with <q>database</q>.</p></li>
</ul>

<p>See <a href="https://www.sqlite.org/fts3.html#tokenizer">SQLite tokenizers</a> for more information.</p>
<h3 id='fts3pattern' class='heading'>FTS3Pattern</h3>

<p><strong>Full-text search in FTS3 and FTS4 tables is performed with search patterns:</strong></p>

<ul>
<li><code>database</code> matches all documents that contain <q>database</q></li>
<li><code>data*</code> matches all documents that contain a word starting with <q>data</q></li>
<li><code>SQLite database</code> matches all documents that contain both <q>SQLite</q> and <q>database</q></li>
<li><code>SQLite OR database</code> matches all documents that contain <q>SQLite</q> or <q>database</q></li>
<li><code>&quot;SQLite database&quot;</code> matches all documents that contain the <q>SQLite database</q> phrase</li>
</ul>

<p><strong>Not all search patterns are valid</strong>: they must follow the <a href="https://www.sqlite.org/fts3.html#full_text_index_queries">Full-Text Index Queries Grammar</a>.</p>

<p>The FTS3Pattern type helps you validating patterns, and building valid patterns from untrusted strings (such as strings typed by users):</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">FTS3Pattern</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
    <span class="nf">init</span><span class="p">?(</span><span class="n">matchingAnyTokenIn</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="nf">init</span><span class="p">?(</span><span class="n">matchingAllTokensIn</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="nf">init</span><span class="p">?(</span><span class="n">matchingPhrase</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The first initializer validates your raw patterns against the query grammar, and may throw a <a href="#databaseerror">DatabaseError</a>:</p>
<pre class="highlight swift"><code><span class="c1">// OK: FTS3Pattern</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="s">"sqlite AND database"</span><span class="p">)</span>
<span class="c1">// DatabaseError: malformed MATCH expression: [AND]</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="s">"AND"</span><span class="p">)</span>
</code></pre>

<p>The three other initializers don&rsquo;t throw. They build a valid pattern from any string, <strong>including strings provided by users of your application</strong>. They let you find documents that match all given words, any given word, or a full phrase, depending on the needs of your application:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">query</span> <span class="o">=</span> <span class="s">"SQLite database"</span>
<span class="c1">// Matches documents that contain "SQLite" or "database"</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingAnyTokenIn</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span>
<span class="c1">// Matches documents that contain both "SQLite" and "database"</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingAllTokensIn</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span>
<span class="c1">// Matches documents that contain "SQLite database"</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingPhrase</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span>
</code></pre>

<p>They return nil when no pattern could be built from the input string:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingAnyTokenIn</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>  <span class="c1">// nil</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS3Pattern</span><span class="p">(</span><span class="nv">matchingAnyTokenIn</span><span class="p">:</span> <span class="s">"*"</span><span class="p">)</span> <span class="c1">// nil</span>
</code></pre>

<p>FTS3Pattern are regular <a href="#values">values</a>. You can use them as query <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">arguments</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM documents WHERE content MATCH ?"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">pattern</span><span class="p">])</span>
</code></pre>

<p>Use them in the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="c1">// Search in all columns</span>
<span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1">// Search in a specific column:</span>
<span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span><span class="o">.</span><span class="nf">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>
<h3 id='create-fts5-virtual-tables' class='heading'>Create FTS5 Virtual Tables</h3>

<p><strong>FTS5 full-text tables store and index textual content.</strong></p>

<p>To use FTS5, you&rsquo;ll need a <a href="Documentation/CustomSQLiteBuilds.md">custom SQLite build</a> that activates the <code>SQLITE_ENABLE_FTS5</code> compilation option.</p>

<p>Create FTS5 tables with the <code>create(virtualTable:using:)</code> method:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE VIRTUAL TABLE documents USING fts5(content)</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"documents"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><strong>All columns in a full-text table contain text.</strong> If you need to index a table that contains other kinds of values, you need an <a href="#external-content-full-text-tables"><q>external content</q> full-text table</a>.</p>

<p>You can specify a <a href="#fts5-tokenizers">tokenizer</a>:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE VIRTUAL TABLE books USING fts5(</span>
<span class="c1">//   tokenize='porter',</span>
<span class="c1">//   author,</span>
<span class="c1">//   title,</span>
<span class="c1">//   body</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">porter</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"body"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>FTS5 supports <a href="https://www.sqlite.org/fts5.html#fts5_table_creation_and_initialization">options</a>:</p>
<pre class="highlight swift"><code><span class="c1">// CREATE VIRTUAL TABLE books USING fts5(</span>
<span class="c1">//   content,</span>
<span class="c1">//   uuid UNINDEXED,</span>
<span class="c1">//   content='table',</span>
<span class="c1">//   content_rowid='id',</span>
<span class="c1">//   prefix='2 4',</span>
<span class="c1">//   columnsize=0,</span>
<span class="c1">//   detail=column</span>
<span class="c1">// )</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"documents"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"uuid"</span><span class="p">)</span><span class="o">.</span><span class="nf">notIndexed</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">"table"</span>
    <span class="n">t</span><span class="o">.</span><span class="n">contentRowID</span> <span class="o">=</span> <span class="s">"id"</span>
    <span class="n">t</span><span class="o">.</span><span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="n">columnSize</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s">"column"</span>
<span class="p">}</span>
</code></pre>

<p>The <code>content</code> and <code>contentRowID</code> options are involved in <q>contentless</q> and <q>external content</q> full-text tables. GRDB can help you defining full-text tables that automatically synchronize with their content table. See <a href="#external-content-full-text-tables">External Content Full-Text Tables</a>.</p>

<p>See <a href="https://www.sqlite.org/fts5.html">SQLite documentation</a> for more information.</p>
<h3 id='fts5-tokenizers' class='heading'>FTS5 Tokenizers</h3>

<p><strong>A tokenizer defines what <q>matching</q> means.</strong> Depending on the tokenizer you choose, full-text searches won&rsquo;t return the same results.</p>

<p>SQLite ships with three built-in FTS5 tokenizers: <code>ascii</code>, <code>porter</code> and <code>unicode61</code> that use different algorithms to match queries with indexed content.</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="c1">// Pick one:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">()</span> <span class="c1">// default</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">ascii</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">porter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>See below some examples of matches:</p>

<table><thead>
<tr>
<th>content</th>
<th>query</th>
<th style="text-align: center">ascii</th>
<th style="text-align: center">unicode61</th>
<th style="text-align: center">porter on ascii</th>
<th style="text-align: center">porter on unicode61</th>
</tr>
</thead><tbody>
<tr>
<td>Foo</td>
<td>Foo</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td>Foo</td>
<td>FOO</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td>Jérôme</td>
<td>Jérôme</td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center">X ¹</td>
</tr>
<tr>
<td>Jérôme</td>
<td>JÉRÔME</td>
<td style="text-align: center"></td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center"></td>
<td style="text-align: center">X ¹</td>
</tr>
<tr>
<td>Jérôme</td>
<td>Jerome</td>
<td style="text-align: center"></td>
<td style="text-align: center">X ¹</td>
<td style="text-align: center"></td>
<td style="text-align: center">X ¹</td>
</tr>
<tr>
<td>Database</td>
<td>Databases</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
<tr>
<td>Frustration</td>
<td>Frustrated</td>
<td style="text-align: center"></td>
<td style="text-align: center"></td>
<td style="text-align: center">X</td>
<td style="text-align: center">X</td>
</tr>
</tbody></table>

<p>¹ Don&rsquo;t miss <a href="#unicode-full-text-gotchas">Unicode Full-Text Gotchas</a></p>

<ul>
<li><p><strong>unicode61</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">unicode61</span><span class="p">(</span><span class="nv">removeDiacritics</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The default <q>unicode61</q> tokenizer is case-insensitive for unicode characters. It matches <q>Jérôme</q> with <q>JÉRÔME</q>.</p>

<p>It strips diacritics from latin script characters by default, and matches <q>jérôme</q> with <q>jerome</q>. This behavior can be disabled, as in the example above.</p>

<p>It does not provide stemming, and won&rsquo;t match <q>databases</q> with <q>database</q>.</p></li>
<li><p><strong>ascii</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="n">ascii</span>
<span class="p">}</span>
</code></pre>

<p>The <q>ascii</q> tokenizer is case-insensitive for ASCII characters. It matches <q>foo</q> with <q>FOO</q>, but not <q>Jérôme</q> with <q>JÉRÔME</q>.</p>

<p>It does not provide stemming, and won&rsquo;t match <q>databases</q> with <q>database</q>.</p>

<p>It does not strip diacritics from latin script characters, and won&rsquo;t match <q>jérôme</q> with <q>jerome</q>.</p></li>
<li><p><strong>porter</strong></p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS5</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">porter</span><span class="p">()</span>       <span class="c1">// porter wrapping unicode61 (the default)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">porter</span><span class="p">(</span><span class="o">.</span><span class="n">ascii</span><span class="p">)</span> <span class="c1">// porter wrapping ascii</span>
    <span class="n">t</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="o">.</span><span class="nf">porter</span><span class="p">(</span><span class="o">.</span><span class="nf">unicode61</span><span class="p">(</span><span class="nv">removeDiacritics</span><span class="p">:</span> <span class="kc">false</span><span class="p">))</span> <span class="c1">// porter wrapping unicode61 without diacritics stripping</span>
<span class="p">}</span>
</code></pre>

<p>The porter tokenizer is a wrapper tokenizer which compares English words according to their roots: it matches <q>database</q> with <q>databases</q>, and <q>frustration</q> with <q>frustrated</q>.</p>

<p>It strips diacritics from latin script characters if it wraps unicode61, and does not if it wraps ascii (see the example above).</p></li>
</ul>

<p>See <a href="https://www.sqlite.org/fts5.html#tokenizers">SQLite tokenizers</a> for more information, and <a href="Documentation/FTS5Tokenizers.md">custom FTS5 tokenizers</a> in order to add your own tokenizers.</p>
<h3 id='fts5pattern' class='heading'>FTS5Pattern</h3>

<p><strong>Full-text search in FTS5 tables is performed with search patterns:</strong></p>

<ul>
<li><code>database</code> matches all documents that contain <q>database</q></li>
<li><code>data*</code> matches all documents that contain a word starting with <q>data</q></li>
<li><code>SQLite database</code> matches all documents that contain both <q>SQLite</q> and <q>database</q></li>
<li><code>SQLite OR database</code> matches all documents that contain <q>SQLite</q> or <q>database</q></li>
<li><code>&quot;SQLite database&quot;</code> matches all documents that contain the <q>SQLite database</q> phrase</li>
</ul>

<p><strong>Not all search patterns are valid</strong>: they must follow the <a href="https://www.sqlite.org/fts5.html#full_text_query_syntax">Full-Text Query Syntax</a>.</p>

<p>The FTS5Pattern type helps you validating patterns, and building valid patterns from untrusted strings (such as strings typed by users):</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">Database</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeFTS5Pattern</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">forTable</span> <span class="nv">table</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">FTS5Pattern</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">FTS5Pattern</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">?(</span><span class="n">matchingAnyTokenIn</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="nf">init</span><span class="p">?(</span><span class="n">matchingAllTokensIn</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="nf">init</span><span class="p">?(</span><span class="n">matchingPhrase</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The <code>Database.makeFTS5Pattern(rawPattern:forTable:)</code> method validates your raw patterns against the query grammar and the columns of the targeted table, and may throw a <a href="#databaseerror">DatabaseError</a>:</p>
<pre class="highlight swift"><code><span class="c1">// OK: FTS5Pattern</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeFTS5Pattern</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="s">"sqlite"</span><span class="p">,</span> <span class="nv">forTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span>
<span class="c1">// DatabaseError: syntax error near \"AND\"</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeFTS5Pattern</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="s">"AND"</span><span class="p">,</span> <span class="nv">forTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span>
<span class="c1">// DatabaseError: no such column: missing</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeFTS5Pattern</span><span class="p">(</span><span class="nv">rawPattern</span><span class="p">:</span> <span class="s">"missing: sqlite"</span><span class="p">,</span> <span class="nv">forTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span>
</code></pre>

<p>The FTS5Pattern initializers don&rsquo;t throw. They build a valid pattern from any string, <strong>including strings provided by users of your application</strong>. They let you find documents that match all given words, any given word, or a full phrase, depending on the needs of your application:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">query</span> <span class="o">=</span> <span class="s">"SQLite database"</span>
<span class="c1">// Matches documents that contain "SQLite" or "database"</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS5Pattern</span><span class="p">(</span><span class="nv">matchingAnyTokenIn</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span>
<span class="c1">// Matches documents that contain both "SQLite" and "database"</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS5Pattern</span><span class="p">(</span><span class="nv">matchingAllTokensIn</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span>
<span class="c1">// Matches documents that contain "SQLite database"</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS5Pattern</span><span class="p">(</span><span class="nv">matchingPhrase</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span>
</code></pre>

<p>They return nil when no pattern could be built from the input string:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS5Pattern</span><span class="p">(</span><span class="nv">matchingAnyTokenIn</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>  <span class="c1">// nil</span>
<span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="kt">FTS5Pattern</span><span class="p">(</span><span class="nv">matchingAnyTokenIn</span><span class="p">:</span> <span class="s">"*"</span><span class="p">)</span> <span class="c1">// nil</span>
</code></pre>

<p>FTS5Pattern are regular <a href="#values">values</a>. You can use them as query <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">arguments</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM documents WHERE documents MATCH ?"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">pattern</span><span class="p">])</span>
</code></pre>

<p>Use them in the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>
<h3 id='fts5-sorting-by-relevance' class='heading'>FTS5: Sorting by Relevance</h3>

<p><strong>FTS5 can sort results by relevance</strong> (most to least relevant):</p>
<pre class="highlight swift"><code><span class="c1">// SQL</span>
<span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM documents WHERE documents MATCH ? ORDER BY rank"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">pattern</span><span class="p">])</span>

<span class="c1">// Query Interface</span>
<span class="k">let</span> <span class="nv">documents</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Document</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="kt">Column</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p>For more information about the ranking algorithm, as well as extra options, read <a href="https://www.sqlite.org/fts5.html#sorting_by_auxiliary_function_results">Sorting by Auxiliary Function Results</a></p>

<p>GRDB does not provide any ranking for FTS3 and FTS4. See SQLite&rsquo;s <a href="https://www.sqlite.org/fts3.html#appendix_a">Search Application Tips</a> if you really need it.</p>
<h3 id='external-content-full-text-tables' class='heading'>External Content Full-Text Tables</h3>

<p><strong>An external content table does not store the indexed text.</strong> Instead, it indexes the text stored in another table.</p>

<p>This is very handy when you want to index a table that can not be declared as a full-text table (because it contains non-textual values, for example). You just have to define an external content full-text table that refers to the regular table.</p>

<p>The two tables must be kept up-to-date, so that the full-text index matches the content of the regular table. This synchronization happens automatically if you use the <code>synchronize(withTable:)</code> method in your full-text table definition:</p>
<pre class="highlight swift"><code><span class="c1">// A regular table</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="o">...</span>
<span class="p">}</span>

<span class="c1">// A full-text table synchronized with the regular table</span>
<span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">virtualTable</span><span class="p">:</span> <span class="s">"books_ft"</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">FTS4</span><span class="p">())</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span> <span class="c1">// or FTS5()</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">synchronize</span><span class="p">(</span><span class="nv">withTable</span><span class="p">:</span> <span class="s">"books"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"title"</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"content"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The eventual content already present in the regular table is indexed, and every insert, update or delete that happens in the regular table is automatically applied to the full-text index by the mean of SQL triggers.</p>

<p>For more information, see the SQLite documentation about external content tables: <a href="https://www.sqlite.org/fts3.html#_external_content_fts4_tables_">FTS4</a>, <a href="https://sqlite.org/fts5.html#external_content_tables">FTS5</a>.</p>

<p>See also <a href="https://github.com/groue/WWDCCompanion">WWDC Companion</a>, a sample app that uses external content tables to store, display, and let the user search the WWDC 2016 sessions.</p>
<h4 id='querying-external-content-full-text-tables' class='heading'>Querying External Content Full-Text Tables</h4>

<p>When you need to perform a full-text search, and the external content table contains all the data you need, you can simply query the full-text table.</p>

<p>But if you need to load columns from the regular table, and in the same time perform a full-text search, then you will need to query both tables at the same time.</p>

<p>That is because SQLite will throw an error when you try to perform a full-text search on a regular table:</p>
<pre class="highlight swift"><code><span class="c1">// SQLite error 1: unable to use function MATCH in the requested context</span>
<span class="c1">// SELECT * FROM books WHERE books MATCH '...'</span>
<span class="k">let</span> <span class="nv">books</span> <span class="o">=</span> <span class="kt">Book</span><span class="o">.</span><span class="nf">matching</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p>The solution is to perform a joined request, using raw SQL:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">sql</span> <span class="o">=</span> <span class="s">"SELECT books.* "</span> <span class="o">+</span>
          <span class="s">"FROM books "</span> <span class="o">+</span>
          <span class="s">"JOIN books_ft ON "</span> <span class="o">+</span>
          <span class="s">"books_ft.rowid = books.rowid AND "</span> <span class="o">+</span>
          <span class="s">"books_ft MATCH ?"</span>
<span class="k">let</span> <span class="nv">books</span> <span class="o">=</span> <span class="kt">Book</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">pattern</span><span class="p">])</span>
</code></pre>
<h3 id='full-text-records' class='heading'>Full-Text Records</h3>

<p><strong>You can define <a href="#records">record</a> types around the full-text virtual tables.</strong></p>

<p>However these tables don&rsquo;t have any explicit primary key. Instead, they use the <a href="#the-implicit-rowid-primary-key">implicit rowid primary key</a>: a special hidden column named <code>rowid</code>.</p>

<p>You will have to <a href="#exposing-the-rowid-column">expose this hidden column</a> in order to fetch, delete, and update full-text records by primary key.</p>
<h3 id='unicode-full-text-gotchas' class='heading'>Unicode Full-Text Gotchas</h3>

<p>The SQLite built-in tokenizers for <a href="#fts3-and-fts4-tokenizers">FTS3, FTS4</a> and <a href="#fts5-tokenizers">FTS5</a> are generally unicode-aware, with a few caveats, and limitations.</p>

<p>Generally speaking, matches may fail when content and query don&rsquo;t use the same <a href="http://unicode.org/reports/tr15/">unicode normalization</a>. SQLite actually exhibits inconsistent behavior in this regard.</p>

<p>For example, for <q>aimé</q> to match <q>aimé</q>, they better have the same normalization: the NFC <q>aim\u{00E9}</q> form may not match its NFD <q>aime\u{0301}</q> equivalent. Most strings that you get from Swift, UIKit and Cocoa use NFC, so be careful with NFD inputs (such as strings from the HFS+ file system, or strings that you can&rsquo;t trust like network inputs). Use <a href="https://developer.apple.com/reference/swift/string/1407210-precomposedstringwithcanonicalma">String.precomposedStringWithCanonicalMapping</a> to turn a string into NFC.</p>

<p>Besides, if you want <q>fi</q> to match the ligature <q>&#xfb01;</q> (U+FB01), then you need to normalize your indexed contents and inputs to NFKC or NFKD. Use <a href="https://developer.apple.com/reference/swift/string/1407834-precomposedstringwithcompatibili">String.precomposedStringWithCompatibilityMapping</a> to turn a string into NFKC.</p>

<p>Unicode normalization is not the end of the story, because it won&rsquo;t help <q>Encyclopaedia</q> match <q>Encyclopædia</q>, <q>Mueller</q>, <q>Müller</q>, <q>Grossmann</q>, <q>Großmann</q>, or <q>Diyarbakır</q>, <q>DIYARBAKIR</q>. The <a href="https://developer.apple.com/reference/swift/string/1643133-applyingtransform">String.applyingTransform</a> method can help.</p>

<p>GRDB lets you write <a href="Documentation/FTS5Tokenizers.md">custom FTS5 tokenizers</a> that can transparently deal with all these issues. For FTS3 and FTS4, you&rsquo;ll need to pre-process your strings before injecting them in the full-text engine.</p>

<p>Happy indexing!</p>
<h2 id='database-changes-observation' class='heading'>Database Changes Observation</h2>

<p>The <code>TransactionObserver</code> protocol lets you <strong>observe database changes</strong>:</p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">TransactionObserver</span> <span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="c1">/// Filters database changes that should be notified the the</span>
    <span class="c1">/// `databaseDidChange(with:)` method.</span>
    <span class="kd">func</span> <span class="nf">observes</span><span class="p">(</span><span class="n">eventsOfKind</span> <span class="nv">eventKind</span><span class="p">:</span> <span class="kt">DatabaseEventKind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>

    <span class="c1">/// Notifies a database change:</span>
    <span class="c1">/// - event.kind (insert, update, or delete)</span>
    <span class="c1">/// - event.tableName</span>
    <span class="c1">/// - event.rowID</span>
    <span class="c1">///</span>
    <span class="c1">/// For performance reasons, the event is only valid for the duration of</span>
    <span class="c1">/// this method call. If you need to keep it longer, store a copy:</span>
    <span class="c1">/// event.copy().</span>
    <span class="kd">func</span> <span class="nf">databaseDidChange</span><span class="p">(</span><span class="n">with</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">DatabaseEvent</span><span class="p">)</span>

    <span class="c1">/// An opportunity to rollback pending changes by throwing an error.</span>
    <span class="kd">func</span> <span class="nf">databaseWillCommit</span><span class="p">()</span> <span class="k">throws</span>

    <span class="c1">/// Database changes have been committed.</span>
    <span class="kd">func</span> <span class="nf">databaseDidCommit</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span>

    <span class="c1">/// Database changes have been rollbacked.</span>
    <span class="kd">func</span> <span class="nf">databaseDidRollback</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>To activate a transaction observer, add it to the database queue or pool:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">observer</span> <span class="o">=</span> <span class="kt">MyObserver</span><span class="p">()</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">transactionObserver</span><span class="p">:</span> <span class="n">observer</span><span class="p">)</span>
</code></pre>

<p>Database holds weak references to its transaction observers: they are not retained, and stop getting notifications after they are deallocated.</p>

<p><strong>A transaction observer is notified of all database changes</strong>: inserts, updates and deletes. This includes indirect changes triggered by ON DELETE and ON UPDATE actions associated to <a href="https://www.sqlite.org/foreignkeys.html#fk_actions">foreign keys</a>.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: the changes that are not notified are changes to internal system tables (such as <code>sqlite_master</code>), changes to <a href="https://www.sqlite.org/withoutrowid.html"><code>WITHOUT ROWID</code></a> tables, and the deletion of duplicate rows triggered by <a href="https://www.sqlite.org/lang_conflict.html"><code>ON CONFLICT REPLACE</code></a> clauses (this last exception might change in a future release of SQLite).</p>
</blockquote>

<p>Notified changes are not actually written to disk until <code>databaseDidCommit</code> is called. On the other side, <code>databaseDidRollback</code> confirms their invalidation:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT ..."</span><span class="p">)</span> <span class="c1">// 1. didChange</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE ..."</span><span class="p">)</span> <span class="c1">// 2. didChange</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>               <span class="c1">// 3. willCommit, 4. didCommit</span>
<span class="p">}</span>

<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT ..."</span><span class="p">)</span> <span class="c1">// 1. didChange</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE ..."</span><span class="p">)</span> <span class="c1">// 2. didChange</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">rollback</span>             <span class="c1">// 3. didRollback</span>
<span class="p">}</span>
</code></pre>

<p>Database statements that are executed outside of an explicit transaction do not drop off the radar:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT ..."</span><span class="p">)</span> <span class="c1">// 1. didChange, 2. willCommit, 3. didCommit</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE ..."</span><span class="p">)</span> <span class="c1">// 4. didChange, 5. willCommit, 6. didCommit</span>
<span class="p">}</span>
</code></pre>

<p>Changes that are on hold because of a <a href="https://www.sqlite.org/lang_savepoint.html">savepoint</a> are only notified after the savepoint has been released. This makes sure that notified events are only events that have an opportunity to be committed:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"INSERT ..."</span><span class="p">)</span>            <span class="c1">// 1. didChange</span>

    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"SAVEPOINT foo"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE ..."</span><span class="p">)</span>            <span class="c1">// delayed</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE ..."</span><span class="p">)</span>            <span class="c1">// delayed</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"RELEASE SAVEPOINT foo"</span><span class="p">)</span> <span class="c1">// 2. didChange, 3. didChange</span>

    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"SAVEPOINT foo"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE ..."</span><span class="p">)</span>            <span class="c1">// not notified</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"ROLLBACK TO SAVEPOINT foo"</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>                          <span class="c1">// 4. willCommit, 5. didCommit</span>
<span class="p">}</span>
</code></pre>

<p><strong>Eventual errors</strong> thrown from <code>databaseWillCommit</code> are exposed to the application code:</p>
<pre class="highlight swift"><code><span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>           <span class="c1">// 1. willCommit (throws), 2. didRollback</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="c1">// 3. The error thrown by the transaction observer.</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: all callbacks are called in a protected dispatch queue, and serialized with all database updates.</p>

<p>:point_up: <strong>Note</strong>: the databaseDidChange(with:) and databaseWillCommit() callbacks must not touch the SQLite database. This limitation does not apply to databaseDidCommit and databaseDidRollback which can use their database argument.</p>
</blockquote>

<p><a href="#fetchedrecordscontroller">FetchedRecordsController</a> is based on the TransactionObserver protocol.</p>

<p>See also <a href="https://gist.github.com/groue/2e21172719e634657dfd">TableChangeObserver.swift</a>, which shows a transaction observer that notifies of modified database tables with NSNotificationCenter.</p>
<h3 id='filtering-database-events' class='heading'>Filtering Database Events</h3>

<p><strong>Transaction observers can avoid being notified of some database changes they are not interested in.</strong></p>

<p>At first sight, this looks somewhat redundant with the checks that observers can perform in their <code>databaseDidChange</code> method. But the code below is inefficient:</p>
<pre class="highlight swift"><code><span class="c1">// BAD: An inefficient way to track the "persons" table:</span>
<span class="kd">class</span> <span class="kt">PersonObserver</span><span class="p">:</span> <span class="kt">TransactionObserver</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">personsTableModified</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="kd">func</span> <span class="nf">observes</span><span class="p">(</span><span class="n">eventsOfKind</span> <span class="nv">eventKind</span><span class="p">:</span> <span class="kt">DatabaseEventKind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// Observe all events</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">databaseDidChange</span><span class="p">(</span><span class="n">with</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">DatabaseEvent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">tableName</span> <span class="o">==</span> <span class="s">"persons"</span> <span class="p">{</span>
            <span class="n">personsTableModified</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">databaseDidRollback</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Get ready for next transaction</span>
        <span class="n">personsTableModified</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">databaseDidCommit</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">personsTableModified</span> <span class="p">{</span>
            <span class="c1">// Process committed changes to the persons table</span>
        <span class="p">}</span>

        <span class="c1">// Get ready for next transaction</span>
        <span class="n">personsTableModified</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The <code>databaseDidChange</code> method is invoked for each insertion, deletion, and update of individual rows, of any table. When there are many changed rows, the observer will spend of a lot of time performing the same check again and again.</p>

<p>Instead, filter events in the <code>observes(eventsOfKind:)</code> method. This will prevent <code>databaseDidChange</code> from being called for changes you&rsquo;re not interested into, and is <em>much more</em> efficient:</p>
<pre class="highlight swift"><code><span class="c1">// GOOD: An efficient way to track the "persons" table:</span>
<span class="kd">class</span> <span class="kt">PersonObserver</span><span class="p">:</span> <span class="kt">TransactionObserver</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">personsTableModified</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="kd">func</span> <span class="nf">observes</span><span class="p">(</span><span class="n">eventsOfKind</span> <span class="nv">eventKind</span><span class="p">:</span> <span class="kt">DatabaseEventKind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// Only observe changes to the "persons" table.</span>
        <span class="k">return</span> <span class="n">eventKind</span><span class="o">.</span><span class="n">tableName</span> <span class="o">==</span> <span class="s">"persons"</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">databaseDidChange</span><span class="p">(</span><span class="n">with</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">DatabaseEvent</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">personsTableModified</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// Guaranteed</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">databaseDidRollback</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Get ready for next transaction</span>
        <span class="n">personsTableModified</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">databaseDidCommit</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">personsTableModified</span> <span class="p">{</span>
            <span class="c1">// Process committed changes to the persons table</span>
        <span class="p">}</span>

        <span class="c1">// Get ready for next transaction</span>
        <span class="n">personsTableModified</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The <code>observes(eventsOfKind:)</code> method is also able to inspect the columns that are about to be changed:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">PersonObserver</span><span class="p">:</span> <span class="kt">TransactionObserver</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">observes</span><span class="p">(</span><span class="n">eventsOfKind</span> <span class="nv">eventKind</span><span class="p">:</span> <span class="kt">DatabaseEventKind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// Only observe changes to the "name" column of the "persons" table.</span>
        <span class="k">switch</span> <span class="n">eventKind</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="k">let</span> <span class="nv">tableName</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tableName</span> <span class="o">==</span> <span class="s">"persons"</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="k">let</span> <span class="nv">tableName</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tableName</span> <span class="o">==</span> <span class="s">"persons"</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="k">let</span> <span class="nv">tableName</span><span class="p">,</span> <span class="k">let</span> <span class="nv">columnNames</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tableName</span> <span class="o">==</span> <span class="s">"persons"</span> <span class="o">&amp;&amp;</span> <span class="n">columnNames</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='support-for-sqlite-pre-update-hooks' class='heading'>Support for SQLite Pre-Update Hooks</h3>

<p>A <a href="Documentation/CustomSQLiteBuilds.md">custom SQLite build</a> can activate <a href="http://www.sqlite.org/sessions/c3ref/preupdate_count.html">SQLite <q>preupdate hooks</q></a>. In this case, TransactionObserverType gets an extra callback which lets you observe individual column values in the rows modified by a transaction:</p>
<pre class="highlight swift"><code><span class="kd">protocol</span> <span class="kt">TransactionObserverType</span> <span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="cp">#if SQLITE_ENABLE_PREUPDATE_HOOK</span>
    <span class="c1">/// Notifies before a database change (insert, update, or delete)</span>
    <span class="c1">/// with change information (initial / final values for the row's</span>
    <span class="c1">/// columns).</span>
    <span class="c1">///</span>
    <span class="c1">/// The event is only valid for the duration of this method call. If you</span>
    <span class="c1">/// need to keep it longer, store a copy: event.copy().</span>
    <span class="kd">func</span> <span class="nf">databaseWillChange</span><span class="p">(</span><span class="n">with</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">DatabasePreUpdateEvent</span><span class="p">)</span>
    <span class="cp">#endif</span>
<span class="p">}</span>
</code></pre>
<h2 id='fetchedrecordscontroller' class='heading'>FetchedRecordsController</h2>

<p><strong>You use FetchedRecordsController to track changes in the results of an SQLite request.</strong></p>

<p><strong>FetchedRecordsController can also feed table views, collection views, and animate cells when the results of the request change.</strong></p>

<p>It looks and behaves very much like <a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSFetchedResultsController_Class/">Core Data&rsquo;s NSFetchedResultsController</a>.</p>

<p>Given a fetch request, and a type that adopts the <a href="#rowconvertible-protocol">RowConvertible</a> protocol, such as a subclass of the <a href="#record-class">Record</a> class, a FetchedRecordsController is able to track changes in the results of the fetch request, notify of those changes, and return the results of the request in a form that is suitable for a table view or a collection view, with one cell per fetched record.</p>

<p>See <a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS">GRDBDemoiOS</a> for an sample app that uses FetchedRecordsController.</p>

<ul>
<li><a href="#creating-the-fetched-records-controller">Creating the Fetched Records Controller</a></li>
<li><a href="#responding-to-changes">Responding to Changes</a></li>
<li><a href="#the-changes-notifications">The Changes Notifications</a></li>
<li><a href="#modifying-the-fetch-request">Modifying the Fetch Request</a></li>
<li><a href="#table-and-collection-views">Table and Collection Views</a>

<ul>
<li><a href="#implementing-the-table-view-datasource%20methods">Implementing the Table View Datasource Methods</a></li>
<li><a href="#implementing-table-view-updates">Implementing Table View Updates</a></li>
</ul></li>
<li><a href="#fetchedrecordscontroller-concurrency">FetchedRecordsController Concurrency</a></li>
</ul>
<h3 id='creating-the-fetched-records-controller' class='heading'>Creating the Fetched Records Controller</h3>

<p>When you initialize a fetched records controller, you provide the following mandatory information:</p>

<ul>
<li>A <a href="#database-connections">database connection</a></li>
<li>The type of the fetched records. It must be a type that adopts the <a href="#rowconvertible-protocol">RowConvertible</a> protocol, such as a subclass of the <a href="#record-class">Record</a> class</li>
<li>A fetch request</li>
</ul>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="c1">// Or DatabasePool</span>

<span class="c1">// Using a Request from the Query Interface:</span>
<span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">FetchedRecordsController</span><span class="p">(</span>
    <span class="n">dbQueue</span><span class="p">,</span>
    <span class="nv">request</span><span class="p">:</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"name"</span><span class="p">)))</span>

<span class="c1">// Using SQL, and eventual arguments:</span>
<span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">FetchedRecordsController</span><span class="o">&lt;</span><span class="kt">Person</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="n">dbQueue</span><span class="p">,</span>
    <span class="nv">sql</span><span class="p">:</span> <span class="s">"SELECT * FROM persons ORDER BY name WHERE countryIsoCode = ?"</span><span class="p">,</span>
    <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="s">"FR"</span><span class="p">])</span>
</code></pre>

<p>The fetch request can involve several database tables. The fetched records controller will only track changes in the columns and tables used by the fetch request.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">FetchedRecordsController</span><span class="o">&lt;</span><span class="kt">Person</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="n">dbQueue</span><span class="p">,</span>
    <span class="nv">sql</span><span class="p">:</span> <span class="s">"SELECT persons.name, COUNT(books.id) AS bookCount "</span> <span class="o">+</span>
         <span class="s">"FROM persons "</span> <span class="o">+</span>
         <span class="s">"LEFT JOIN books ON books.authorId = persons.id "</span> <span class="o">+</span>
         <span class="s">"GROUP BY persons.id "</span> <span class="o">+</span>
         <span class="s">"ORDER BY persons.name"</span><span class="p">)</span>
</code></pre>

<p>After creating an instance, you invoke <code>performFetch()</code> to actually execute
the fetch.</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">controller</span><span class="o">.</span><span class="nf">performFetch</span><span class="p">()</span>
</code></pre>
<h3 id='responding-to-changes' class='heading'>Responding to Changes</h3>

<p>In general, FetchedRecordsController is designed to respond to changes at <em>the database layer</em>, by <a href="#the-changes-notifications">notifying</a> when <em>database rows</em> change location or values.</p>

<p>Changes are not reflected until they are applied in the database by a successful <a href="#transactions-and-savepoints">transaction</a>. Transactions can be explicit, or implicit:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">person1</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">person2</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>         <span class="c1">// Explicit transaction</span>
<span class="p">}</span>

<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">person1</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// Implicit transaction</span>
    <span class="k">try</span> <span class="n">person2</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c1">// Implicit transaction</span>
<span class="p">}</span>
</code></pre>

<p>When you apply several changes to the database, you should group them in a single explicit transaction. The controller will then notify of all changes together.</p>
<h3 id='the-changes-notifications' class='heading'>The Changes Notifications</h3>

<p>An instance of FetchedRecordsController notifies that the controller’s fetched records have been changed by the mean of <em>callbacks</em>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">FetchedRecordsController</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">controller</span><span class="o">.</span><span class="nf">trackChanges</span><span class="p">(</span>
    <span class="c1">// controller's records are about to change:</span>
    <span class="nv">willChange</span><span class="p">:</span> <span class="p">{</span> <span class="n">controller</span> <span class="k">in</span> <span class="o">...</span> <span class="p">},</span>

    <span class="c1">// notification of individual record changes:</span>
    <span class="nv">onChange</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span> <span class="k">in</span> <span class="o">...</span> <span class="p">},</span>

    <span class="c1">// controller's records have changed:</span>
    <span class="nv">didChange</span><span class="p">:</span> <span class="p">{</span> <span class="n">controller</span> <span class="k">in</span> <span class="o">...</span> <span class="p">})</span>

<span class="k">try</span> <span class="n">controller</span><span class="o">.</span><span class="nf">performFetch</span><span class="p">()</span>
</code></pre>

<p>See <a href="#implementing-table-view-updates">Implementing Table View Updates</a> for more detail on table view updates.</p>

<p><strong>All callbacks are optional.</strong> When you only need to grab the latest results, you can omit the <code>didChange</code> argument name:</p>
<pre class="highlight swift"><code><span class="n">controller</span><span class="o">.</span><span class="n">trackChanges</span> <span class="p">{</span> <span class="n">controller</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">newPersons</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">fetchedRecords</span> <span class="c1">// [Person]</span>
<span class="p">}</span>
</code></pre>

<p>Callbacks have the fetched record controller itself as an argument: use it in order to avoid memory leaks:</p>
<pre class="highlight swift"><code><span class="c1">// BAD: memory leak</span>
<span class="n">controller</span><span class="o">.</span><span class="n">trackChanges</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">newPersons</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">fetchedRecords</span>
<span class="p">}</span>

<span class="c1">// GOOD</span>
<span class="n">controller</span><span class="o">.</span><span class="n">trackChanges</span> <span class="p">{</span> <span class="n">controller</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">newPersons</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">fetchedRecords</span>
<span class="p">}</span>
</code></pre>

<p><strong>Callbacks are invoked asynchronously.</strong> See <a href="#fetchedrecordscontroller-concurrency">FetchedRecordsController Concurrency</a> for more information.</p>

<p><strong>Values fetched from inside callbacks may be inconsistent with the controller&rsquo;s records.</strong> This is because after database has changed, and before the controller had the opportunity to invoke callbacks in the main thread, other database changes can happen.</p>

<p>To avoid inconsistencies, provide a <code>fetchAlongside</code> argument to the <code>trackChanges</code> method, as below:</p>
<pre class="highlight swift"><code><span class="n">controller</span><span class="o">.</span><span class="nf">trackChanges</span><span class="p">(</span>
    <span class="nv">fetchAlongside</span><span class="p">:</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
        <span class="c1">// Fetch any extra value, for example the number of fetched records:</span>
        <span class="k">return</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">didChange</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="k">in</span>
        <span class="c1">// The extra value is the second argument.</span>
        <span class="k">let</span> <span class="nv">recordsCount</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">fetchedRecords</span><span class="o">.</span><span class="n">count</span>
        <span class="nf">assert</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">recordsCount</span><span class="p">)</span> <span class="c1">// guaranteed</span>
    <span class="p">})</span>
</code></pre>

<p>Whenever the fetched records controller can not look for changes after a transaction has potentially modified the tracked request, an error handler is called. The request observation is not stopped, though: future transactions may successfully be handled, and the notified changes will then be based on the last successful fetch.</p>
<pre class="highlight swift"><code><span class="n">controller</span><span class="o">.</span><span class="n">trackErrors</span> <span class="p">{</span> <span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Missed a transaction because </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h3 id='modifying-the-fetch-request' class='heading'>Modifying the Fetch Request</h3>

<p>You can change a fetched records controller&rsquo;s fetch request or SQL query.</p>
<pre class="highlight swift"><code><span class="n">controller</span><span class="o">.</span><span class="nf">setRequest</span><span class="p">(</span><span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"name"</span><span class="p">)))</span>
<span class="n">controller</span><span class="o">.</span><span class="nf">setRequest</span><span class="p">(</span><span class="nv">sql</span><span class="p">:</span> <span class="s">"SELECT ..."</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>
</code></pre>

<p>The <a href="#the-changes-notifications">notification callbacks</a> are notified of eventual changes if the new request fetches a different set of records.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: This behavior differs from Core Data&rsquo;s NSFetchedResultsController, which does not notify of record changes when the fetch request is replaced.</p>
</blockquote>

<p><strong>Change callbacks are invoked asynchronously.</strong> This means that modifying the request from the main thread does <em>not</em> immediately triggers callbacks. When you need to take immediate action, force the controller to refresh immediately with its <code>performFetch</code> method. In this case, changes callbacks are <em>not</em> called:</p>
<pre class="highlight swift"><code><span class="c1">// Change request on the main thread:</span>
<span class="n">controller</span><span class="o">.</span><span class="nf">setRequest</span><span class="p">(</span><span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"name"</span><span class="p">)))</span>
<span class="c1">// Here callbacks have not been called yet.</span>
<span class="c1">// You can cancel them, and refresh records immediately:</span>
<span class="k">try</span> <span class="n">controller</span><span class="o">.</span><span class="nf">performFetch</span><span class="p">()</span>
</code></pre>
<h3 id='table-and-collection-views' class='heading'>Table and Collection Views</h3>

<p>FetchedRecordsController let you feed table and collection views, and keep them up-to-date with the database content.</p>

<p>For nice animated updates, a fetched records controller needs to recognize identical records between two different result sets. When records adopt the <a href="#tablemapping-protocol">TableMapping</a> protocol, they are automatically compared according to their primary key:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">TableMapping</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">FetchedRecordsController</span><span class="p">(</span>
    <span class="n">dbQueue</span><span class="p">,</span>
    <span class="nv">request</span><span class="p">:</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">all</span><span class="p">())</span>
</code></pre>

<p>For other types, the fetched records controller needs you to be more explicit:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">FetchedRecordsController</span><span class="p">(</span>
    <span class="n">dbQueue</span><span class="p">,</span>
    <span class="nv">request</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>
    <span class="nv">isSameRecord</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">person1</span><span class="p">,</span> <span class="n">person2</span><span class="p">)</span> <span class="k">in</span> <span class="n">person1</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">person2</span><span class="o">.</span><span class="n">id</span> <span class="p">})</span>
</code></pre>
<h4 id='implementing-the-table-view-datasource-methods' class='heading'>Implementing the Table View Datasource Methods</h4>

<p>The table view data source asks the fetched records controller to provide relevant information:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">numberOfSections</span><span class="p">(</span><span class="k">in</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fetchedRecordsController</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">count</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fetchedRecordsController</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">numberOfRecords</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="o">...</span>
    <span class="k">let</span> <span class="nv">record</span> <span class="o">=</span> <span class="n">fetchedRecordsController</span><span class="o">.</span><span class="nf">record</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
    <span class="c1">// Configure the cell</span>
    <span class="k">return</span> <span class="n">cell</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: In its current state, FetchedRecordsController does not support grouping table view rows into custom sections: it generates a unique section.</p>
</blockquote>
<h4 id='implementing-table-view-updates' class='heading'>Implementing Table View Updates</h4>

<p>When changes in the fetched records should reload the whole table view, you can simply tell so:</p>
<pre class="highlight swift"><code><span class="n">controller</span><span class="o">.</span><span class="n">trackChanges</span> <span class="p">{</span> <span class="p">[</span><span class="k">unowned</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>Yet, FetchedRecordsController can notify that the controller’s fetched records have been changed due to some add, remove, move, or update operations, and help applying animated changes to a UITableView.</p>
<h5 id='typical-table-view-updates' class='heading'>Typical Table View Updates</h5>

<p>For animated table view updates, use the <code>willChange</code> and <code>didChange</code> callbacks to bracket events provided by the fetched records controller, as illustrated in the following example:</p>
<pre class="highlight swift"><code><span class="c1">// Assume self has a tableView property, and a cell configuration</span>
<span class="c1">// method named configure(_:at:).</span>

<span class="n">controller</span><span class="o">.</span><span class="nf">trackChanges</span><span class="p">(</span>
    <span class="c1">// controller's records are about to change:</span>
    <span class="nv">willChange</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">unowned</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">beginUpdates</span><span class="p">()</span>
    <span class="p">},</span>

    <span class="c1">// notification of individual record changes:</span>
    <span class="nv">onChange</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">unowned</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">switch</span> <span class="n">change</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">insertion</span><span class="p">(</span><span class="k">let</span> <span class="nv">indexPath</span><span class="p">):</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">indexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">fade</span><span class="p">)</span>

        <span class="k">case</span> <span class="o">.</span><span class="nf">deletion</span><span class="p">(</span><span class="k">let</span> <span class="nv">indexPath</span><span class="p">):</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">indexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">fade</span><span class="p">)</span>

        <span class="k">case</span> <span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="k">let</span> <span class="nv">indexPath</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">case</span> <span class="o">.</span><span class="nf">move</span><span class="p">(</span><span class="k">let</span> <span class="nv">indexPath</span><span class="p">,</span> <span class="k">let</span> <span class="nv">newIndexPath</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">indexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">fade</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">newIndexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">fade</span><span class="p">)</span>

            <span class="c1">// // Alternate technique which actually moves cells around:</span>
            <span class="c1">// let cell = self.tableView.cellForRow(at: indexPath)</span>
            <span class="c1">// self.tableView.moveRow(at: indexPath, to: newIndexPath)</span>
            <span class="c1">// if let cell = cell {</span>
            <span class="c1">//     self.configure(cell, at: newIndexPath)</span>
            <span class="c1">// }</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="c1">// controller's records have changed:</span>
    <span class="nv">didChange</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">unowned</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">endUpdates</span><span class="p">()</span>
    <span class="p">})</span>
</code></pre>

<p>See <a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS">GRDBDemoiOS</a> for an sample app that uses FetchedRecordsController.</p>

<blockquote>
<p>:point_up: <strong>Note</strong>: our sample code above uses <code>unowned</code> references to the table view controller. This is a safe pattern as long as the table view controller owns the fetched records controller, and is deallocated from the main thread (this is usually the case). In other situations, prefer weak references.</p>
</blockquote>
<h3 id='fetchedrecordscontroller-concurrency' class='heading'>FetchedRecordsController Concurrency</h3>

<p><strong>A fetched records controller <em>can not</em> be used from any thread.</strong></p>

<p>When the database itself can be read and modified from <a href="#database-connections">any thread</a>, fetched records controllers <strong>must</strong> be used from the main thread. Record changes are also <a href="#the-changes-notifications">notified</a> on the main thread.</p>

<p><strong>Change callbacks are invoked asynchronously.</strong> This means that changes made from the main thread are <em>not</em> immediately notified. When you need to take immediate action, force the controller to refresh immediately with its <code>performFetch</code> method. In this case, changes callbacks are <em>not</em> called:</p>
<pre class="highlight swift"><code><span class="c1">// Change database on the main thread:</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">Person</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Here callbacks have not been called yet.</span>
<span class="c1">// You can cancel them, and refresh records immediately:</span>
<span class="k">try</span> <span class="n">controller</span><span class="o">.</span><span class="nf">performFetch</span><span class="p">()</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: when the main thread does not fit your needs, give a serial dispatch queue to the controller initializer: the controller must then be used from this queue, and record changes are notified on this queue as well.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">()</span>
<span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">FetchedRecordsController</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">trackChanges</span> <span class="p">{</span> <span class="cm">/* in queue */</span> <span class="p">}</span>
    <span class="k">try</span> <span class="n">controller</span><span class="o">.</span><span class="nf">performFetch</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</blockquote>
<h2 id='encryption' class='heading'>Encryption</h2>

<p><strong>GRDB can encrypt your database with <a href="http://sqlcipher.net">SQLCipher</a> v3.4.0.</strong></p>

<p>This requires a manual installation of GRDB:</p>

<ol>
<li><p>Clone the GRDB.swift git repository, checkout the latest tagged version, and download SQLCipher sources:</p>
<pre class="highlight shell"><code><span class="nb">cd</span> <span class="o">[</span>GRDB.swift directory]
git checkout v0.107.0
git submodule update --init SQLCipher/src
</code></pre></li>
<li><p>Embed the <code>GRDB.xcodeproj</code> project in your own project.</p></li>
<li><p>Add the <code>GRDBCipherOSX</code> or <code>GRDBCipheriOS</code> target in the <strong>Target Dependencies</strong> section of the <strong>Build Phases</strong> tab of your application target.</p></li>
<li><p>Add the <code>GRDBCipher.framework</code> from the targetted platform to the <strong>Embedded Binaries</strong> section of the <strong>General</strong>  tab of your target.</p></li>
</ol>

<p><strong>You create and open an encrypted database</strong> by providing a passphrase to your <a href="#database-connections">database connection</a>:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">GRDBCipher</span>

<span class="k">var</span> <span class="nv">configuration</span> <span class="o">=</span> <span class="kt">Configuration</span><span class="p">()</span>
<span class="n">configuration</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="s">"secret"</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"..."</span><span class="p">,</span> <span class="nv">configuration</span><span class="p">:</span> <span class="n">configuration</span><span class="p">)</span>
</code></pre>

<p><strong>You can change the passphrase</strong> of an already encrypted database:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="nf">change</span><span class="p">(</span><span class="nv">passphrase</span><span class="p">:</span> <span class="s">"newSecret"</span><span class="p">)</span>
</code></pre>

<p>Providing a passphrase won&rsquo;t encrypt a clear-text database that already exists, though. SQLCipher can&rsquo;t do that, and you will get an error instead: <code>SQLite error 26: file is encrypted or is not a database</code>.</p>

<p><strong>To encrypt an existing clear-text database</strong>, create a new and empty encrypted database, and copy the content of the clear-text database in it. The technique to do that is <a href="https://discuss.zetetic.net/t/how-to-encrypt-a-plaintext-sqlite-database-to-use-sqlcipher-and-avoid-file-is-encrypted-or-is-not-a-database-errors/868/1">documented</a> by SQLCipher. With GRDB, it gives:</p>
<pre class="highlight swift"><code><span class="c1">// The clear-text database</span>
<span class="k">let</span> <span class="nv">clearDBQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/clear.db"</span><span class="p">)</span>

<span class="c1">// The encrypted database, at some distinct location:</span>
<span class="k">var</span> <span class="nv">configuration</span> <span class="o">=</span> <span class="kt">Configuration</span><span class="p">()</span>
<span class="n">configuration</span><span class="o">.</span><span class="n">passphrase</span> <span class="o">=</span> <span class="s">"secret"</span>
<span class="k">let</span> <span class="nv">encryptedDBQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="s">"/path/to/encrypted.db"</span><span class="p">,</span> <span class="nv">configuration</span><span class="p">:</span> <span class="n">config</span><span class="p">)</span>

<span class="k">try</span> <span class="n">clearDBQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"ATTACH DATABASE ? AS encrypted KEY ?"</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">encryptedDBQueue</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">"secret"</span><span class="p">])</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"SELECT sqlcipher_export('encrypted')"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"DETACH DATABASE encrypted"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Now the copy is done, and the clear-text database can be deleted.</span>
</code></pre>
<h2 id='backup' class='heading'>Backup</h2>

<p><strong>You can backup (copy) a database into another.</strong></p>

<p>Backups can for example help you copying an in-memory database to and from a database file when you implement NSDocument subclasses.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">source</span><span class="p">:</span> <span class="kt">DatabaseQueue</span> <span class="o">=</span> <span class="o">...</span>      <span class="c1">// or DatabasePool</span>
<span class="k">let</span> <span class="nv">destination</span><span class="p">:</span> <span class="kt">DatabaseQueue</span> <span class="o">=</span> <span class="o">...</span> <span class="c1">// or DatabasePool</span>
<span class="k">try</span> <span class="n">source</span><span class="o">.</span><span class="nf">backup</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span>
</code></pre>

<p>The <code>backup</code> method blocks the current thread until the destination database contains the same contents as the source database.</p>

<p>When the source is a <a href="#database-pools">database pool</a>, concurrent writes can happen during the backup. Those writes may, or may not, be reflected in the backup, but they won&rsquo;t trigger any error.</p>
<h1 id='good-to-know' class='heading'>Good To Know</h1>

<p>This chapter covers general topics that you should be aware of.</p>

<ul>
<li><a href="#avoiding-sql-injection">Avoiding SQL Injection</a></li>
<li><a href="#error-handling">Error Handling</a></li>
<li><a href="#unicode">Unicode</a></li>
<li><a href="#memory-management">Memory Management</a></li>
<li><a href="#data-protection">Data Protection</a></li>
<li><a href="#concurrency">Concurrency</a></li>
<li><a href="#performance">Performance</a></li>
</ul>
<h2 id='avoiding-sql-injection' class='heading'>Avoiding SQL Injection</h2>

<p>SQL injection is a technique that lets an attacker nuke your database.</p>

<blockquote>
<p><img src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" alt="XKCD: Exploits of a Mom"></p>

<p><a href="https://xkcd.com/327/">https://xkcd.com/327/</a></p>
</blockquote>

<p>Here is an example of code that is vulnerable to SQL injection:</p>
<pre class="highlight swift"><code><span class="c1">// BAD BAD BAD</span>
<span class="k">let</span> <span class="nv">name</span> <span class="o">=</span> <span class="n">textField</span><span class="o">.</span><span class="n">text</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="s">"UPDATE students SET name = '</span><span class="se">\(</span><span class="n">name</span><span class="se">)</span><span class="s">' WHERE id = </span><span class="se">\(</span><span class="n">id</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>If the user enters a funny string like <code>Robert&#39;; DROP TABLE students; --</code>, SQLite will see the following SQL, and drop your database table instead of updating a name as intended:</p>
<pre class="highlight sql"><code><span class="k">UPDATE</span> <span class="n">students</span> <span class="k">SET</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'Robert'</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">students</span><span class="p">;</span>
<span class="c1">--' WHERE id = 1</span>
</code></pre>

<p>To avoid those problems, <strong>never embed raw values in your SQL queries</strong>. The only correct technique is to provide <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/StatementArguments.html">arguments</a> to your SQL queries:</p>
<pre class="highlight swift"><code><span class="c1">// Good</span>
<span class="k">let</span> <span class="nv">name</span> <span class="o">=</span> <span class="n">textField</span><span class="o">.</span><span class="n">text</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"UPDATE students SET name = ? WHERE id = ?"</span><span class="p">,</span>
        <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="p">])</span>
<span class="p">}</span>
</code></pre>

<p>See <a href="#executing-updates">Executing Updates</a> for more information on statement arguments.</p>
<h2 id='error-handling' class='heading'>Error Handling</h2>

<p>GRDB can throw <a href="#databaseerror">DatabaseError</a>, <a href="#persistenceerror">PersistenceError</a>, or crash your program with a <a href="#fatal-errors">fatal error</a>.</p>

<p>Considering that a local database is not some JSON loaded from a remote server, GRDB focuses on <strong>trusted databases</strong>. Dealing with <a href="#how-to-deal-with-untrusted-inputs">untrusted databases</a> requires extra care.</p>

<ul>
<li><a href="#databaseerror">DatabaseError</a></li>
<li><a href="#persistenceerror">PersistenceError</a></li>
<li><a href="#fatal-errors">Fatal Errors</a></li>
<li><a href="#how-to-deal-with-untrusted-inputs">How to Deal with Untrusted Inputs</a></li>
<li><a href="#error-log">Error Log</a></li>
</ul>
<h3 id='databaseerror' class='heading'>DatabaseError</h3>

<p><strong>DatabaseError</strong> are thrown on SQLite errors:</p>
<pre class="highlight swift"><code><span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s">"INSERT INTO pets (masterId, name) VALUES (?, ?)"</span><span class="p">,</span>
        <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s">"Bobby"</span><span class="p">])</span>
<span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="k">as</span> <span class="kt">DatabaseError</span> <span class="p">{</span>
    <span class="c1">// The SQLite error code: 19 (SQLITE_CONSTRAINT)</span>
    <span class="n">error</span><span class="o">.</span><span class="n">resultCode</span>

    <span class="c1">// The extended error code: 787 (SQLITE_CONSTRAINT_FOREIGNKEY)</span>
    <span class="n">error</span><span class="o">.</span><span class="n">extendedResultCode</span>

    <span class="c1">// The eventual SQLite message: FOREIGN KEY constraint failed</span>
    <span class="n">error</span><span class="o">.</span><span class="n">message</span>

    <span class="c1">// The eventual erroneous SQL query</span>
    <span class="c1">// "INSERT INTO pets (masterId, name) VALUES (?, ?)"</span>
    <span class="n">error</span><span class="o">.</span><span class="n">sql</span>

    <span class="c1">// Full error description:</span>
    <span class="c1">// "SQLite error 787 with statement `INSERT INTO pets (masterId, name)</span>
    <span class="c1">//  VALUES (?, ?)` arguments [1, "Bobby"]: FOREIGN KEY constraint failed""</span>
    <span class="n">error</span><span class="o">.</span><span class="n">description</span>
<span class="p">}</span>
</code></pre>

<p><strong>SQLite uses codes to distinguish between various errors:</strong></p>
<pre class="highlight swift"><code><span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="o">...</span>
<span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="k">as</span> <span class="kt">DatabaseError</span> <span class="k">where</span> <span class="n">error</span><span class="o">.</span><span class="n">extendedResultCode</span> <span class="o">==</span> <span class="o">.</span><span class="kt">SQLITE_CONSTRAINT_FOREIGNKEY</span> <span class="p">{</span>
    <span class="c1">// foreign key constraint error</span>
<span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="k">as</span> <span class="kt">DatabaseError</span> <span class="k">where</span> <span class="n">error</span><span class="o">.</span><span class="n">resultCode</span> <span class="o">==</span> <span class="o">.</span><span class="kt">SQLITE_CONSTRAINT</span> <span class="p">{</span>
    <span class="c1">// any other constraint error</span>
<span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="k">as</span> <span class="kt">DatabaseError</span> <span class="p">{</span>
    <span class="c1">// any other database error</span>
<span class="p">}</span>
</code></pre>

<p>In the example above, <code>error.extendedResultCode</code> is a precise <a href="https://www.sqlite.org/rescode.html#extended_result_code_list">extended result code</a>, and <code>error.resultCode</code> is a less precise <a href="https://www.sqlite.org/rescode.html#primary_result_code_list">primary result code</a>. Extended result codes are refinements of primary result codes, as <code>SQLITE_CONSTRAINT_FOREIGNKEY</code> is to <code>SQLITE_CONSTRAINT</code>, for example. See <a href="https://www.sqlite.org/rescode.html">SQLite result codes</a> for more information.</p>

<p>As a convenience, extended result codes match their primary result code in a switch statement:</p>
<pre class="highlight swift"><code><span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="o">...</span>
<span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="k">as</span> <span class="kt">DatabaseError</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">error</span><span class="o">.</span><span class="n">extendedResultCode</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kt">ResultCode</span><span class="o">.</span><span class="kt">SQLITE_CONSTRAINT_FOREIGNKEY</span><span class="p">:</span>
        <span class="c1">// foreign key constraint error</span>
    <span class="k">case</span> <span class="kt">ResultCode</span><span class="o">.</span><span class="kt">SQLITE_CONSTRAINT</span><span class="p">:</span>
        <span class="c1">// any other constraint error</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="c1">// any other database error</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:warning: <strong>Warning</strong>: SQLite has progressively introduced extended result codes accross its versions. For example, <code>SQLITE_CONSTRAINT_FOREIGNKEY</code> wasn&rsquo;t introduced yet on iOS 8.1. The <a href="http://www.sqlite.org/changes.html">SQLite release notes</a> are unfortunately not quite clear about that: write your handling of extended result codes with care.</p>
</blockquote>
<h3 id='persistenceerror' class='heading'>PersistenceError</h3>

<p><strong>PersistenceError</strong> is thrown by the <a href="#persistable-protocol">Persistable</a> protocol, in a single case: when the <code>update</code> method could not find any row to update:</p>
<pre class="highlight swift"><code><span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="kt">PersistenceError</span><span class="o">.</span><span class="n">recordNotFound</span> <span class="p">{</span>
    <span class="c1">// There was nothing to update</span>
<span class="p">}</span>
</code></pre>
<h3 id='fatal-errors' class='heading'>Fatal Errors</h3>

<p><strong>Fatal errors notify that the program, or the database, has to be changed.</strong></p>

<p>They uncover programmer errors, false assumptions, and prevent misuses. Here are a few examples:</p>

<ul>
<li><p><strong>The code asks for a non-optional value, when the database contains NULL:</strong></p>
<pre class="highlight swift"><code><span class="c1">// fatal error: could not convert NULL to String.</span>
<span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>
</code></pre>

<p>Solution: fix the contents of the database, use <a href="#create-tables">NOT NULL constraints</a>, or load an optional:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>
</code></pre></li>
<li><p><strong>The code asks for a Date, when the database contains garbage:</strong></p>
<pre class="highlight swift"><code><span class="c1">// fatal error: could not convert "Mom’s birthday" to Date.</span>
<span class="k">let</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">?</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"date"</span><span class="p">)</span>
</code></pre>

<p>Solution: fix the contents of the database, or use <a href="#databasevalue">DatabaseValue</a> to handle all possible cases:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"date"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">dbv</span><span class="o">.</span><span class="n">isNull</span> <span class="p">{</span>
    <span class="c1">// Handle NULL</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">date</span> <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle valid date</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Handle invalid date</span>
<span class="p">}</span>
</code></pre></li>
<li><p><strong>The database can&rsquo;t guarantee that the code does what it says:</strong></p>
<pre class="highlight swift"><code><span class="c1">// fatal error: table persons has no unique index on column email</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nv">key</span><span class="p">:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">:</span> <span class="s">"arthur@example.com"</span><span class="p">])</span>
</code></pre>

<p>Solution: add a unique index to the persons.email column, or use the <code>deleteAll</code> method to make it clear that you may delete more than one row:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="kt">Column</span><span class="p">(</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"arthur@example.com"</span><span class="p">)</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></li>
<li><p><strong>Database connections are not reentrant:</strong></p>
<pre class="highlight swift"><code><span class="c1">// fatal error: Database methods are not reentrant.</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Solution: avoid reentrancy, and instead pass a database connection along.</p></li>
</ul>
<h3 id='how-to-deal-with-untrusted-inputs' class='heading'>How to Deal with Untrusted Inputs</h3>

<p>Let&rsquo;s consider the code below:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">sql</span> <span class="o">=</span> <span class="s">"SELECT ..."</span>

<span class="c1">// Some untrusted arguments for the query</span>
<span class="k">let</span> <span class="nv">arguments</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nv">arguments</span><span class="p">:</span> <span class="kt">StatementArguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>

<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Some untrusted database value:</span>
    <span class="k">let</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">?</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>It has two opportunities to throw fatal errors:</p>

<ul>
<li><strong>Untrusted arguments</strong>: The dictionary may contain values that do not conform to the <a href="#values">DatabaseValueConvertible protocol</a>, or may miss keys required by the statement.</li>
<li><strong>Untrusted database content</strong>: The row may contain a non-null value that can&rsquo;t be turned into a date.</li>
</ul>

<p>In such a situation, you can still avoid fatal errors by exposing and handling each failure point, one level down in the GRDB API:</p>
<pre class="highlight swift"><code><span class="c1">// Untrusted arguments</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">arguments</span> <span class="o">=</span> <span class="kt">StatementArguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">statement</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">makeSelectStatement</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">statement</span><span class="o">.</span><span class="nf">validate</span><span class="p">(</span><span class="nv">arguments</span><span class="p">:</span> <span class="n">arguments</span><span class="p">)</span>
    <span class="n">statement</span><span class="o">.</span><span class="nf">unsafeSetArguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>

    <span class="k">var</span> <span class="nv">cursor</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
    <span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">iterator</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Untrusted database content</span>
        <span class="k">let</span> <span class="nv">dbv</span><span class="p">:</span> <span class="kt">DatabaseValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dbv</span><span class="o">.</span><span class="n">isNull</span> <span class="p">{</span>
            <span class="c1">// Handle NULL</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">date</span> <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nf">fromDatabaseValue</span><span class="p">(</span><span class="n">dbv</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Handle valid date</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Handle invalid date</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>See <a href="#prepared-statements">prepared statements</a> and <a href="#databasevalue">DatabaseValue</a> for more information.</p>
<h3 id='error-log' class='heading'>Error Log</h3>

<p><strong>SQLite can be configured to invoke a callback function containing an error code and a terse error message whenever anomalies occur.</strong></p>

<p>It is recommended that you setup, early in the lifetime of your application, the error logging callback:</p>
<pre class="highlight swift"><code><span class="kt">Database</span><span class="o">.</span><span class="n">logError</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">resultCode</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="k">in</span>
    <span class="kt">NSLog</span><span class="p">(</span><span class="s">"%@"</span><span class="p">,</span> <span class="s">"SQLite error </span><span class="se">\(</span><span class="n">resultCode</span><span class="se">)</span><span class="s">: </span><span class="se">\(</span><span class="n">message</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>See <a href="https://sqlite.org/errlog.html">The Error And Warning Log</a> for more information.</p>
<h2 id='unicode' class='heading'>Unicode</h2>

<p>SQLite lets you store unicode strings in the database.</p>

<p>However, SQLite does not provide any unicode-aware string transformations or comparisons.</p>
<h3 id='unicode-functions' class='heading'>Unicode functions</h3>

<p>The <code>UPPER</code> and <code>LOWER</code> built-in SQLite functions are not unicode-aware:</p>
<pre class="highlight swift"><code><span class="c1">// "JéRôME"</span>
<span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT UPPER('Jérôme')"</span><span class="p">)</span>
</code></pre>

<p>GRDB extends SQLite with <a href="#custom-sql-functions">SQL functions</a> that call the Swift built-in string functions <code>capitalized</code>, <code>lowercased</code>, <code>uppercased</code>, <code>localizedCapitalized</code>, <code>localizedLowercased</code> and <code>localizedUppercased</code>:</p>
<pre class="highlight swift"><code><span class="c1">// "JÉRÔME"</span>
<span class="k">let</span> <span class="nv">uppercase</span> <span class="o">=</span> <span class="kt">DatabaseFunction</span><span class="o">.</span><span class="n">uppercase</span>
<span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"SELECT </span><span class="se">\(</span><span class="n">uppercased</span><span class="o">.</span><span class="n">name</span><span class="se">)</span><span class="s">('Jérôme')"</span><span class="p">)</span>
</code></pre>

<p>Those unicode-aware string functions are also readily available in the <a href="#sql-functions">query interface</a>:</p>
<pre class="highlight plaintext"><code>Person.select(nameColumn.uppercased)
</code></pre>
<h3 id='string-comparison' class='heading'>String Comparison</h3>

<p>SQLite compares strings in many occasions: when you sort rows according to a string column, or when you use a comparison operator such as <code>=</code> and <code>&lt;=</code>.</p>

<p>The comparison result comes from a <em>collating function</em>, or <em>collation</em>. SQLite comes with three built-in collations that do not support Unicode: <a href="https://www.sqlite.org/datatype3.html#collation">binary, nocase, and rtrim</a>.</p>

<p>GRDB comes with five extra collations that leverage unicode-aware comparisons based on the standard Swift String comparison functions and operators:</p>

<ul>
<li><code>unicodeCompare</code> (uses the built-in <code>&lt;=</code> and <code>==</code> Swift operators)</li>
<li><code>caseInsensitiveCompare</code></li>
<li><code>localizedCaseInsensitiveCompare</code></li>
<li><code>localizedCompare</code></li>
<li><code>localizedStandardCompare</code></li>
</ul>

<p>A collation can be applied to a table column. All comparisons involving this column will then automatically trigger the comparison function:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">table</span><span class="p">:</span> <span class="s">"persons"</span><span class="p">)</span> <span class="p">{</span> <span class="n">t</span> <span class="k">in</span>
    <span class="c1">// Guarantees case-insensitive email unicity</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"email"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">unique</span><span class="p">()</span><span class="o">.</span><span class="nf">collate</span><span class="p">(</span><span class="o">.</span><span class="n">nocase</span><span class="p">)</span>

    <span class="c1">// Sort names in a localized case insensitive way</span>
    <span class="n">t</span><span class="o">.</span><span class="nf">column</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">collate</span><span class="p">(</span><span class="o">.</span><span class="n">localizedCaseInsensitiveCompare</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Persons are sorted in a localized case insensitive way:</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>:warning: <strong>Warning</strong>: SQLite <em>requires</em> host applications to provide the definition of any collation other than binary, nocase and rtrim. When a database file has to be shared or migrated to another SQLite library of platform (such as the Android version of your application), make sure you provide a compatible collation.</p>
</blockquote>

<p>If you can&rsquo;t or don&rsquo;t want to define the comparison behavior of a column (see warning above), you can still use an explicit collation in SQL requests and in the <a href="#the-query-interface">query interface</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">collation</span> <span class="o">=</span> <span class="kt">DatabaseCollation</span><span class="o">.</span><span class="n">localizedCaseInsensitiveCompare</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
    <span class="s">"SELECT * FROM persons ORDER BY name COLLATE </span><span class="se">\(</span><span class="n">collation</span><span class="o">.</span><span class="n">name</span><span class="se">)</span><span class="s">)"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">nameColumn</span><span class="o">.</span><span class="nf">collating</span><span class="p">(</span><span class="n">collation</span><span class="p">))</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p><strong>You can also define your own collations</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">collation</span> <span class="o">=</span> <span class="kt">DatabaseCollation</span><span class="p">(</span><span class="s">"customCollation"</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSComparisonResult</span> <span class="k">in</span>
    <span class="c1">// return the comparison of lhs and rhs strings.</span>
<span class="p">}</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">collation</span><span class="p">:</span> <span class="n">collation</span><span class="p">)</span> <span class="c1">// Or dbPool.add(collation: ...)</span>
</code></pre>
<h2 id='memory-management' class='heading'>Memory Management</h2>

<p>Both SQLite and GRDB use non-essential memory that help them perform better.</p>

<p>You can reclaim this memory with the <code>releaseMemory</code> method:</p>
<pre class="highlight swift"><code><span class="c1">// Release as much memory as possible.</span>
<span class="n">dbQueue</span><span class="o">.</span><span class="nf">releaseMemory</span><span class="p">()</span>
<span class="n">dbPool</span><span class="o">.</span><span class="nf">releaseMemory</span><span class="p">()</span>
</code></pre>

<p>This method blocks the current thread until all current database accesses are completed, and the memory collected.</p>
<h3 id='memory-management-on-ios' class='heading'>Memory Management on iOS</h3>

<p><strong>The iOS operating system likes applications that do not consume much memory.</strong></p>

<p><a href="#database-queues">Database queues</a> and <a href="#database-pools">pools</a> can call the <code>releaseMemory</code> method for you, when application receives memory warnings, and when application enters background: call the <code>setupMemoryManagement</code> method after creating the queue or pool instance:</p>
<pre class="highlight plaintext"><code>let dbQueue = try DatabaseQueue(...)
dbQueue.setupMemoryManagement(in: UIApplication.sharedApplication())
</code></pre>
<h2 id='data-protection' class='heading'>Data Protection</h2>

<p><a href="https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/StrategiesforImplementingYourApp/StrategiesforImplementingYourApp.html#//apple_ref/doc/uid/TP40007072-CH5-SW21">Data Protection</a> lets you protect files so that they are encrypted and unavailable until the device is unlocked.</p>

<p>Data protection can be enabled <a href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/AddingCapabilities/AddingCapabilities.html#//apple_ref/doc/uid/TP40012582-CH26-SW30">globally</a> for all files created by an application.</p>

<p>You can also explicitly protect a database, by configuring its enclosing <em>directory</em>. This will not only protect the database file, but also all <a href="https://www.sqlite.org/tempfiles.html">temporary files</a> created by SQLite (including the persistent <code>.shm</code> and <code>.wal</code> files created by <a href="#database-pools">database pools</a>).</p>

<p>For example, to explicitely use <a href="https://developer.apple.com/reference/foundation/fileprotectiontype/1616200-complete">complete</a> protection:</p>
<pre class="highlight swift"><code><span class="c1">// Paths</span>
<span class="k">let</span> <span class="nv">documentsPath</span> <span class="o">=</span> <span class="kt">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="o">.</span><span class="n">documentDirectory</span><span class="p">,</span> <span class="o">.</span><span class="n">userDomainMask</span><span class="p">,</span> <span class="kc">true</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">directoryPath</span> <span class="o">=</span> <span class="p">(</span><span class="n">documentsPath</span> <span class="k">as</span> <span class="kt">NSString</span><span class="p">)</span><span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="s">"database"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">databasePath</span> <span class="o">=</span> <span class="p">(</span><span class="n">directoryPath</span> <span class="k">as</span> <span class="kt">NSString</span><span class="p">)</span><span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="s">"db.sqlite"</span><span class="p">)</span>

<span class="c1">// Create directory if needed</span>
<span class="k">let</span> <span class="nv">fm</span> <span class="o">=</span> <span class="kt">FileManager</span><span class="o">.</span><span class="k">default</span>
<span class="k">var</span> <span class="nv">isDirectory</span><span class="p">:</span> <span class="kt">ObjCBool</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">if</span> <span class="o">!</span><span class="n">fm</span><span class="o">.</span><span class="nf">fileExists</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">directoryPath</span><span class="p">,</span> <span class="nv">isDirectory</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">isDirectory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">fm</span><span class="o">.</span><span class="nf">createDirectory</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">directoryPath</span><span class="p">,</span> <span class="nv">withIntermediateDirectories</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">isDirectory</span><span class="o">.</span><span class="n">boolValue</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="kt">NSError</span><span class="p">(</span><span class="nv">domain</span><span class="p">:</span> <span class="kt">NSCocoaErrorDomain</span><span class="p">,</span> <span class="nv">code</span><span class="p">:</span> <span class="kt">NSFileWriteFileExistsError</span><span class="p">,</span> <span class="nv">userInfo</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Enable data protection</span>
<span class="k">try</span> <span class="n">fm</span><span class="o">.</span><span class="nf">setAttributes</span><span class="p">([</span><span class="o">.</span><span class="nv">protectionKey</span> <span class="p">:</span> <span class="kt">FileProtectionType</span><span class="o">.</span><span class="n">complete</span><span class="p">],</span> <span class="nv">ofItemAtPath</span><span class="p">:</span> <span class="n">directoryPath</span><span class="p">)</span>

<span class="c1">// Open database</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">databasePath</span><span class="p">)</span>
</code></pre>

<p>When a database is protected, an application that runs in the background on a locked device won&rsquo;t be able to read or write from it. Instead, it will get <a href="#error-handling">DatabaseError</a> with code <a href="https://www.sqlite.org/rescode.html#ioerr"><code>SQLITE_IOERR</code></a> (10) <q>disk I/O error</q>, or <a href="https://www.sqlite.org/rescode.html#auth"><code>SQLITE_AUTH</code></a> (23) <q>not authorized</q>.</p>

<p>You can catch those errors and wait for <a href="https://developer.apple.com/reference/uikit/uiapplicationdelegate/1623044-applicationprotecteddatadidbecom">UIApplicationDelegate.applicationProtectedDataDidBecomeAvailable(_:)</a> or <a href="https://developer.apple.com/reference/uikit/uiapplicationprotecteddatadidbecomeavailable">UIApplicationProtectedDataDidBecomeAvailable</a> notification in order to retry the failed database operation.</p>
<h2 id='concurrency' class='heading'>Concurrency</h2>

<ul>
<li><a href="#guarantees-and-rules">Guarantees and Rules</a></li>
<li><a href="#advanced-databasepool">Advanced DatabasePool</a></li>
<li><a href="#databasewriter-and-databasereader-protocols">DatabaseWriter and DatabaseReader Protocols</a></li>
<li><a href="#dealing-with-external-connections">Dealing with External Connections</a></li>
</ul>
<h3 id='guarantees-and-rules' class='heading'>Guarantees and Rules</h3>

<p>GRDB ships with two concurrency modes:</p>

<ul>
<li><a href="#database-queues">DatabaseQueue</a> opens a single database connection, and serializes all database accesses.</li>
<li><a href="#database-pools">DatabasePool</a> manages a pool of several database connections, and allows concurrent reads and writes.</li>
</ul>

<p><strong>Both foster application safety</strong>: regardless of the concurrency mode you choose, GRDB provides you with the same guarantees, as long as you follow three rules.</p>

<ul>
<li><p>:bowtie: <strong>Guarantee 1: writes are always serialized</strong>. At every moment, there is no more than a single thread that is writing into the database.</p></li>
<li><p>:bowtie: <strong>Guarantee 2: reads are always isolated</strong>. This means that they are guaranteed an immutable view of the last committed state of the database, and that you can perform subsequent fetches without fearing eventual concurrent writes to mess with your application logic:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="c1">// or dbQueue.inDatabase { ... }</span>
    <span class="c1">// Guaranteed to be equal</span>
    <span class="k">let</span> <span class="nv">count1</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">count2</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></li>
<li><p>:bowtie: <strong>Guarantee 3: requests don&rsquo;t fail</strong>, unless a database constraint violation, a <a href="#error-handling">programmer mistake</a>, or a very low-level issue such as a disk error or an unreadable database file. GRDB grants <em>correct</em> use of SQLite, and particularly avoids locking errors and other SQLite misuses.</p></li>
</ul>

<p>Those guarantees hold as long as you follow three rules:</p>

<ul>
<li><p>:point_up: <strong>Rule 1</strong>: Have a unique instance of DatabaseQueue or DatabasePool connected to any database file.</p>

<p>This means that opening a new connection each time you access the database is probably a very bad idea. Do share a single connection instead.</p>

<p>See, for example, <a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS/Database.swift">DemoApps/GRDBDemoiOS/Database.swift</a> for a sample code that properly sets up a single database queue that is available throughout the application.</p>

<p>If there are several instances of database queues or pools that access the same database, a multi-threaded application will eventually face <q>database is locked</q> errors. See <a href="#dealing-with-external-connections">Dealing with External Connections</a>.</p>
<pre class="highlight swift"><code><span class="c1">// SAFE CONCURRENCY</span>
<span class="kd">func</span> <span class="nf">currentUser</span><span class="p">(</span><span class="n">_</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">User</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">try</span> <span class="kt">User</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// dbQueue is a singleton defined somewhere in your app</span>
<span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="c1">// or dbPool.read { ... }</span>
    <span class="k">try</span> <span class="nf">currentUser</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// UNSAFE CONCURRENCY</span>
<span class="c1">// This method fails when some other thread is currently writing into</span>
<span class="c1">// the database.</span>
<span class="kd">func</span> <span class="nf">currentUser</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">User</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
        <span class="k">try</span> <span class="kt">User</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">currentUser</span><span class="p">()</span>
</code></pre></li>
<li><p>:point_up: <strong>Rule 2</strong>: Group related statements within a single call to a DatabaseQueue or DatabasePool database access method.</p>

<p>Those methods isolate your groups of related statements against eventual database updates performed by other threads, and guarantee a consistent view of the database. This isolation is only guaranteed <em>inside</em> the closure argument of those methods. Two consecutive calls <em>do not</em> guarantee isolation:</p>
<pre class="highlight swift"><code><span class="c1">// SAFE CONCURRENCY</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>  <span class="c1">// or dbQueue.inDatabase { ... }</span>
    <span class="c1">// Guaranteed to be equal:</span>
    <span class="k">let</span> <span class="nv">count1</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">count2</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// UNSAFE CONCURRENCY</span>
<span class="c1">// Those two values may be different because some other thread may have</span>
<span class="c1">// modified the database between the two blocks:</span>
<span class="k">let</span> <span class="nv">count1</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">}</span>
<span class="k">let</span> <span class="nv">count2</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">}</span>
</code></pre>

<p>In the same vein, when you fetch values that depends on some database updates, group them:</p>
<pre class="highlight swift"><code><span class="c1">// SAFE CONCURRENCY</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// The count is guaranteed to be non-zero</span>
    <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// UNSAFE CONCURRENCY</span>
<span class="c1">// The count may be zero because some other thread may have performed</span>
<span class="c1">// a deletion between the two blocks:</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">}</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span> <span class="k">try</span> <span class="kt">PointOfInterest</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">}</span>
</code></pre>

<p>On that last example, see <a href="#advanced-databasepool">Advanced DatabasePool</a> if you look after extra performance.</p></li>
<li><p>:point_up: <strong>Rule 3</strong>: When you perform several modifications of the database that temporarily put the database in an inconsistent state, group those modifications within a <a href="#transactions-and-savepoints">transaction</a>:</p>
<pre class="highlight swift"><code><span class="c1">// SAFE CONCURRENCY</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">writeInTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>  <span class="c1">// or dbQueue.inTransaction { ... }</span>
    <span class="k">try</span> <span class="kt">Credit</span><span class="p">(</span><span class="n">destinationAccout</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">try</span> <span class="kt">Debit</span><span class="p">(</span><span class="n">sourceAccount</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">commit</span>
<span class="p">}</span>

<span class="c1">// UNSAFE CONCURRENCY</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>  <span class="c1">// or dbQueue.inDatabase { ... }</span>
    <span class="k">try</span> <span class="kt">Credit</span><span class="p">(</span><span class="n">destinationAccout</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">try</span> <span class="kt">Debit</span><span class="p">(</span><span class="n">sourceAccount</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Without transaction, <code>DatabasePool.read { ... }</code> may see the first statement, but not the second, and access a database where the balance of accounts is not zero. A highly bug-prone situation.</p>

<p>So do use <a href="#transactions-and-savepoints">transactions</a> in order to guarantee database consistency accross your application threads: that&rsquo;s what they are made for.</p></li>
</ul>
<h3 id='advanced-databasepool' class='heading'>Advanced DatabasePool</h3>

<p><a href="#database-pools">Database pools</a> are very concurrent, since all reads can run in parallel, and can even run during write operations. But writes are still serialized: at any given point in time, there is no more than a single thread that is writing into the database.</p>

<p>When your application modifies the database, and then reads some value that depends on those modifications, you may want to avoid locking the writer queue longer than necessary:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Increment the number of persons</span>
    <span class="k">try</span> <span class="kt">Person</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1">// Read the number of persons. The writer queue is still locked :-(</span>
    <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>A wrong solution is to chain a write then a read, as below. Don&rsquo;t do that, because another thread may modify the database in between, and make the read unreliable:</p>
<pre class="highlight swift"><code><span class="c1">// WRONG</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Increment the number of persons</span>
    <span class="k">try</span> <span class="kt">Person</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">read</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Read some random value :-(</span>
    <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The correct solution is the <code>readFromCurrentState</code> method, which must be called from within a write block:</p>
<pre class="highlight swift"><code><span class="c1">// CORRECT</span>
<span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Increment the number of persons</span>
    <span class="k">try</span> <span class="kt">Person</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">readFromCurrentState</span> <span class="p">{</span> <span class="n">db</span>
        <span class="c1">// Read the number of persons. The writer queue has been unlocked :-)</span>
        <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p><code>readFromCurrentState</code> blocks until it can guarantee its closure argument an isolated access to the last committed state of the database. It then asynchronously executes the closure. If the isolated access can&rsquo;t be established, <code>readFromCurrentState</code> throws an error, and the closure is not executed.</p>

<p>The closure can run concurrently with eventual updates performed after <code>readFromCurrentState</code>: those updates won&rsquo;t be visible from within the closure. In the example below, the number of persons is guaranteed to be non-zero, even though it is fetched concurrently with the person deletion:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">write</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="c1">// Increment the number of persons</span>
    <span class="k">try</span> <span class="kt">Person</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">try</span> <span class="n">dbPool</span><span class="o">.</span><span class="n">readFromCurrentState</span> <span class="p">{</span> <span class="n">db</span>
        <span class="c1">// Guaranteed to be non-zero</span>
        <span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">deleteAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><a href="#database-changes-observation">Transaction Observers</a> can also use <code>readFromCurrentState</code> in their <code>databaseDidCommit</code> method in order to process database changes without blocking other threads that want to write into the database.</p>
<h3 id='databasewriter-and-databasereader-protocols' class='heading'>DatabaseWriter and DatabaseReader Protocols</h3>

<p>Both DatabaseQueue and DatabasePool adopt the <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Protocols/DatabaseReader.html">DatabaseReader</a> and <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Protocols/DatabaseWriter.html">DatabaseWriter</a> protocols.</p>

<p>These protocols provide a unified API that lets you write safe concurrent code that targets both classes.</p>

<p>However, database queues are not database pools, and DatabaseReader and DatabaseWriter provide the <em>smallest</em> common guarantees. They require more discipline:</p>

<ul>
<li>Pools are less forgiving than queues when one overlooks a transaction (see <a href="#guarantees-and-rules">concurrency rule 3</a>).</li>
<li>DatabaseWriter.readFromCurrentState is synchronous, or asynchronous, depending on whether it is run by a queue or a pool (see <a href="#advanced-databasepool">advanced DatabasePool</a>). It thus requires higher libDispatch skills, and more complex synchronization code.</li>
<li>The definition of <q>current state</q> in DatabaseWriter.readFromCurrentState is <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Protocols/DatabaseWriter.html#/s:FP4GRDB14DatabaseWriter20readFromCurrentStateFzFCS_8DatabaseT_T_">delicate</a>.</li>
</ul>

<p>DatabaseReader and DatabaseWriter are not a tool for applications that hesitate between DatabaseQueue and DatabasePool, and look for a common API. As seen above, the protocols actually make applications harder to write correctly. Instead, they target reusable agnostic code that has <em>both</em> queues and pools in mind. For example, GRDB uses those protocols for <a href="#migrations">migrations</a> and <a href="#fetchedrecordscontroller">FetchedRecordsController</a>, two tools that accept both queues and pools.</p>
<h3 id='dealing-with-external-connections' class='heading'>Dealing with External Connections</h3>

<p>The first rule of GRDB is:</p>

<ul>
<li><strong><a href="#guarantees-and-rules">Rule 1</a></strong>: Have a unique instance of DatabaseQueue or DatabasePool connected to any database file.</li>
</ul>

<p>This means that dealing with external connections is not a focus of GRDB. <a href="#guarantees-and-rules">Guarantees</a> of GRDB may or may not hold as soon as some external connection modifies a database.</p>

<p>If you absolutely need multiple connections, then:</p>

<ul>
<li>Reconsider your position</li>
<li>Read about <a href="https://www.sqlite.org/isolation.html">isolation in SQLite</a></li>
<li>Learn about <a href="https://www.sqlite.org/lang_transaction.html">locks and transactions</a></li>
<li>Become a master of the <a href="https://www.sqlite.org/wal.html">WAL mode</a></li>
<li>Prepare to setup a <a href="https://www.sqlite.org/c3ref/busy_handler.html">busy handler</a> with <a href="http://groue.github.io/GRDB.swift/docs/0.107.0/Structs/Configuration.html">Configuration.busyMode</a></li>
<li><a href="https://github.com/groue/GRDB.swift/issues">Ask questions</a></li>
</ul>
<h2 id='performance' class='heading'>Performance</h2>

<p>GRDB is a reasonably fast library, and can deliver quite efficient SQLite access. See <a href="https://github.com/groue/GRDB.swift/wiki/Performance">Comparing the Performances of Swift SQLite libraries</a> for an overview.</p>

<p>You&rsquo;ll find below general advice when you do look after performance:</p>

<ul>
<li>Focus</li>
<li>Know your platform</li>
<li>Use transactions</li>
<li>Don&rsquo;t do useless work</li>
<li>Learn about SQL strengths and weaknesses</li>
<li>Avoid strings &amp; dictionaries</li>
</ul>
<h3 id='performance-tip-focus' class='heading'>Performance tip: focus</h3>

<p>You don&rsquo;t know which part of your program needs improvement until you have run a benchmarking tool.</p>

<p>Don&rsquo;t make any assumption, avoid optimizing code too early, and use <a href="https://developer.apple.com/library/ios/documentation/ToolsLanguages/Conceptual/Xcode_Overview/MeasuringPerformance.html">Instruments</a>.</p>
<h3 id='performance-tip-know-your-platform' class='heading'>Performance tip: know your platform</h3>

<p>If your application processes a huge JSON file and inserts thousands of rows in the database right from the main thread, it will quite likely become unresponsive, and provide a sub-quality user experience.</p>

<p>If not done yet, read the <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008091">Concurrency Programming Guide</a> and learn how to perform heavy computations without blocking your application.</p>

<p>Most GRBD APIs are <a href="#database-connections">synchronous</a>. Spawning them into parallel queues is as easy as:</p>
<pre class="highlight swift"><code><span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> 
    <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
        <span class="c1">// Perform database work</span>
    <span class="p">}</span>
    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> 
        <span class="c1">// update your user interface</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='performance-tip-use-transactions' class='heading'>Performance tip: use transactions</h3>

<p>Performing multiple updates to the database is much faster when executed inside a <a href="#transactions-and-savepoints">transaction</a>. This is because a transaction allows SQLite to postpone writing changes to disk until the final commit:</p>
<pre class="highlight swift"><code><span class="c1">// Inefficient</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">for</span> <span class="n">person</span> <span class="k">in</span> <span class="n">persons</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Efficient</span>
<span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inTransaction</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">for</span> <span class="n">person</span> <span class="k">in</span> <span class="n">persons</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">.</span><span class="kt">Commit</span>
<span class="p">}</span>
</code></pre>
<h3 id='performance-tip-don-39-t-do-useless-work' class='heading'>Performance tip: don&rsquo;t do useless work</h3>

<p>Obviously, no code is faster than any code.</p>

<p><strong>Don&rsquo;t fetch columns you don&rsquo;t use</strong></p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM persons</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1">// SELECT id, name FROM persons</span>
<span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">idColumn</span><span class="p">,</span> <span class="n">nameColumn</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p>If your Person type can&rsquo;t be built without other columns (it has non-optional properties for other columns), <em>do define and use a different type</em>.</p>

<p><strong>Don&rsquo;t fetch rows you don&rsquo;t use</strong></p>

<p>Use <a href="#fetching-methods">fetchOne</a> when you need a single value, and otherwise limit your queries at the database level:</p>
<pre class="highlight swift"><code><span class="c1">// Wrong way: this code may discard hundreds of useless database rows</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">scoreColumn</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">hallOfFame</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1">// Better way</span>
<span class="k">let</span> <span class="nv">hallOfFame</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">order</span><span class="p">(</span><span class="n">scoreColumn</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span><span class="o">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre>

<p><strong>Don&rsquo;t copy values unless necessary</strong></p>

<p>Particularly: the Array returned by the <code>fetchAll</code> method, and the cursor returned by <code>fetchCursor</code> aren&rsquo;t the same:</p>

<p><code>fetchAll</code> copies all values from the database into memory, when <code>fetchCursor</code> iterates database results as they are generated by SQLite, taking profit from SQLite efficiency.</p>

<p>You should only load arrays if you need to keep them for later use (such as iterating their contents in the main thread). Otherwise, use <code>fetchCursor</code>.</p>

<p>See <a href="#fetching-methods">fetching methods</a> for more information about <code>fetchAll</code> and <code>fetchCursor</code>. See also the <a href="#data-and-memory-savings">Row.dataNoCopy</a> method.</p>

<p><strong>Don&rsquo;t update rows unless necessary</strong></p>

<p>An UPDATE statement is costly: SQLite has to look for the updated row, update values, and write changes to disk.</p>

<p>When the overwritten values are the same as the existing ones, it&rsquo;s thus better to avoid performing the UPDATE statement.</p>

<p>The <a href="#record-class">Record</a> class can help you: it provides <a href="#changes-tracking">changes tracking</a>:</p>
<pre class="highlight swift"><code><span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">hasPersistentChangedValues</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h3 id='performance-tip-learn-about-sql-strengths-and-weaknesses' class='heading'>Performance tip: learn about SQL strengths and weaknesses</h3>

<p>Consider a simple use case: your store application has to display a list of authors with the number of available books:</p>

<ul>
<li>J. M. Coetzee (6)</li>
<li>Herman Melville (1)</li>
<li>Alice Munro (3)</li>
<li>Kim Stanley Robinson (7)</li>
<li>Oliver Sacks (4)</li>
</ul>

<p>The following code is inefficient. It is an example of the <a href="http://stackoverflow.com/questions/97197/what-is-the-n1-selects-issue">N+1 problem</a>, because it performs one query to load the authors, and then N queries, as many as there are authors. This turns very inefficient as the number of authors grows:</p>
<pre class="highlight swift"><code><span class="c1">// SELECT * FROM authors</span>
<span class="k">let</span> <span class="nv">authors</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Author</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">for</span> <span class="n">author</span> <span class="k">in</span> <span class="n">authors</span> <span class="p">{</span>
    <span class="c1">// SELECT COUNT(*) FROM books WHERE authorId = ...</span>
    <span class="n">author</span><span class="o">.</span><span class="n">bookCount</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Book</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">authorIdColumn</span> <span class="o">==</span> <span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="nf">fetchCount</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Instead, perform <em>a single query</em>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">sql</span> <span class="o">=</span> <span class="s">"SELECT authors.*, COUNT(books.id) AS bookCount "</span> <span class="o">+</span>
          <span class="s">"FROM authors "</span> <span class="o">+</span>
          <span class="s">"LEFT JOIN books ON books.authorId = authors.id "</span> <span class="o">+</span>
          <span class="s">"GROUP BY authors.id"</span>
<span class="k">let</span> <span class="nv">authors</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Author</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
</code></pre>

<p>In the example above, consider extending your Author with an extra bookCount property, or define and use a different type.</p>

<p>Generally, define indexes on your database tables, and use SQLite&rsquo;s efficient query planning:</p>

<ul>
<li><a href="https://www.sqlite.org/queryplanner.html">Query Planning</a></li>
<li><a href="https://www.sqlite.org/lang_createindex.html">CREATE INDEX</a></li>
<li><a href="https://www.sqlite.org/optoverview.html">The SQLite Query Planner</a></li>
<li><a href="https://www.sqlite.org/eqp.html">EXPLAIN QUERY PLAN</a></li>
</ul>
<h3 id='performance-tip-avoid-strings-amp-dictionaries' class='heading'>Performance tip: avoid strings &amp; dictionaries</h3>

<p>The String and Dictionary Swift types are better avoided when you look for the best performance.</p>

<p>Now GRDB <a href="#records">records</a>, for your convenience, do use strings and dictionaries:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">:</span> <span class="kt">Record</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">email</span><span class="p">:</span> <span class="kt">String</span>

    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">row</span><span class="p">:</span> <span class="kt">Row</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"id"</span><span class="p">)</span>       <span class="c1">// String</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"name"</span><span class="p">)</span>   <span class="c1">// String</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"email"</span><span class="p">)</span> <span class="c1">// String</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">"id"</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s">"email"</span><span class="p">:</span> <span class="n">email</span><span class="p">]</span> <span class="c1">// Dictionary</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>When convenience hurts performance, you can still use records, but you have better avoiding their string and dictionary-based methods.</p>

<p>For example, when fetching values, prefer loading columns by index:</p>
<pre class="highlight swift"><code><span class="c1">// Strings &amp; dictionaries</span>
<span class="k">let</span> <span class="nv">persons</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">fetchAll</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="c1">// Column indexes</span>
<span class="c1">// SELECT id, name, email FROM persons</span>
<span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Person</span><span class="o">.</span><span class="nf">select</span><span class="p">(</span><span class="n">idColumn</span><span class="p">,</span> <span class="n">nameColumn</span><span class="p">,</span> <span class="n">emailColumn</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">rows</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Row</span><span class="o">.</span><span class="nf">fetchCursor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">row</span> <span class="o">=</span> <span class="k">try</span> <span class="n">rows</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">email</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">atIndex</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="nv">email</span><span class="p">:</span> <span class="n">email</span><span class="p">)</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre>

<p>When inserting values, use reusable <a href="#prepared-statements">prepared statements</a>, and set statements values with an <em>array</em>:</p>
<pre class="highlight swift"><code><span class="c1">// Strings &amp; dictionaries</span>
<span class="k">for</span> <span class="n">person</span> <span class="k">in</span> <span class="n">persons</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">person</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Prepared statement</span>
<span class="k">let</span> <span class="nv">insertStatement</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="nf">prepareStatement</span><span class="p">(</span><span class="s">"INSERT INTO persons (name, email) VALUES (?, ?)"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">person</span> <span class="k">in</span> <span class="n">persons</span> <span class="p">{</span>
    <span class="c1">// Only use the unsafe arguments setter if you are sure that you provide</span>
    <span class="c1">// all statement arguments. A mistake can store unexpected values in</span>
    <span class="c1">// the database.</span>
    <span class="n">insertStatement</span><span class="o">.</span><span class="nf">unsafeSetArguments</span><span class="p">([</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="p">])</span>
    <span class="k">try</span> <span class="n">insertStatement</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
<h1 id='faq' class='heading'>FAQ</h1>

<ul>
<li><a href="#how-do-i-close-a-database-connection">How do I close a database connection?</a></li>
<li><a href="#how-do-i-open-a-database-stored-as-a-resource-of-my-application">How do I open a database stored as a resource of my application?</a></li>
<li><a href="#generic-parameter-t-could-not-be-inferred">Generic parameter &lsquo;T&rsquo; could not be inferred</a></li>
<li><a href="#compilation-takes-a-long-time">Compilation takes a long time</a></li>
<li><a href="#sqlite-error-10-disk-io-error-sqlite-error-23-not-authorized">SQLite error 10 <q>disk I/O error</q>, SQLite error 23 <q>not authorized</q></a></li>
</ul>
<h3 id='how-do-i-close-a-database-connection' class='heading'>How do I close a database connection?</h3>

<p>Database connections are managed by <a href="#database-queues">database queues</a> and <a href="#database-pools">pools</a>. A connection is closed when its database queue or pool is deallocated, and all usages of this connection are completed.</p>

<p>Database accesses that run in background threads postpone the closing of connections.</p>
<h3 id='how-do-i-open-a-database-stored-as-a-resource-of-my-application' class='heading'>How do I open a database stored as a resource of my application?</h3>

<p>If your application does not need to modify the database, open a read-only <a href="#database-connections">connection</a> to your resource:</p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">configuration</span> <span class="o">=</span> <span class="kt">Configuration</span><span class="p">()</span>
<span class="n">configuration</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">true</span>
<span class="k">let</span> <span class="nv">dbPath</span> <span class="o">=</span> <span class="kt">Bundle</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">path</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="s">"db"</span><span class="p">,</span> <span class="nv">ofType</span><span class="p">:</span> <span class="s">"sqlite"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">dbPath</span><span class="p">,</span> <span class="nv">configuration</span><span class="p">:</span> <span class="n">configuration</span><span class="p">)</span>
</code></pre>

<p>If the application should modify the database, you need to copy it to a place where it can be modified. For example, in the Documents folder. Only then, open a <a href="#database-connections">connection</a>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">fm</span> <span class="o">=</span> <span class="kt">FileManager</span><span class="o">.</span><span class="k">default</span>
<span class="k">let</span> <span class="nv">documentsPath</span> <span class="o">=</span> <span class="kt">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="o">.</span><span class="n">documentDirectory</span><span class="p">,</span> <span class="o">.</span><span class="n">userDomainMask</span><span class="p">,</span> <span class="kc">true</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">dbPath</span> <span class="o">=</span> <span class="p">(</span><span class="n">documentsPath</span> <span class="k">as</span> <span class="kt">NSString</span><span class="p">)</span><span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="s">"db.sqlite"</span><span class="p">)</span>
<span class="k">if</span> <span class="o">!</span><span class="n">fm</span><span class="o">.</span><span class="nf">fileExists</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">dbPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">dbResourcePath</span> <span class="o">=</span> <span class="kt">Bundle</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">path</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="s">"db"</span><span class="p">,</span> <span class="nv">ofType</span><span class="p">:</span> <span class="s">"sqlite"</span><span class="p">)</span><span class="o">!</span>
    <span class="k">try</span> <span class="n">fm</span><span class="o">.</span><span class="nf">copyItem</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">dbResourcePath</span><span class="p">,</span> <span class="nv">toPath</span><span class="p">:</span> <span class="n">dbPath</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">dbQueue</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">DatabaseQueue</span><span class="p">(</span><span class="nv">path</span><span class="p">:</span> <span class="n">dbPath</span><span class="p">)</span>
</code></pre>
<h3 id='generic-parameter-39-t-39-could-not-be-inferred' class='heading'>Generic parameter &lsquo;T&rsquo; could not be inferred</h3>

<p>You may get this error when using DatabaseQueue.inDatabase, DatabasePool.read, or DatabasePool.write:</p>
<pre class="highlight swift"><code><span class="c1">// Generic parameter 'T' could not be inferred</span>
<span class="k">let</span> <span class="nv">x</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="p">}</span>
</code></pre>

<p>This is a Swift compiler issue (see <a href="https://bugs.swift.org/browse/SR-1570">SR-1570</a>).</p>

<p>The general workaround is to explicitly declare the type of the closure result:</p>
<pre class="highlight swift"><code><span class="c1">// General Workaround</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="k">in</span>
    <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="p">}</span>
</code></pre>

<p>You can also, when possible, write a single-line closure:</p>
<pre class="highlight swift"><code><span class="c1">// Single-line closure workaround:</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="k">try</span> <span class="n">dbQueue</span><span class="o">.</span><span class="n">inDatabase</span> <span class="p">{</span> <span class="n">db</span> <span class="k">in</span>
    <span class="k">try</span> <span class="kt">String</span><span class="o">.</span><span class="nf">fetchOne</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h3 id='compilation-takes-a-long-time' class='heading'>Compilation takes a long time</h3>

<p>When your <a href="#records">record type</a> is very slow to compile, it is usually because its <code>persistentDictionary</code> property builds a long dictionary literal:</p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
    <span class="c1">// Long dictionary literals are slow to compile</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s">"a"</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="s">"b"</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="o">...</span>
<span class="p">}</span>
</code></pre>

<p>That&rsquo;s annoying, but the Swift compiler finds it difficult to compile such a dictionary. We can only hope that compiler improves over time.</p>

<p>To speed up compilation, build your dictionary step by step:</p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">persistentDictionary</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">DatabaseValueConvertible</span><span class="p">?]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="n">dict</span><span class="o">.</span><span class="nf">updateValue</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"a"</span><span class="p">)</span>
    <span class="n">dict</span><span class="o">.</span><span class="nf">updateValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"b"</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">dict</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>:point_up: <strong>Note</strong>: it is important that you use the <code>updateValue</code> method, and not the subscript setter:</p>
<pre class="highlight swift"><code><span class="c1">// GOOD</span>
<span class="n">dict</span><span class="o">.</span><span class="nf">updateValue</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"a"</span><span class="p">)</span>
<span class="c1">// BAD: when the value is nil, this erases the key instead of setting it to nil.</span>
<span class="n">dict</span><span class="p">[</span><span class="s">"a"</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
</code></pre>
</blockquote>
<h3 id='sqlite-error-10-q-disk-i-o-error-q-sqlite-error-23-q-not-authorized-q' class='heading'>SQLite error 10 <q>disk I/O error</q>, SQLite error 23 <q>not authorized</q></h3>

<p>Those errors may be the sign that SQLite can&rsquo;t access the database due to <a href="#data-protection">data protection</a>.</p>

<p>When your application should be able to run in the background on a locked device, it has to catch this error, and, for example, wait for <a href="https://developer.apple.com/reference/uikit/uiapplicationdelegate/1623044-applicationprotecteddatadidbecom">UIApplicationDelegate.applicationProtectedDataDidBecomeAvailable(_:)</a> or <a href="https://developer.apple.com/reference/uikit/uiapplicationprotecteddatadidbecomeavailable">UIApplicationProtectedDataDidBecomeAvailable</a> notification and retry the failed database operation.</p>

<p>This error can also be prevented altogether by using a more relaxed <a href="https://developer.apple.com/reference/foundation/filemanager/1653059-file_protection_values">file protection</a>.</p>
<h1 id='sample-code' class='heading'>Sample Code</h1>

<ul>
<li>The <a href="#documentation">Documentation</a> is full of GRDB snippets.</li>
<li><a href="DemoApps/GRDBDemoiOS/GRDBDemoiOS">GRDBDemoiOS</a>: A sample iOS application.</li>
<li><a href="https://github.com/groue/WWDCCompanion">WWDC Companion</a>: A sample iOS application.</li>
<li>Check <code>GRDB.xcworkspace</code>: it contains GRDB-enabled playgrounds to play with.</li>
<li>How to synchronize a database table with a JSON payload: <a href="Playgrounds/JSONSynchronization.playground/Contents.swift">JSONSynchronization.playground</a></li>
</ul>

<hr>

<p><strong>Thanks</strong></p>

<ul>
<li><a href="http://pierlis.com">Pierlis</a>, where we write great software.</li>
<li><a href="https://github.com/Chiliec">Vladimir Babin</a>, <a href="https://github.com/pakko972">Pascal Edmond</a>, <a href="https://github.com/zmeyc">Andrey Fidrya</a>, <a href="https://github.com/cfilipov">Cristian Filipov</a>, <a href="https://github.com/hartbit">David Hart</a>, <a href="https://github.com/peter-ss">@peter-ss</a>, <a href="https://github.com/pierlo">Pierre-Loïc Raynaud</a>, <a href="https://github.com/schveiguy">Steven Schveighoffer</a>, <a href="https://github.com/swiftlyfalling">@swiftlyfalling</a>, and <a href="https://github.com/kdubb">Kevin Wooten</a> for their contributions, help, and feedback on GRDB.</li>
<li><a href="https://github.com/aymerick">@aymerick</a> and <a href="https://github.com/kali">Mathieu <q>Kali</q> Poumeyrol</a> because SQL.</li>
<li><a href="https://github.com/ccgus/fmdb">ccgus/fmdb</a> for its excellency.</li>
</ul>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2017 <a class="link" href="https://github.com/groue" target="_blank" rel="external">Gwendal Roué</a>. All rights reserved. (Last updated: 2017-05-05)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.8.1</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
